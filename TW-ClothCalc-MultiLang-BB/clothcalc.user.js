// ==UserScript==
// @name The West - TW-DB.info Cloth Calc [Multi-Lang] - BB
// @namespace    https://github.com/BelleBernice/TW-UserScripts
// @version 0.29.0
// @description The West Script: Cloth Calculation for game version 1.34 or higher
// @author [tw-db.info] Team, Belle Bernice
// @homepageURL  https://BelleBernice.github.io/TW-UserScripts
// @supportURL   https://github.com/BelleBernice/TW-UserScripts/issues
// @source       https://github.com/BelleBernice/TW-UserScripts
// @icon         https://raw.githubusercontent.com/BelleBernice/TW-UserScripts/main/TW-ClothCalc-MultiLang-BB/assets/icon.png
// @include http://*.the-west.*/game.php*
// @include https://*.the-west.*/game.php*
// @include http://*.tw.innogames.*/game.php*
// @include https://*.tw.innogames.*/game.php*
// @grant GM_info
// @downloadURL https://update.greasyfork.org/scripts/559600/The%20West%20-%20TW-DBinfo%20Cloth%20Calc%20%5BMulti-Lang%5D%20-%20BB.user.js
// @updateURL https://update.greasyfork.org/scripts/559600/The%20West%20-%20TW-DBinfo%20Cloth%20Calc%20%5BMulti-Lang%5D%20-%20BB.meta.js
// ==/UserScript==

(function(e){const t=document,n=t.createElement("script");n.setAttribute("type","application/javascript"),n.textContent=`(${""+e})()`,(t.body||t.head||t.documentElement).appendChild(n),n.parentNode.removeChild(n)})(function(){if(isDefined(window.TWDB))!window.Language&&TWDB.lang&&(window.Language=TWDB.lang),new west.gui.Dialog(TWDB.script.name,`<div class="txcenter"><b><br>${Language._("script.duplicate_installation")}</br></b></div>`,west.gui.Dialog.SYS_WARNING).addButton(Language._("common.ok")).show();else{function round(e,t=0){const n=10**t;return Math.round((e+Number.EPSILON)*n)/n}function loadLanguage(e,t){const n=(t=t||{}).previousLang,a=t.onComplete||function(){};TWDB.ResourceLoader.load("langs",e,function(o){const r=o?.changelog||[],i=o?.metadata||{};if(delete o.changelog,delete o.metadata,o&&typeof o=="object"){const c=TWDB.lang?._;Object.assign(TWDB.lang,o),c&&(TWDB.lang._=c)}TWDB.script.notes=r,TWDB.script.translationMetadata=i,TWDB.ResourceLoader.load("errors",null,function(c){c&&typeof c=="object"&&c.errors&&Object.assign(TWDB.lang,{errors:c.errors}),window.Language=TWDB.lang,triggerLangLoaded(),a()},function(){window.Language=TWDB.lang,triggerLangLoaded(),a()})},function(){const o=n||TWDB.script.gameLocale;o!==e?(TWDB.script.preferences.lang=o,localStorage.setItem("TWDB_preferences",JSON.stringify(TWDB.script.preferences)),loadLanguage(o,{previousLang:null,showSuccessMessage:!1,onComplete:a})):(triggerLangLoaded(),a())})}TWDB={};const detectedLocale=typeof Game<"u"&&Game.locale?Game.locale:"el_GR";TWDB.script=Object({version:typeof GM_info<"u"?GM_info.script.version:"0.29.0",name:"The West - TW-DB.info Cloth Calc [Multi-Lang] - BB",name_max:"The%20West%20-%20TW-DBinfo%20Cloth%20Calc%20%5BMulti-Lang%5D%20-%20BB",name_min:"clothcalc",folder_url:"BelleBernice.github.io/TW-UserScripts/TW-ClothCalc-MultiLang-BB/",update_suffix:".user.js",update_link:"update.greasyfork.org/scripts/559600/",check:"version.js",url:"TW-DB.info",protocol:location.protocol.match(/^(.+):$/)[1],game_version:"2.256.3",gameLocale:detectedLocale,langs:{[detectedLocale]:detectedLocale+".json"},preferences:{lang:null}}),TWDB.lang={},TWDB.lang._=function(e,t,n){let a=null;typeof t!="object"||t===null||Array.isArray(t)?a=t:n=t;const o=e.split(".");let r=TWDB.lang;for(let c=0;c<o.length;c++){if(!r||typeof r!="object"||!(o[c]in r)){r=null;break}r=r[o[c]]}let i=r||a||e;if(r||a||TWDB.script?.isDev?.(),n!=null)for(const c of Object.keys(n))i=i.replace(RegExp(`\\$${c}\\$`,"g"),n[c]);return i},window.Language=TWDB.lang,TWDB.images={},TWDB.ResourceLoader=(function(){function e(a){return`${t}://raw.githubusercontent.com/${a}`}const t=TWDB.script.protocol==="https"?"https":"http",n={langs:{path:"languages",files:TWDB.script.langs,defaultValue:{},parser:"json"},errors:{path:"languages/errors",filename:"log.json",defaultValue:{},parser:"json"},images:{path:"assets",filename:"images.json",defaultValue:{},parser:"json"}};return{load:function(a,o,r,i){const c=n[a];if(!c)return i&&i(),void 0;let b,u;if(c.files&&o)b=o+".json",u=c.defaultValue;else{if(!c.filename)return i&&i(),void 0;b=c.filename,u=c.defaultValue}const g=[e(`BelleBernice/TW-UserScripts/main/TW-ClothCalc-MultiLang-BB/${c.path}/${b}`),e(`${TWDB.script.folder_url}${c.path}/${b}`)];let l=0;(function f(){if(l>=g.length){if(a==="languages"&&o)if(typeof UserMessage<"u")new UserMessage(Language._("errors.language_file_not_found",{filename:b,locale:o}),UserMessage.TYPE_ERROR).show();else{const d=Language._("errors.language_file_not_found_console",{filename:b,locale:o}),_=Error(d);ErrorModule.report(_,Language._("errors.language_file_loading"))}return i?i():u!==void 0&&r&&r(u),void 0}if(c.parser==="json")$.getJSON(g[l],function(d){r&&r(d)}).fail(function(){l++,f()});else if(c.parser==="image"){const d=new Image;d.onload=function(){r&&r(d)},d.onerror=function(){l++,f()},d.src=g[l]}else $.getJSON(g[l],function(d){r&&r(d)}).fail(function(){l++,f()})})()},config:n}})(),TWDB.script.notes=[],TheWestApi.version=Game.version=parseInt(Game.version,10)?Game.version:TWDB.script.game_version,TWDB.script.game_version=Game.version,TWDB.script.isDev=function(){return this.check.search("dev_version")!==-1};const twiceHTMLUnescape=e=>{const t=document.createElement("textarea");return t.innerHTML=e,t.innerHTML=t.value,t.value};if(window.debLog=TWDB.script.isDev()&&console?.info?(...e)=>{}:()=>{},localStorage.getItem("TWDB_preferences")){const e=JSON.parse(localStorage.getItem("TWDB_preferences"));for(const t in TWDB.script.preferences)e[t]===void 0&&(e[t]=TWDB.script.preferences[t]);TWDB.script.preferences=e}TWDB.script.preferences.lang=TWDB.script.preferences.lang==null?TWDB.script.gameLocale:TWDB.script.preferences.lang;const triggerLangLoaded=function(){TWDB.Eventer&&typeof TWDB.Eventer.trigger=="function"&&TWDB.Eventer.trigger("TWDBLangLoaded")};loadLanguage(TWDB.script.preferences.lang,{previousLang:null}),TWDB.ResourceLoader.load("images",null,function(e){e&&typeof e=="object"&&(Object.assign(TWDB.images,e),TWDB.Eventer&&typeof TWDB.Eventer.trigger=="function"&&TWDB.Eventer.trigger("TWDBImagesLoaded"))},function(){typeof ErrorModule<"u"&&ErrorModule.report&&ErrorModule.report(Error(Language._("errors.images_json_load_error")),Language._("errors.images_load_retry")),setTimeout(function(){TWDB.ResourceLoader.load("images",null,function(e){e&&typeof e=="object"&&(Object.assign(TWDB.images,e),TWDB.Eventer&&typeof TWDB.Eventer.trigger=="function"&&TWDB.Eventer.trigger("TWDBImagesLoaded"))},function(){typeof ErrorModule<"u"&&ErrorModule.report&&ErrorModule.report(Error(Language._("errors.images_load_failed_retry")),Language._("errors.images_load_failed_retry"))})},1e3)}),TWDB.Util=(function(e){return{addCss:function(t,n){return(function(a,o){let r="twdb_css";o!==void 0&&typeof o=="string"&&(r+="_"+o.replace(/\W+/g,"")),e("head style#"+r).append("<br />"+a).length!==1&&e("head").append(e(`<style type="text/css" id="${r}">`).text(a))})(t,n)},backupData:function(){return(function(){const t=[];let n;const a=`twdb_${Character.playerId}_`;let o;if(localStorage.getItem(a+"embackup")!==!0){for(o=0;o<localStorage.length;o++)n=localStorage.key(o),n.search(a)===0&&n.search(/(marketreminder|notes|settings|statistic)$/i)!==-1&&t.push({key:n,newKey:"backup_"+n,value:localStorage.getItem(n)});for(o=0;o<t.length;o++)localStorage.setItem(t[o].newKey,t[o].value);localStorage.setItem(a+"embackup",!0)}})()},query:function(t,n){if(!n)return document.querySelector(t);if(n instanceof Node)return n.querySelector(t);if(n instanceof jQuery)return n.length?n[0].querySelector(t):null;if(typeof n=="object"&&n!==null&&"querySelector"in n)return n.querySelector(t);if(typeof n=="string"){const a=TWDB.Util.query(n);return a?a.querySelector(t):null}return null}}})(jQuery),TWDB.ClothCalc={calcdata:{skills:{},items:{},jobs:{},custom:{},animals:[],used:{},loaded:!1},ready:!1,bidsLoading:!1,bids:{},getBids:function(){if(this.bidsLoading)return;this.bidsLoading=!0;const e=this;Ajax.remoteCall("building_market","fetch_bids",{},function(t){if(t.error)return new UserMessage(t.msg,UserMessage.TYPE_ERROR).show();const n=t.msg.search_result;for(let a=0;a<n.length;a++)e.bids[n[a].item_id]=1;e.bidsLoading=!1})},recLoading:!1,recipes:{},getLearned:function(){if(this.recLoading)return;this.recLoading=!0;const e=this;Ajax.remoteCall("crafting","",{},function(t){const n=t.recipes_content;if(n)for(let a=0;a<n.length;a++)e.recipes[n[a].item_id]=1;e.recLoading=!1})},init:function(){if(!this.ready&&(this.getBids(),this.getLearned(),!TWDB.Updater.wasUpdated())){const e=TWDB.Cache.load("calcdata");typeof e=="object"&&e!==null&&isDefined(e.loaded)&&(this.calcdata=e)}}},(function($){function waitForImages(e,t){if(Images[e])return t(),void 0;if(TWDB.Eventer){const n=TWDB.Eventer.set("TWDBImagesLoaded",function(){Images[e]&&(TWDB.Eventer.remove("TWDBImagesLoaded",n),t())},1),a=setInterval(function(){Images[e]&&(clearInterval(a),TWDB.Eventer.remove("TWDBImagesLoaded",n),t())},100);setTimeout(function(){clearInterval(a)},1e4)}else setTimeout(function(){Images[e]&&t()},500)}const _base=TWDB,w=window,Images=_base.images,Script=_base.script,ClothCalc=_base.ClothCalc,Debugger={};_base.Debugger=Debugger;const ErrorModule=(function(e){const t={},n=[];let a=!0;t.report=function(r,i){isDefined(r.message)?n.push({msg:`${i} ${r.stack&&(r.stack.match(/:\d+:\d+/)||[])[0]||""}`,e:r.message}):n.push({msg:Language._("errors.failed_add_error"),e:i}),a&&(a=!1,WestUi.NotiBar.add(new OnGoingPermanentEntry(function(){o()},Language._("errors.occurred"),"hint")))};const o=function(){const r=new west.gui.Scrollpane;e(r.getMainDiv()).css("height","375px"),e(r.getMainDiv()).find(".tw2gui_scrollpane_clipper_contentpane").addClass("selectable");let i=`<style>#twdb_error_table { width: 99.5%; border-collapse: collapse; font-size: 12px; table-layout: fixed; } #twdb_error_table th { background:url('${Game.cdnURL}/images/interface/wood_texture_dark.jpg'); color: #fff; padding: 8px; text-align: left; border: 1px solid #666; } #twdb_error_table td { padding: 6px 8px; border: 1px solid #666; word-wrap: break-word; word-break: break-word; position: relative; } #twdb_error_table .col-index { width: 30px; min-width: 30px; text-align: center; } #twdb_error_table .col-msg { width: 40%; } #twdb_error_table .col-error { width: auto; } #twdb_error_table .copy-btn { display: none; position: absolute; right: 4px; top: 4px; background: #442200; color: #fff; border: 1px solid #666; padding: 2px 6px; font-size: 10px; cursor: pointer; border-radius: 3px; z-index: 5; } #twdb_error_table .copy-btn:hover { background: #5e321a; } #twdb_error_table td.col-msg:hover .copy-btn, #twdb_error_table td.col-error:hover .copy-btn { display: inline-block; }</style><table id="twdb_error_table"><thead><tr><th class="col-index">#</th><th class="col-msg">${Language._("script.error_message")}</th><th class="col-error">${Language._("script.error_type")}</th></tr></thead><tbody>`;for(let c=n.length-1;c>=0;c--){const b=((n[c].msg||"")+"").replace(/</g,"&lt;").replace(/>/g,"&gt;"),u=((n[c].e||"")+"").replace(/</g,"&lt;").replace(/>/g,"&gt;"),g=((n[c].msg||"")+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/\n/g,"&#10;").replace(/\r/g,"&#13;"),l=((n[c].e||"")+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/\n/g,"&#10;").replace(/\r/g,"&#13;"),f=Language._("script.error_copy");i+=`<tr><td class="col-index">${c}</td><td class="col-msg">${b}<button class="copy-btn" data-copy="${g}">${f}</button></td><td class="col-error">${u}<button class="copy-btn" data-copy="${l}">${f}</button></td></tr>`}i+="</tbody></table>",r.appendContent(i),e(r.getMainDiv()).find(".copy-btn").on("click",function(){let c=e(this).attr("data-copy");const b=document.createElement("div");b.innerHTML=c,c=b.textContent||b.innerText||c;const u=Language._("script.error_copied");if(navigator.clipboard?.writeText)navigator.clipboard.writeText(c).then(function(){const g=e(this),l=g.text();g.text(u),setTimeout(function(){g.text(l)},1e3)}.bind(this));else{const g=document.createElement("textarea");g.value=c,g.style.position="fixed",g.style.opacity="0",document.body.appendChild(g),g.select();try{document.execCommand("copy");const l=e(this),f=l.text();l.text(u),setTimeout(function(){l.text(f)},1e3)}catch(l){ErrorModule.report(l,Language._("errors.copy_failed"))}document.body.removeChild(g)}}),wman.open("twdb_error",null,"noreload").setMiniTitle(Language._("errors.mini_title")).setTitle(Language._("errors.title")).appendToContentPane(r.getMainDiv())};return t.test=function(){t.report(Error("Test error with stack trace"),"Test error message 1"),t.report(Error("Language file loading error"),Language._("errors.language_file_loading")),t.report(Error("Failed to load module"),Language._("errors.failed_load_module",{module:"test-module"})||"failed 000000 test-module"),t.report(Error("Cache error"),Language._("errors.load_from_cache",{key:"test-cache"})||"failed 000000 test-cache"),t.report(Error("Worker error"),Language._("errors.worker")),t.report(Error("getFortData error"),"getFortData"),t.report(Error("Job analyzer error"),"Job-Analyzer parseAndStoreJobReport"),t.report(Error("Table sorting error"),"Analyzer applyTableSorting"),t.report(Error("Bonus job error"),"bonusjob reset"),t.report(Error("Color injection error"),"injectColor"),t.report(Error("NotiBar manipulation error"),"manipulate WestUi.NotiBar.add"),t.report(Error("Work queue error"),"manipulate removeWorkQueuePA"),t.report(Error("Nuggets error"),"manipulate changeWofNuggets"),t.report(Error("Market dialog error"),"manipulate market sell dialog"),t.report({message:"Error without stack trace"},"Test error without stack"),t.report({message:"Another plain error"},"");var r=Error("");t.report(r,"Error with empty message")},t})($);_base.Error=ErrorModule,Debugger.Error=ErrorModule;const Loader=(function(e){let t={};const n=[],a={},o={};let r,i=!1,c=!1,b=!1,u=0;t.add=function(m,h,k,L){const D={ready:!1};return n.push({key:m,txt:h,call:k,dep:L||{},ready:D,count:0}),D},t.init=function(){r||(r=w.setInterval(function(){g()},500))};const g=function(){if(!c){c=!0;try{if(i===!1){if(!l())return c=!1,void 0;TWDB.Cache.init(),a.Cache=!0;try{Updater.query(),f()}catch(m){return ErrorModule.report(m,Language._("errors.loader_api_registration")),new UserMessage(Language._("script.api_registration_failed"),UserMessage.TYPE_FATAL).show(),_()}return d()}if(isDefined(o[i.key]))return d();if(i.ready.ready)return a[i.key]=!0,b=!1,d();c=!1}catch(m){ErrorModule.report(m,Language._("errors.loader_process_queue")),c=!1}}},l=function(){try{return!!(isDefined(w.jQuery)&&isDefined(w.TheWestApi)&&isDefined(w.TheWestApi.version)&&w.ItemManager.get(2e3)!==void 0&&isDefined(w.Character)&&w.Character.playerId!==0&&w.Bag.loaded)}catch(m){return ErrorModule.report(m,Language._("errors.loader_check_game_readiness")),!1}},f=()=>{try{const m={id:"twdb_clothcalc",name:"TW-DB.info - Cloth Calc - BB",version:"2.04",gameVersion:Script.game_version+"",author:"[tw-db.info] Team & BB",website:"https://tw-db.info"},h=`<br><br><form action="https://www.paypal.com/cgi-bin/webscr" method="post"><input name="cmd" value="_s-xclick" type="hidden"><input name="encrypted" value="-----BEGIN PKCS7-----MIIHNwYJKoZIhvcNAQcEoIIHKDCCByQCAQExggEwMIIBLAIBADCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJKoZIhvcNAQEBBQAEgYChINvT18jAz9CalhBmJdmLCwpXoNRJP+VkXk8FX8ggf0svoPqtoBds+0Jtzdvj9jQ0Sf6erVBUCcRpMpkb+Tf3GCQVHTglnw8JrK6ZzzRhjsZZCJn7tgFwu2LimWCyFnNbeGNb3JeAUyoPqqNlc8tD5abn15g/a8T7+lmSJMLZOjELMAkGBSsOAwIaBQAwgbQGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQIKDoxC57piTyAgZCs1uffooeE6z5oFOY8gF33GntGddTvCLpVnR2oEfR3HaNWR2/DSZsxTSBxOQ9h43E+9A9WN1QJDj+4qyu/20IbTBVkFCl/eoGTV44O///OowbrCRqIUbDKtBBj6rrv876AFW0aV8/iRoreP66eCBd3FG7K6Pue0rBR7khec7TFMM0kd++ZT0QTSvuQ4IvsbOWgggOHMIIDgzCCAuygAwIBAgIBADANBgkqhkiG9w0BAQUFADCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBglghkiG9w0BCQEWDXJlQHBheXBhbC5jb20wHhcNMDQwMjEzMTAxMzE1WhcNMzUwMjEzMTAxMzE1WjCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAMFHTt38RMxLXJyO2SmS+Ndl72T7oKJ4u4uw+6awntALWh03PewmIJuzbALScsTS4sZoS1fKciBGoh11gIfHzylvkdNe/hJl66/RGqrj5rFb08sAABNTzDTiqqNpJeBsYs/c2aiGozptX2RlnBktH+SUNpAajW724Nv2Wvhif6sFAgMBAAGjge4wgeswHQYDVR0OBBYEFJaffLvGbxe9WT9S1wob7BDWZJRrMIG7BgNVHSMEgbMwgbCAFJaffLvGbxe9WT9S1wob7BDWZJRroYGUpIGRMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbYIBADAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBBQUAA4GBAIFfOlaagFrl71+jq6OKidbWFSE+Q4FqROvdgIONth+8kSK//Y/4ihuE4Ymvzn5ceE3S/iBSQQMjyvb+s2TWbQYDwcp129OPIbD9epdr4tJOUNiSojw7BHwYRiPh58S1xGlFgHFXwrEBb3dgNbMUa+u4qectsMAXpVHnD9wIyfmHMYIBmjCCAZYCAQEwgZQwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tAgEAMAkGBSsOAwIaBQCgXTAYBgkqhkiG9w0BCQMxCwYJKoZIhvcNAQcBMBwGCSqGSIb3DQEJBTEPFw0xMTAxMTkyMDQ1NDVaMCMGCSqGSIb3DQEJBDEWBBSftIcjkFDuoOkdAfklhyX0/yFgtzANBgkqhkiG9w0BAQEFAASBgF9SGe3NSMpJbcwAlWM9fDzOYOQovnXP1jCT9eR7ZCsZ4UdlS5u5/ubq4KvSd2s/Iz7H8I69CL5vY6n50Qk57lZv2m+DSmY/p+xjcPG0JBuRaT0uGNOeiPdXwC+HiDPP6EhJXXEZv5fqXPmOUJPdovWYgyu/LgVCRAZw1qp3995m-----END PKCS7-----" type="hidden"><input type="image" src="https://www.paypalobjects.com/en_US/DE/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="${Language._("script.paypal_alt")}"><img width="1" border="0" height="1" src="https://www.paypal.com/en_GB/i/scr/pixel.gif" alt=""></form><br>`,k=w.TheWestApi.register(m.id,m.name,m.version,m.gameVersion,m.author,m.website),L=e(`<div style="font-family: 'comic sans ms'; font-size: 13pt; padding-top: 10px; text-align: center;">${Language._("script.description")}${h}${Language._("script.thank_you")}</div>`);k.setGui(L),k.isOutdated()&&w.TheWestApi.displayOutdated()}catch(m){ErrorModule.report(m,Language._("errors.loader_register_script_api"))}},d=function(){if(n.length===0)return _();try{if(i=n.shift(),i.count++,i.count>u){if(b)return ErrorModule.report({message:Language._("errors.deadlock_detected")},Language._("errors.failed_load_module",{module:i.key})),o[i.key]=!0,d();u++,b=!0}for(const m in i.dep)if(!isDefined(a[m]))return TWDB.script.isDev(),n.push(i),d();try{i.call()}catch(m){return ErrorModule.report(m,Language._("errors.failed_load_module",{module:i.key})),o[i.key]=!0,d()}c=!1,g()}catch(m){ErrorModule.report(m,Language._("errors.loader_process_next_module")),c=!1}},_=function(){try{w.clearInterval(r),w.setTimeout(function(){t=null},1e3)}catch(m){ErrorModule.report(m,Language._("errors.loader_cleanup"))}};return t.stack=n,t.loaded=a,t.failed=o,t.current=i,t})($);Debugger.Loader=Loader;const Cache=(function(e){const t={},n={};let a="",o={};const r=function(i){o[i]||(o[i]=!0,t.save("keys",o))};return t.load=function(i){r(i);try{return JSON.parse(decodeURIComponent(localStorage.getItem(a+i)))}catch(c){return ErrorModule.report(c,Language._("errors.load_from_cache",{key:i})),t.save(i,null),null}},t.save=function(i,c){r(i);try{return localStorage.setItem(a+i,encodeURIComponent(JSON.stringify(c))),!0}catch(b){return ErrorModule.report(b,Language._("errors.save_to_cache",{key:i})),t.save(i,null),!1}},t.reset=function(i,c){try{if(i){if(isDefined(c))localStorage.removeItem(c);else for(const b in o)localStorage.removeItem(a+b);new UserMessage(Language._("cache.reset_complete"),UserMessage.TYPE_SUCCESS).show(),location.href=location.href.replace(location.hash||"#","")}else{const b=e(`<div><h2>${Language._("cache.reset_confirm",{script:Script.name})}</h2></div>`),u=new west.gui.Textfield("twdb_cache_key").setSize(40).setLabel(Language._("cache.reset_key")+":");b.append(u.getMainDiv());const g=new west.gui.Checkbox(Language._("cache.reset_all_keys")).setSelected(!0);g.setCallback(function(l){l&&u.setValue("")}),e(u.getMainDiv()).find("span").css("font-size","12px"),e(u.getMainDiv()).find("input").keyup(function(){g.setSelected(!1)}),b.append(e('<div style="display:block;" />').append(g.getMainDiv())),new west.gui.Dialog(Language._("cache.reset"),b,west.gui.Dialog.SYS_QUESTION).addButton(Language._("common.ok"),function(){g.isSelected()?t.reset(!0):t.reset(!0,u.getValue())}).addButton(Language._("common.cancel")).show()}}catch(b){ErrorModule.report(b,Language._("errors.cache_reset"))}},t.init=function(){n.ready||(a=`twdb_${Character.playerId}_`,o=t.load("keys"),o||(o={keys:!0}),n.ready=!0)},t})($);_base.Cache=Cache,Debugger.Cache=Cache;const Worker=(function(e){const t={},n=[];let a=!1,o=!1;t.add=function(i){n.push(i),a||(a=w.setInterval(function(){r()},100))};const r=function(){if(!o)try{o=!0;const i=n.shift();if(i)try{i()}catch(c){ErrorModule.report(c,Language._("errors.worker"))}n.length===0&&(w.clearInterval(a),a=!1),o=!1}catch(i){ErrorModule.report(i,Language._("errors.worker_process_task")),o=!1}};return t})();Debugger.Worker=Worker;const Timer=(function(e){const t={};let n=0,a=0,o=0;return t.getTimeout=function(){const r=Date.now();2e3>r-n?a++:a=0,6e4>r-n?o++:o=0,n=r;let i=0;return o>50&&(i=6e4),20>a?i+200:i+2e3},t})();Debugger.Timer=Timer;const Eventer=(function(e){const t={},n={};return t.set=function(a,o,r){isDefined(n[a])||(n[a]={});const i=!!isDefined(r)&&r;let c=+Date.now();for(;n[a][c];)c++;return n[a][c]={id:c,call:o,count:i},c},t.trigger=function(a){if(!isDefined(n[a]))return;let o=0;for(const r in n[a])isDefined(n[a][r].id)&&(w.setTimeout(n[a][r].call,10),n[a][r].count!==!1?(n[a][r].count--,n[a][r].count>0&&o++):o++);o===0&&delete n[a]},t.remove=function(a,o){if(!isDefined(n[a])||!isDefined(n[a][o]))return!1;delete n[a][o]},t})();_base.Eventer=Eventer,Debugger.Eventer=Eventer;const Jobs=(function(e){const t={};let n={};const a=[],o={},r={},i=[1828e3,1829e3,183e4,2e6,2003e3,2006e3,2009e3];let c,b={};n=Loader.add("Jobs","tw-db Jobsystem",function(){if(!n.ready)try{let g=0,l=0;const f={};for(;;){g++;const _=w.JobList.getJobById(g);if(_){l=0,a.push(_.id),o[_.name.toLowerCase()]=_.id,r[_.shortname.toLowerCase()]=_.id;for(const m in _.yields)Number.isNaN(m)||f[m]||(f[m]=!0,i.push(+m))}else if(l++,l>5)break}c={description:"",duration:1800,energy:6,groupid:null,id:255,malus:0,name:Language._("misc.construction"),randomyields:[],shortname:"construction",skills:{build:3,repair:1,leadership:1},yields:{},calcJobPoints:function(){return 0},canDo:function(){return!0}},a.push(255),o[c.name.toLowerCase()]=255,r[c.shortname.toLowerCase()]=255;const d=function(_,m){const h=_===255?c:w.JobList.getJobById(_),k=m===255?c:w.JobList.getJobById(m);return h.name>k.name};a.sort(d),i.sort(),b=Cache.load("jobdata"),b!==null&&typeof b=="object"||(b={}),Eventer.set("TWDBdataLoaded",function(){u()}),n.ready=!0}catch(g){ErrorModule.report(g,Language._("errors.jobs_initialize_system"))}},{Cache:!0});const u=function(){try{b={},Cache.save("jobdata",b)}catch(g){ErrorModule.report(g,Language._("errors.jobs_reset_data"))}};return t.getJobByName=function(g){return g=e.trim(g).toLowerCase(),isDefined(o[g])?t.getJobById(o[g]):null},t.getJobByShortname=function(g){return g=e.trim(g).toLowerCase(),isDefined(r[g])?t.getJobById(r[g]):null},t.getJobById=function(g){let l;if(g===255)l=c;else if(l=w.JobList.getJobById(g),!l)return l;const f=e.extend(!0,{},l);let d=1;w.Character.charClass==="adventurer"&&(w.Premium.hasBonus("character")?d*=1.2:d*=1.1),w.Premium.hasBonus("money")&&(d*=1.5);for(let _=0;_<f.randomyields.length;_++)f.randomyields[_]=round(f.randomyields[_]*d,2);if(f.yields.length===void 0)for(const _ in f.yields)f.yields[_].prop=round(f.yields[_].prop*d,2);return f},t.openJob=function(g,l,f){w.JobWindow.open(g,l,f)},t.startJob=function(g,l,f,d){w.JobWindow.startJob(g,l,f,+d||3600)},t.getAllJobs=function(){return a},t.isProduct=function(g){return e.inArray(+g,i)},t.getPopup=function(g,l){let f='<div style="min-width:60px;text-align:center" >';const d=t.getJobById(g);return isDefined(d)&&(f+=`<span style="font-weight:bold;display:block;">${d.name}</span><div class="job" style="position:relative;left:50%;margin:10px -25px;"><div ${isDefined(l)?`class="featured ${l}"`:""}></div><img src="${Game.cdnURL}/images/jobs/${d.shortname}.png" class="job_icon" ></div>`),f+="</div>",f},t})($);_base.Jobs=Jobs,Debugger.Jobs=Jobs;const Window=(function(e){const t={};let n=null,a=null;const o={};let r={};const i=function(){if(!r.ready)try{if(!Images.button)return waitForImages("button",i),void 0;const u=e('<div title="TW-DB.info | BB" class="menulink" />').css("background-image",`url(${Images.button})`).on("mouseenter",function(){e(this).css("background-position","-25px 0px")}).on("mouseleave",function(){e(this).css("background-position","0px 0px")}).click(function(){c()});e("#ui_menubar").append(e('<div class="ui_menucontainer" id="TWDB_ClothCalc_menubuttons" />').append(u).append('<div class="menucontainer_bottom" />')),ready=!0,r.ready=!0}catch(u){ErrorModule.report(u,Language._("errors.window_initialize"))}};r=Loader.add("Window","tw-db Scriptwindow",i),t.open=function(u){c(u)};const c=function(u){try{let g;n=wman.open("twdb_window",null).setMiniTitle(Language._("script.twdb_title")).setTitle(Language._("script.twdb_title")),n.appendToContentPane(e(`<div style="width:100%;text-align:center;position:absolute;bottom:0px;left:0px;height:15px;display:block;font-size:12px;color:#000000;">.:powered by TW-DB Team & BB | <a href="https://tw-db.info" style="font-weight:normal;color:#000000;" target="_blank">${Language._("script.twdb_title")}:.</a> | .:v${Script.version}:.</div>`));for(const l in o)isDefined(g)||(g=l),u===l&&(g=l),n.addTab(o[l].name,l,function(f,d){b(d)}),o[l].gui.children().remove(),n.appendToContentPane(o[l].gui);isDefined(g)&&(a=o[g].gui,b(g))}catch(g){ErrorModule.report(g,Language._("errors.window_open"))}},b=function(u){try{if(a.hide(),n.showLoader(),n.activateTab(u),!isDefined(o[u]))return;o[u].title!==""?n.setTitle(Language._("script.twdb_title_with",{title:o[u].title})):n.setTitle(""),a=o[u].gui,a.show(),w.setTimeout(o[u].callback,10)}catch(g){ErrorModule.report(g,Language._("errors.window_switch_tab"))}};return t.addTab=function(u,g,l,f){return o[u]={title:l,name:g,callback:f,gui:null},o[u].gui=e('<div style="margin-top:10px;"/>').hide(),o[u].gui},t.updateTab=function(u,g,l){isDefined(o[u])&&(o[u].name=g,o[u].title=l,n!==null&&a===o[u].gui&&(l!==""?n.setTitle(Language._("script.twdb_title_with",{title:l})):n.setTitle("")))},t.hideLoader=function(){n&&n.hideLoader()},t.showLoader=function(){n&&n.showLoader()},t})($);Debugger.Window=Window;const Settings=(function(e){let t={};const n={};let a=null,o={};o=Loader.add("Settings","tw-db Settingssystem",function(){if(o.ready)return;const b=Cache.load("settings");t=typeof b=="object"&&b!==null?b:{},TWDB.Util.addCss(`span.twdb_sett_capt{font-size:115%;font-weight:bold;font-style:italic;display:inline-block;margin-top:8px;text-shadow:2px 1px 2px #643}.build_progress>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:264px}.rp_row_jobdata>.rp_jobdata_text>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:125px}#character-shadow>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:95px}#char_crafting_progress>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:144px}.dal_status>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:294px}.job_progress_jobstars>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:219px}.cell.cell_2.progress>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill,.saloon_duel_moti>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:194px}.flfi_progressbar>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:324px}.dl_motivation>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:330px}.duels-TWXDuelMap>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:766px}.sheriff-TWXSheriff>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:581px}.messages-analyzer-job>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:692px}.achievement-categories-total>.entry>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:204px}.achievement-total-completed>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:623px}#achievement_progress>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:450px}.achievement-list>.achievement-list-scroll-wrapper>.tw2gui_scrollpane>.tw2gui_scrollpane_clipper>.tw2gui_scrollpane_clipper_contentpane>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:490px}[class^="TWFBT_"]>.tw2gui_window_content_pane>.tw2gui_scrollpane>.tw2gui_scrollpane_clipper>.tw2gui_scrollpane_clipper_contentpane>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:677px}.TWDS_fbs_basestats_content table thead tr{position:sticky;top:0;background:wheat}div.job_bestwearbutton{top:5px!important}.fort_battle_button_analyzer{left:304px!important}.fort_battle_buttons{left:98px!important}.settings-container{display:flex;flex-direction:column;gap:1px;padding-bottom:12px}.settings-item{display:flex;align-items:center;gap:4px}.settings-category-header{font-size:115%;font-weight:bold;font-style:italic;display:block;margin-top:8px;text-shadow:2px 1px 2px #643}.settings-item-checkbox{flex-shrink:0;width:25px}.settings-item-label{flex-grow:1;cursor:pointer}.settings-group-header{display:flex;align-items:center;cursor:pointer;margin-top:8px;padding:4px 0;border-radius:3px}.settings-group-header .icon{width:16px;height:16px;background-repeat:no-repeat;margin-left:5px;margin-right:5px}.settings-group-header .butMinus{background-image:url(${Game.cdnURL}/images/scrollbar/scroll_down.png)}.settings-group-header .butPlus{background-image:url(${Game.cdnURL}/images/scrollbar/scroll_up.png)}.settings-group-content{padding-left:30px;display:none;flex-direction:column;gap:3px}.beeper-sound-settings{display:flex;align-items:center;gap:10px;padding:4px 0}.active_tab_id_settings>*,.active_tab_id_notes>*{user-select:none}.twdb_lang_combobox .tw2gui_combobox_list{max-height:260px;overflow-y:auto;overflow-x:hidden}`),a=Window.addTab("settings",Language._("settings.title"),Language._("settings.title"),i),o.ready=!0},{Cache:!0,Window:!0});const r=[{locale:"en_DK",twoLettersCode:"en",svgFlagCodes:["us","gb"],name:"English",lang_name:"International",translator:"Belle Bernice"},{locale:"el_GR",twoLettersCode:"el",svgFlagCode:"gr",name:"Greek",lang_name:"Ελληνικά",translator:"Belle Bernice"},{locale:"cs_CZ",twoLettersCode:"cs",svgFlagCode:"cz",name:"Czech",lang_name:"Čeština",translator:"Auto Translate"},{locale:"de_DE",twoLettersCode:"de",svgFlagCode:"de",name:"German",lang_name:"Deutsch",translator:""},{locale:"es_ES",twoLettersCode:"es",svgFlagCode:"es",name:"Spanish",lang_name:"Español",translator:"Auto Translate"},{locale:"pt_BR",twoLettersCode:"pt-BR",svgFlagCode:"br",name:"Portuguese",lang_name:"Português",translator:"Auto Translate"},{locale:"fr_FR",twoLettersCode:"fr",svgFlagCode:"fr",name:"French",lang_name:"Français",translator:"Auto Translate"},{locale:"hu_HU",twoLettersCode:"hu",svgFlagCode:"hu",name:"Hungarian",lang_name:"Magyar",translator:"Auto Translate"},{locale:"it_IT",twoLettersCode:"it",svgFlagCode:"it",name:"Italian",lang_name:"Italiano",translator:"Auto Translate"},{locale:"nl_NL",twoLettersCode:"nl",svgFlagCode:"nl",name:"Dutch",lang_name:"Dutch",translator:"Auto Translate"},{locale:"pt_PT",twoLettersCode:"pt-PT",svgFlagCode:"pt",name:"Portuguese",lang_name:"Português",translator:"Auto Translate"},{locale:"pl_PL",twoLettersCode:"pl",svgFlagCode:"pl",name:"Polish",lang_name:"Polski",translator:"Auto Translate"},{locale:"ro_RO",twoLettersCode:"ro",svgFlagCode:"ro",name:"Romanian",lang_name:"Română",translator:"Auto Translate"},{locale:"ru_RU",twoLettersCode:"ru",svgFlagCode:"ru",name:"Russian",lang_name:"Русский",translator:"Auto Translate"},{locale:"sk_SK",twoLettersCode:"sk",svgFlagCode:"sk",name:"Slovak",lang_name:"Slovenčina",translator:"Auto Translate"},{locale:"tr_TR",twoLettersCode:"tr",svgFlagCode:"tr",name:"Turkish",lang_name:"Türkçe",translator:"Auto Translate"},{locale:"da_DK",twoLettersCode:"da",svgFlagCode:"dk",name:"Danish",lang_name:"Dansk",translator:"Auto Translate"},{locale:"es_AR",twoLettersCode:"es-AR",svgFlagCode:"ar",name:"Spanish",lang_name:"Español",translator:"Auto Translate"},{locale:"es_MX",twoLettersCode:"es-MX",svgFlagCode:"mx",name:"Spanish",lang_name:"Español",translator:"Auto Translate"},{locale:"fi_FI",twoLettersCode:"fi",svgFlagCode:"fi",name:"Finnish",lang_name:"Suomi",translator:"Auto Translate"},{locale:"hr_HR",twoLettersCode:"hr",svgFlagCode:"hr",name:"Croatian",lang_name:"Hrvatski",translator:"Auto Translate"},{locale:"no_NO",twoLettersCode:"no",svgFlagCode:"no",name:"Norwegian",lang_name:"Norsk",translator:"Auto Translate"},{locale:"sl_SI",twoLettersCode:"sl",svgFlagCode:"si",name:"Slovenian",lang_name:"Slovenščina",translator:"Auto Translate"},{locale:"sr_RS",twoLettersCode:"sr",svgFlagCode:"rs",name:"Serbian",lang_name:"Српски",translator:"Auto Translate"},{locale:"sv_SE",twoLettersCode:"sv",svgFlagCode:"se",name:"Swedish",lang_name:"Svenska",translator:"Auto Translate"},{locale:"uk_UA",twoLettersCode:"uk",svgFlagCode:"ua",name:"Ukrainian",lang_name:"Українська",translator:"Auto Translate"}],i=function(){function b(T){const S=e('<input type="text" />').css({width:"calc(100% - 10px)",maxWidth:"450px",padding:"5px",fontFamily:"monospace",fontSize:"11px",boxSizing:"border-box"}).val(T.initialText||"").attr("placeholder",T.mode==="import"?Language._("io.import_placeholder"):"");T.mode==="export"&&S.on("focus",function(){this.select()});const B=e("<div>").css({maxWidth:"470px"}).append(T.mode==="export"?e("<p>").text(Language._("io.export_copy_failed")):e("<p>").text(Language._("io.import_paste_instructions")),S),p=new west.gui.Dialog(T.title,B);T.mode==="import"&&p.addButton(Language._("misc.import"),function(){T.onConfirm&&T.onConfirm(S.val()),this.close()}),p.addButton(T.mode==="export"?Language._("common.close"):Language._("common.cancel"),function(){this.close(),T.mode==="import"&&new UserMessage(Language._("io.import_cancelled"),UserMessage.TYPE_INFO).show()}).show()}a.children().remove();const u=new west.gui.Scrollpane;e(u.getMainDiv()).css("height","294px").css("margin-bottom","6px"),a.append(u.getMainDiv());const g=[{type:"category",title:Language._("settings.category_inventory")},{id:"collector",text:Language._("settings.collector")},{id:"collector_sell",text:Language._("settings.collector_sell")},{id:"pin_items",text:Language._("settings.pin_items")},{type:"category",title:Language._("settings.category_quests")},{id:"quest_cancel",text:Language._("settings.quest_cancel")},{id:"instant_quest",text:Language._("settings.instant_quest")},{id:"colored_quest",text:Language._("settings.colored_quest")},{type:"category",title:Language._("settings.category_jobs")},{id:"job_show_lp",text:Language._("settings.job_lp")},{type:"category",title:Language._("settings.category_task_list")},{id:"task_list_points",text:Language._("settings.task_points")},{type:"category",title:Language._("settings.category_fort")},{id:"import_westforts",text:Language._("settings.forts_import")},{id:"fort_recruitment",text:Language._("settings.fort_recruit")},{id:"enhanced_fort_recruitment",text:Language._("settings.fort_recruit_enhanced")},{id:"declare_report",text:Language._("settings.declare_report")},{id:"owned_forts_tab",text:Language._("settings.forts_owned")},{id:"cemetery_critical",text:Language._("settings.cemetery_critical")},{id:"total_dmg_battle",text:Language._("settings.battle_damage")},{id:"battle_info_round",text:Language._("settings.battle_round")},{type:"category",title:Language._("settings.category_town")},{id:"building_progress",text:Language._("settings.building_progress")},{id:"church_levels",text:Language._("settings.church_levels")},{id:"improved_cityhall_tab",text:Language._("settings.improved_cityhall_tab")},{id:"town_forum_blink",text:Language._("settings.forum_blink")},{type:"category",title:Language._("settings.category_market")},{id:"market_map",text:Language._("settings.market_map")},{id:"market_reminder",text:Language._("settings.market_reminder")},{id:"market_sell_dialog",text:Language._("settings.market_sell")},{id:"market_report",text:Language._("settings.market_report")},{id:"improved_market",text:Language._("settings.market_improved")},{type:"category",title:Language._("settings.category_graphics")},{id:"duel_motivation",text:Language._("settings.duel_motivation")},{id:"direct_sleep",text:Language._("settings.sleep_direct")},{id:"deposit",text:Language._("settings.deposit")},{id:"no_shop_sale",text:Language._("settings.shop_sale_off")},{id:"exp_bar",text:Language._("settings.exp_bar")},{id:"mini_chat",text:Language._("settings.mini_chat")},{id:"event_counter",text:Language._("settings.event_counter")},{id:"scrollbars_off",text:Language._("settings.scrollbars_off")},{id:"wear_close",text:Language._("settings.wear_close")},{id:"profile_duel_exp",text:Language._("settings.profile_duel_exp")},{id:"regen_timers",text:Language._("settings.regen_timers")},{id:"button_church",text:Language._("settings.button_church"),group:Language._("settings.automation_buttons")},{id:"button_market",text:Language._("settings.button_market"),group:Language._("settings.automation_buttons")},{type:"category",title:Language._("settings.category_minimap")},{id:"bonus_jobs",text:Language._("settings.bonus_jobs")},{id:"coordinates_input",text:Language._("settings.coordinates_input")},{type:"category",title:Language._("settings.category_premium")},{id:"work_queue_off",text:Language._("settings.work_queue_off")},{id:"fetch_all_off",text:Language._("settings.fetch_all_off")},{id:"wof_nuggets_off",text:Language._("settings.wof_nuggets_off")},{type:"category",title:Language._("settings.category_misc")},{id:"chat",text:Language._("settings.chat")},{id:"notes",text:Language._("settings.notes")},{id:"auto_deposit",text:Language._("settings.auto_deposit")},{id:"chest_analyzer",text:Language._("settings.chest_analyzer")},{id:"weekly_crafting",text:Language._("settings.weekly_crafting")},{id:"telegram_bb_codes",text:Language._("settings.telegram_bb_codes")},{id:"enhanced_rankings",text:Language._("settings.enhanced_rankings")},{id:"translation_texts",text:Language._("settings.translation_texts")},{id:"forum_select",text:Language._("settings.forum_select")},{id:"pin_important",text:Language._("settings.pin_important")},{id:"fortbattle_reminder",text:Language._("settings.fortbattle_reminder")},{id:"night_mode",text:Language._("settings.night_mode")},{id:"blink_events",text:Language._("settings.blink_events")},{id:"whisper_improved",text:Language._("settings.whisper_improved")}],l=e("<div class='settings-container' />"),f=e('<div style="display:flex;flex-direction:column;align-items:flex-end;margin:0 12px -24px 0;" />'),d=e('<div style="display:flex;align-items:center;justify-content:flex-end;" />'),_=e(`<div style="font-weight:bold;margin-right:4px;text-shadow:2px 1px 2px #fae3ad;color:#5e321a;">${Language._("script.lang")}:</div>`),m=e(`<div style="font-size:8.5pt;color:#575757;text-align:right;font-style:italic;"><span style="font-weight:bold;color:#5b5b5b;">${Language._("settings.translation_by","Translation by")}:</span> <span class="twdb-translator-name"></span></div>`),h=m.find(".twdb-translator-name"),k=new west.gui.Combobox().setWidth(167);(function(T){const S=T.onDropdown;T.onDropdown=function(){S.call(this);try{const B=e(".tw2gui_modal_box").last().find(".tw2gui_combobox_list div.tw2gui_groupframe_content_pane").last();if(!B.length)return;const p=window.west?.gui?.Scrollpane;if(p){const j=new p,W=e(j.getMainDiv()),I=e(j.getContentPane());W.css({maxHeight:"256px",width:"184px"}),I.append(B.children()),B.empty().append(W)}else B.css({maxHeight:"256px",width:"184px",overflowY:"auto",overflowX:"hidden"})}catch(B){ErrorModule.report(B,Language._("errors.lang_combobox_scroll"))}}})(k),r.forEach(function(T){const S=Language._("script.lang_names."+T.locale,T.lang_name);let B;B=T.name==="English"&&Array.isArray(T.svgFlagCodes)?`<span style="display:inline-block;position:relative;width:18px;height:16px;vertical-align:middle;top:-1px;margin-right:4px;"><span style="position:absolute;left:0;top:0;width:9px;height:16px;overflow:hidden;"><img src="https://login.innogames.de/img/flags/country/4x3/${T.svgFlagCodes[0]}.svg" alt="${T.name}" style="width:18px;height:auto;position:relative;top:-1px;border:1px solid #000;box-sizing:border-box;"></span><span style="position:absolute;right:0;top:0;width:9px;height:16px;overflow:hidden;"><img src="https://login.innogames.de/img/flags/country/4x3/${T.svgFlagCodes[1]}.svg" alt="${T.name}" style="width:18px;height:auto;position:relative;left:-9px;top:-1px;border:1px solid #000;box-sizing:border-box;"></span></span>`:`<span style="display:inline-block;position:relative;width:18px;height:16px;vertical-align:middle;top:-1px;margin-right:4px;"><img src="https://login.innogames.de/img/flags/country/4x3/${T.svgFlagCode||T.svgFlagCodes?.[0]||""}.svg" alt="${T.name}" style="width:18px;height:auto;vertical-align:middle;border:1px solid #000;box-sizing:border-box;position:relative;top:-1px;margin-right:4px;"></span>`,k.addItem(T.locale,`<span style="display:inline-block;height:16px;line-height:14px;vertical-align:middle;margin-left:4px;">${B}<span style="/*!top:-1px;*/position:relative;">${T.name} (${S})</span></span>`)}),k.select(TWDB.script.preferences.lang||"en_DK");let L=TWDB.script.preferences.lang||"en_DK";const D=function(T){const S=r.find(B=>B.locale===T);S?.translator?(h.text(S.translator),m.show()):(h.text(Language._("settings.translation_off","Translation not available")),m.show())};D(L),k.addListener(function(T){L=T,D(T)}),d.append(_).append(k.getMainDiv()),f.append(d).append(m),l.prepend(f);const v={};g.forEach(T=>{if(T.type==="category")return l.append(e("<div class='settings-category-header' />").text(twiceHTMLUnescape(T.title))),void 0;const S=n.get(T.id),B=(p=T.id,function(){n.set(p,!n.get(p))});var p;const j=new west.gui.Checkbox("",S?"tw2gui_checkbox_checked":"",B),W=j.getMainDiv(),I=e("<div class='settings-item' />");I.append(e('<div class="settings-item-checkbox" />').append(W));const M=e('<div class="settings-item-label" />').text(twiceHTMLUnescape(T.text));if(M.on("click",function(){j.toggle()}),I.append(M),T.group){if(!v[T.group]){const U=e(`<div class="settings-group-header"><span class="icon butMinus"></span><span>${twiceHTMLUnescape(T.group)}</span></div>`),O=e("<div class='settings-group-content' />");U.click(function(){O.toggle(),e(this).find(".icon").toggleClass("butMinus").toggleClass("butPlus")}),l.append(U),l.append(O),v[T.group]=O}v[T.group].append(I)}else l.append(I)});try{const T=e("<div class='beeper-sound-settings' />"),S=n.get("beeperSound",9),B=new west.gui.Combobox("beeper_change_sound_settings").addItem(0,Language._("misc.sound_default")).addItem(1,"Bum").addItem(2,"Chime").addItem(3,"Coin").addItem(4,"Coin 2").addItem(5,"ICQ").addItem(6,"QIP").addItem(7,"Tinkle").addItem(8,"Trumpet").addItem(9,"VK").addItem(10,Language._("common.select_file")+"...").select(typeof S=="string"?10:S).addListener(function(j){const W=n.get("beeperSound",9);let I=j;if(j===10||j==="10"){const M="https://example.com/sound.mp3",U=prompt(Language._("common.select_file")+":",M);if(!U&&U!==M)return B.select(typeof W=="string"?10:W),void 0;I=U}else typeof j=="string"&&/^-?\d+$/.test(j)&&(I=parseInt(j,10));n.set("beeperSound",I),window.ChatBeeper&&typeof window.ChatBeeper.updateSound=="function"&&window.ChatBeeper.updateSound()}),p=new west.gui.Button(Language._("common.listen"),function(){window.ChatBeeper&&typeof window.ChatBeeper.play=="function"&&window.ChatBeeper.play()}).getMainDiv();T.append(B.getMainDiv(),e(p)),l.append(T)}catch(T){ErrorModule.report(T,Language._("errors.setup_whisper_sound"))}const C=new west.gui.Button(Language._("misc.export"),function(){const T=JSON.stringify(t,null,2);navigator.clipboard?.writeText?navigator.clipboard.writeText(T).then(function(){new UserMessage(Language._("io.export_clipboard_success"),UserMessage.TYPE_SUCCESS).show()},function(S){b({title:`${Language._("misc.export")} ${Language._("io.settings")}`,initialText:T,mode:"export"})}):b({title:`${Language._("misc.export")} ${Language._("io.settings")}`,initialText:T,mode:"export"})}),A=new west.gui.Button(Language._("misc.import"),async function(){if(!window.confirm(Language._("io.import_warning")))return;const T=function(S){if(!S)return new UserMessage(Language._("io.import_no_data"),UserMessage.TYPE_INFO).show(),void 0;try{const B=JSON.parse(S);for(const p in B)Object.hasOwn(B,p)&&(t[p]=B[p]);Cache.save("settings",t),new west.gui.Dialog(`${Language._("misc.import")} ${Language._("io.settings")}`,Language._("io.import_success_reload"),"ok").setModal(!0,!1,!0).show()}catch(B){new UserMessage(Language._("io.import_error"),UserMessage.TYPE_ERROR).show(),ErrorModule.report(B,Language._("io.import_error_log")+": ")}};try{if(!navigator.clipboard||!navigator.clipboard.readText)throw Error(Language._("errors.clipboard_not_supported"));navigator.clipboard.readText().then(function(S){new UserMessage(Language._("io.import_clipboard_success"),UserMessage.TYPE_SUCCESS).show(),T(S)},function(S){throw new UserMessage(Language._("io.import_clipboard_failed"),UserMessage.TYPE_INFO).show(),S}).catch(function(){b({title:`${Language._("misc.import")} ${Language._("io.settings")}`,initialText:"",mode:"import",onConfirm:T})})}catch(S){ErrorModule.report(S,Language._("errors.clipboard_import_failed")),b({title:`${Language._("misc.import")} ${Language._("io.settings")}`,initialText:"",mode:"import",onConfirm:T})}}),F=new west.gui.Button(Language._("common.save"),function(){c(t,L)}),N=e('<div style="position: absolute; right: 0; top: calc(100% - 18px); width: auto; text-align: right;" />').append(e(`<img style="cursor:pointer;" title="${Language._("misc.reset")} ${Language._("io.settings")}" src="${Images.iconReset}" />`).click(function(){Cache.reset(),i()}));u.appendContent(l),a.append(F.getMainDiv()).append(C.getMainDiv()).append(A.getMainDiv()).append(N),Window.hideLoader()};n.get=function(b,u){return isDefined(t[b])?t[b]:(n.set(b,u),u)},n.set=function(b,u){t[b]=u,["pinnedItems","mini_chat_min","beeperSound","cemetery_critical"].includes(b)&&Cache.save("settings",t)};const c=function(b,u){new west.gui.Dialog(Language._("common.save"),Language._("settings.save_to_reload"),"warning").addButton(Language._("common.ok"),function(){for(const g in b)Object.hasOwn(b,g)&&(t[g]=b[g]);isDefined(u)&&u!==TWDB.script.preferences.lang&&(TWDB.script.preferences.lang=u,localStorage.setItem("TWDB_preferences",JSON.stringify(TWDB.script.preferences))),Cache.save("settings",t)?window.location.reload():new UserMessage(Language._("common.save_error"),UserMessage.TYPE_ERROR).show()}).addButton(Language._("common.cancel")).show(),TWDB.Util.addCss(".tw2gui_dialog{margin:0!important;top:50%!important;left:50%!important;transform:translate(-50%,-50%)}.tw2gui_dialog_content{width:460px}")};return n.getLangs=function(){return r},n})($);_base.Settings=Settings,Debugger.Settings=Settings,TWDB.LanguageCodes=(function(){function e(){return Settings!==void 0&&Settings&&typeof Settings.getLangs=="function"?Settings.getLangs():[]}function t(n){if(!n)return null;const a=e();let o=a.find(r=>r.locale===n);return o||(o=a.find(r=>r.twoLettersCode===n),o||(o=a.find(r=>r.svgFlagCode===n),o||(o=a.find(r=>Array.isArray(r.svgFlagCodes)&&r.svgFlagCodes.includes(n)),o||null)))}return{getLocaleWithUnderscore:function(n){const a=t(n);return a?a.locale:null},getTwoLettersCode:function(n){const a=t(n);return a?a.twoLettersCode:null},getSvgFlagCode:function(n){const a=t(n);return a?Array.isArray(a.svgFlagCodes)?a.svgFlagCodes[0]||null:a.svgFlagCode||null:null},getSvgFlagCodes:function(n){const a=t(n);return a&&a.svgFlagCodes||null},getLanguageCodeMap:function(){const n=e(),a={};return n.forEach(o=>{o.locale&&o.twoLettersCode&&(a[o.locale]=o.twoLettersCode)}),a},getAllLocales:function(){return e().map(n=>n.locale).filter(Boolean)},getLangsArray:e}})();const Updater=(function(e){const t={};let n,a={},o=!1;a=Loader.add("Updater","tw-db Updater",function(){if(!a.ready)try{if(n=Window.addTab("notes",Language._("updater.version_features_title"),Language._("updater.version_features_title"),function(){r()}),Cache.load("version")){if(Script.version!==Cache.load("version")){Cache.save("version",Script.version),o=!0;const i=Language._("updater.script_updated"),c=`<div class="txcenter">${Language._("updater.script_updated_message",{script:`<b>${Script.name}</b>`})}</div>`;new west.gui.Dialog(i,c,"warning").addButton(Language._("common.no")).addButton(Language._("common.yes"),function(){Window.open("notes")}).show()}}else Cache.save("version",Script.version);a.ready=!0}catch(i){ErrorModule.report(i,Language._("errors.updater_initialize"))}},{Cache:!0,Window:!0}),t.wasUpdated=function(){return o};const r=function(){try{n.children().remove();const i=new west.gui.Scrollpane;e(i.getMainDiv()).css("height","335px");let c=!1;for(let b=0;b<Script.notes.length;b++){const u=e(`<h3><a>${Language._("updater.version_label")} - ${Script.notes[b].version}</a></h3>`).css("border-bottom","1px solid black").click(function(){e(this).next().toggle()}),g=Array.isArray(Script.notes[b].notes)?Script.notes[b].notes.join("<br>"):Script.notes[b].notes,l=e(`<div>${g}</div>`);i.appendContent(u).appendContent(l),c&&l.hide(),c=!0}n.append(i.getMainDiv()),Window.hideLoader()}catch(i){ErrorModule.report(i,Language._("errors.updater_render_notes"))}};return t.query=function(){setTimeout(function(){e.getScript(`${Script.protocol}://${Script.folder_url}${Script.check}?${Date.now()}`)},500)},t.check=function(i){try{Script.version.replace(/^0\./,"")!==i&&(function(c){try{const b=Language._("updater.script_needs_update");let u=`<div class="txcenter">${Language._("updater.new_version_available",{script:`<b>${Script.name}</b>`})}</div>`;u+=`<div><br />${Language._("updater.current_version")}: ${Script.version}<br />${Language._("updater.new_version")}: 0.${c}</div>`;const g=`${Script.protocol}://${Script.update_link}${Script.name_max}${Script.update_suffix}`,l=function(){window.open(g),new west.gui.Dialog(Script.name,Language._("updater.reload_after_install"),"warning").setModal(!0,!1,!0).show()};new west.gui.Dialog(b,u,west.gui.Dialog.SYS_WARNING).addButton(Language._("common.not_now")).addButton(Language._("common.ok"),l).show()}catch(b){ErrorModule.report(b,Language._("errors.updater_show_dialog"))}})(i)}catch(c){ErrorModule.report(c,Language._("errors.updater_check_version"))}},t})($);_base.Updater=Updater,Debugger.Updater=Updater;const Sleep=(function(e){let t=null;const n=[];let a,o=[],r={},i={},c=!1,b=0;const u=[],g=["","cubby","bedroom","hotel_room","apartment","luxurious_apartment"];i=Loader.add("Sleep","tw-db DirectSleep",function(){if(!i.ready)try{Settings.get("direct_sleep",!0)&&(TWDB.Util.addCss("ul.tw2gui_selectbox_content.twdb_sleepmenu{max-width:320px!important;white-space:nowrap;overflow-y:auto;overflow-x:hidden}ul.tw2gui_selectbox_content.twdb_sleepmenu>div.tw2gui_scrollpane{width:320px!important}ul.tw2gui_selectbox_content.twdb_sleepmenu>li{padding-right:20px!important}"),r=Cache.load("barracks"),r!==null&&typeof r=="object"||(r={}),l(),Character.homeTown.town_id!==0?L():k()),i.ready=!0}catch(v){ErrorModule.report(v,Language._("errors.sleep_initialize"))}},{Cache:!0,Settings:!0});const l=function(){try{if(!Images.buttonSleep)return waitForImages("buttonSleep",l),void 0;t=GameInject.CharacterButton.add(Images.buttonSleep),t.addMousePopup(Language._("misc.sleep")).click(function(v){w.Character.homeTown.town_id!==0&&n.length===0?m():_(v)})}catch(v){ErrorModule.report(v,Language._("errors.sleep_add_button"))}},f=function(v,C,A){try{const F=new west.gui.Selectbox(!0).addListener(function(N){N==="home"?m():h(N)});w.Character.homeTown.town_id!==0&&F.addItem("home",`${Language._("misc.hotel")} ${w.GameMap.calcWayTime(a,w.Character.homeTown).formatDuration()}`);for(let N=0;A>N;N++)v[N].stage!==0&&F.addItem(N,`${Language._("misc.stage")} ${v[N].stage} ${v[N].distance.formatDuration()} | ${v[N].name}`);e(F.elContent).addClass("twdb_sleepmenu"),F.show(C),c=!1}catch(F){ErrorModule.report(F,Language._("errors.sleep_show_menu")),c=!1}},d=function(v,C,A){try{Ajax.remoteCallMode("building_hotel","get_data",{town_id:u[v].town_id},function(F){if(F.error)return new UserMessage(F.msg).show();u[v].stage=F.hotel_level,++b===C&&f(u,A,C)})}catch(F){ErrorModule.report(F,Language._("errors.sleep_fetch_hotel_data"))}},_=function(v){if(!c)try{if(c=!0,a=MapModule.getLastPosition(),w.Character.homeTown.town_id===0){for(let A=0;A<u.length;A++)u[A].distance=w.GameMap.calcWayTime(a,u[A]);u.sort(function(A,F){return A.distance-F.distance});const C=u.length>5?5:u.length;b=0;for(let A=0;C>A;A++)Object.hasOwn(u[A],"stage")?++b===C&&f(u,v,C):d(A,C,v)}else{for(let C=0;C<n.length;C++)n[C].distance=w.GameMap.calcWayTime(a,n[C]);n.sort(function(C,A){return C.distance-A.distance}),f(n,v,n.length)}}catch(C){ErrorModule.report(C,Language._("errors.sleep_handle_click")),c=!1}},m=function(){try{Ajax.remoteCallMode("building_hotel","get_data",{town_id:w.Character.homeTown.town_id},function(v){if(v.error)return new UserMessage(v.msg).show();const C=g[v.hotel_level];w.TaskQueue.add(new TaskSleep(w.Character.homeTown.town_id,C))})}catch(v){ErrorModule.report(v,Language._("errors.sleep_at_home"))}},h=function(v){try{isDefined(u[v])?w.TaskQueue.add(new TaskSleep(u[v].town_id,g[u[v].stage])):isDefined(n[v])&&w.TaskQueue.add(new TaskFortSleep(n[v].id,n[v].x,n[v].y))}catch(C){ErrorModule.report(C,Language._("errors.sleep_at_location"))}},k=function(){try{Ajax.get("map","get_minimap",{},function(v){if(v.error)return new UserMessage(v.msg).show();for(const C in v.towns)v.towns[C].member_count&&u.push(v.towns[C])})}catch(v){ErrorModule.report(v,Language._("errors.sleep_load_alliance_towns"))}},L=function(){try{w.Character.homeTown.alliance_id===0?Ajax.remoteCall("fort_overview","",{},function(v){for(const C in v.js){const A=v.js[C],F=v.page.match(RegExp(`<div id="ownforts">[\\S\\s]+FortWindow.open\\(undefined, ${A[1]}, ${A[2]})\\)">(.+?)</a>[\\S\\s]+<div id="lastbattle">`));F&&o.push({fort_id:A[0],x:A[1],y:A[2],name:F[1]})}o.length>0&&w.setTimeout(function(){D()},Timer.getTimeout())}):Ajax.remoteCallMode("alliance","get_data",{alliance_id:w.Character.homeTown.alliance_id},function(v){if(v.error)return new UserMessage(v.error).show();o=v.data.forts,o.length>0&&w.setTimeout(function(){D()},Timer.getTimeout())})}catch(v){ErrorModule.report(v,Language._("errors.sleep_load_fort_data"))}},D=function(){try{if(0>=o.length)return;const v=o.pop(),C=v.fort_id;if(isDefined(r[C])||(r[C]={time:0,stage:0}),e.extend(r[C],{id:C,x:v.x,y:v.y,name:v.name}),r[C].stage!==5&&r[C].time+86400>Date.now()/1e3)return n.push(r[C]),o.length>0?w.setTimeout(function(){D()},Timer.getTimeout()):Cache.save("barracks",r),void 0;Ajax.remoteCallMode("fort_building_barracks","index",{fort_id:C},function(A){A.error?new UserMessage(A.error).show():(r[C].time=Math.floor(Date.now()/1e3),isDefined(A.barrackStage)&&(r[C].stage=A.barrackStage),r[C].stage!==5&&r[C].time+86400>Date.now()/1e3&&n.push(r[C]),o.length>0?w.setTimeout(function(){D()},Timer.getTimeout()):Cache.save("barracks",r))})}catch(v){ErrorModule.report(v,Language._("errors.sleep_process_fort_data"))}};return{}})($);Debugger.Sleep=Sleep;const Analyzer=(function(e){function t(B,p){let j,W;if(p){const M=(p+"").match(/\[report=([0-9]+)([A-Fa-f0-9]{10})\]/);j=M?M[1]:p}else j=0;const I=parseInt(j,10);switch(W=Number.isNaN(I)?0:I-1,B){case"job":a[B]={last:W,items:{last:0}};break;case"duel":a[B]={last:W};break;case"chest":a[B]={};break;case"all":a={ver:4},t("job",W+1),t("duel",W+1),t("chest",W+1)}}const n={};let a=null,o=null,r=!1,i=[];const c=[];let b=0;const u={currentWindowElement:null,progressBar:null,tableRows:[],tableFooter:null,tableBodyScrollpane:null};let g={order:1,sortByColumn:0,displayMode:"avg"},l={};n.extra=!1;const f=function(B,p=!1,j){p?t(B,j):(function(W){const I=e(`<div><h2>${Language._("analyzer.reset_confirm_title")}</h2><span style="font-size:12px"><br />${Language._("analyzer.reset_confirm_message")}</span></div>`),M=new west.gui.Textfield("twdb_analyzer_last").setSize(40);M.setLabel(Language._("analyzer.report_link_label")),I.append(M.getMainDiv());const U=new west.gui.Checkbox(Language._("analyzer.use_all_reports")+"&nbsp;&nbsp;"),O=new west.gui.Checkbox(""+Language._("analyzer.use_future_reports"));U.setCallback(function(E){E&&(O.setSelected(!1),M.setValue(""))}),O.setCallback(function(E){E&&(U.setSelected(!1),M.setValue(""))}),e(M.getMainDiv()).find("span").css("font-size","12px"),e(M.getMainDiv()).find("input").keyup(function(){U.setSelected(!1),O.setSelected(!1)}),I.append(e('<div style="display:block;" />').append(U.getMainDiv()).append(O.getMainDiv()));const R=new west.gui.Dialog(Language._("analyzer.reset_report_analyzer"),I);R.addButton(Language._("common.ok"),function(){U.isSelected()?t(W):O.isSelected()?t(W,a[W].last+1):t(W,M.getValue()),R.hide(),MessagesWindow.open("analyzer-"+W)}),R.addButton(Language._("common.cancel")),R.show()})(B)},d=function(B,p){p||(p=1),b=p,Ajax.remoteCall("reports","get_reports",{page:p,folder:B},function(j){_(B,j)})},_=function(B,p){let j=!0;typeof p.reports=="object"&&p.reports!==null||(p.reports=[],j=!1),p.page!==void 0&&b===p.page||(p.reports=[],j=!1);for(let W=0;W<p.reports.length;W++){const I=p.reports[W];if(I.report_id<=a[B].last){j=!1;break}i.push({id:I.report_id,hash:I.hash,type:B})}u.progressBar.setMaxValue(i.length),j?window.setTimeout(()=>d(B,b+1),Timer.getTimeout()):m(B)},m=function(B){i.length>0?(u.progressBar.setValue(u.progressBar.getValue()+1),h(i.pop())):(Cache.save("statistic",a),r=!1,v(B,!0))},h=function(B){e.post("game.php?window=reports&mode=show_report",{flash:null,hash:B.hash,report_id:B.id},function(p){k(B.type,p)},"json")},k=function(B,p){if(!p||!p.report_id||!p.publishHash)return new UserMessage(Language._("errors.empty_server_response"),UserMessage.TYPE_ERROR).show(),!1;if(typeof p.page!="string"||typeof p.title!="string"||typeof p.js!="string")c.push(p.report_id);else{switch(B){case"job":L(p);break;case"duel":D(p)}a[B].last=p.report_id}window.setTimeout(()=>m(B),Timer.getTimeout())},L=function(B){const p={id:null,hash:null,job:null,motivation:null,duration:null,wage:null,bond:null,experience:null,injury:0,killed:!1,date_received:null,items:{}};try{p.id=B.report_id,p.hash=B.publishHash;const j=Jobs.getJobByName(B.title.slice(B.title.indexOf(":")+1));if(!j)return c.push(p.id),!1;p.job=j.id,p.date_received=B.date_received;const W=e(B.page);W.find(".rp_row_jobdata").each(function(O){let R=e.trim(e(this).children("span:last-child").html());switch(R=R.split("&nbsp;").join(" "),O){case 0:p.motivation=parseInt(R.slice(0,R.indexOf(" ")),10);break;case 1:{const E=parseFloat(R);p.duration=E===1?3600:E===10?600:E===15?15:null,p.duration||ErrorModule.report({message:"Unrecognized time on report:"+R},"Job-Analyzer");break}case 2:p.wage=parseInt(R.slice(R.indexOf(" ")+1),10);break;case 3:p.bond=parseInt(R,10);break;case 4:p.experience=parseInt(R.slice(0,R.indexOf(" ")),10)}}),W.find(".rp_hurtmessage_text").each(function(){p.injury=+/[0-9]+/.exec(e(this).html())}),W.find(".rp_row_killmessage").each(function(){p.killed=!0});const I=B.js.split(";");e(I).each(function(){const O=/\s*ItemManager\.get\(([0-9]+)\)\s*\)\.setCount\(([0-9]+)\)/m.exec(this);O&&(p.items[+O[1]]=+O[2])}),a.job[p.job]||(a.job[p.job]={count:0,products:{}});const M=a.job[p.job];M.count++,M[p.motivation]||(M[p.motivation]={count:0,duration:0,wage:0,bond:0,experience:0,injury:{},killed:0,items:{},extraitems:{}});const U=M[p.motivation];isDefined(U.duration)||(U.duration=0),U.count++,U.duration+=p.duration,U.wage+=p.wage,U.bond+=p.bond,U.experience+=p.experience,U.injury[p.injury]||(U.injury[p.injury]=0),U.injury[p.injury]++,p.killed&&U.killed++;for(const O in p.items){const R=+O;R===138e3&&(isDefined(a.extra)||(a.extra={count:0},n.extra=!0),a.extra.count++,a.extra[a.extra.count]=p);const E=p.items[R],G=ItemManager.get(R);if(Jobs.isProduct(R)!==-1){M.products[R]||(M.products[R]={last:0});const P=M.products[R];for(let z=0;E>z;z++){const Q=M.count-P.last;P.last=M.count,P[Q]||(P[Q]=0),P[Q]++}}else G.price===0?(U.extraitems[R]||(U.extraitems[R]=0),U.extraitems[R]++):(U.items[R]||(U.items[R]=0),U.items[R]++)}}catch(j){return c.push(p.id),ErrorModule.report(j,Language._("errors.analyzer_parse_job_report")),!1}},D=function(B){},v=function(B,p){if(MessagesWindow.window)if(u.currentWindowElement=e(MessagesWindow.window.getContentPane()).find(".messages-analyzer-"+B),p===void 0)MessagesWindow.window.showLoader(),u.progressBar=new west.gui.Progressbar(0,i.length),u.currentWindowElement.children().remove(),u.currentWindowElement.append(u.progressBar.getMainDiv()),(function(j){r||(r=!0,i=[],b=0,d(j,1))})(B);else{let j;switch(u.currentWindowElement.children().remove(),B){case"job":j=F();break;case"duel":j=N()}u.currentWindowElement.append(j),C(),A(),C(),MessagesWindow.window.hideLoader()}},C=function(B){try{B!==void 0?g.sortByColumn===B?g.order*=-1:(g.order=1,g.sortByColumn=B):B=g.sortByColumn;const p=g.order,j=(W,I)=>{const M=e(W).find(".cell_"+B).html(),U=e(I).find(".cell_"+B).html();return+M===parseFloat(M)?parseFloat(M)>parseFloat(U)?p:-p:M>U?p:-p};u.tableRows.sort(j);for(let W=0;W<u.tableRows.length;W++)u.tableBodyScrollpane.appendContent(u.tableRows[W])}catch(p){ErrorModule.report(p,Language._("errors.analyzer_apply_table_sorting"))}},A=function(){g.displayMode=g.displayMode==="avg"?"sum":"avg",e(u.currentWindowElement).find("div.row div").each(function(B){const p=e(this),j=p.data(g.displayMode+""),W=p.data(g.displayMode+"-t");p.html(j).attr("title",W)})},F=function(){u.currentWindowElement.addClass("view-rewards"),g={order:1,sortByColumn:0,displayMode:"avg"};const B=e(`<div class="fancytable"><div class="_bg tw2gui_bg_tl"></div><div class="_bg tw2gui_bg_tr"></div><div class="_bg tw2gui_bg_bl"></div><div class="_bg tw2gui_bg_br"></div><div class="trows"><div class="thead statics"><div class="row row_head"><div class="cell_0 view-rewards view-items" style="width:91px; text-align:center;"><span title="${Language._("misc.name")}" style="cursor:pointer, margin-bottom:3px;"><img src="${Images.iconName}"/></span></div><div class="cell_1 view-rewards view-items" style="width:50px; text-align:center;"><span title="${Language._("misc.count")}"><img src="${Images.iconCount}"/></span></div><div class="cell_2 view-rewards view-items" style="width:50px; text-align:center;"><span title="${Language._("misc.duration")}"><img src="${Images.iconClock}"/></span></div><div class="cell_3 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("misc.experience")}"><img src="${Images.iconExperience}"/></span></div><div class="cell_4 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("misc.money")}"><img src="${Images.iconDollar}"/></span></div><div class="cell_5 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("misc.bonds")}"><img src="${Images.iconUpb}"/></span></div><div class="cell_6 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("misc.motivation")}"><img src="${Images.iconMoti}"/></span></div><div class="cell_7 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("misc.danger")}"><img src="${Images.iconDanger}"/></span></div><div class="cell_8 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("misc.killed")}"><img src="${Images.iconKilled}"/></span></div><div class="cell_9 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("misc.yield")}"><img src="${Images.iconYield}"/></span></div><div class="cell_9 view-items" style="width:63px; text-align:center;"><span title="${Language._("misc.yield")}"><img src="${Images.iconYield}"/></span></div><div class="cell_10 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("misc.items")}"><img src="${Images.iconItem}"/></span></div><div class="cell_10 view-items" style="width:378px; text-align:center;"><span title="${Language._("misc.items")}"><img src="${Images.iconItem}"/></span></div><div class="cell_11 view-rewards" style="width:41px; text-align:center;"><span title="${Language._("misc.luck")}"><img src="${Images.iconLuck}"/></span></div><div class="cell_reset view-rewards view-items" style="width:20px; text-align:right;"><span title="${Language._("misc.reset")}"><img src="${Images.iconReset}"/></span></div></div></div><div class="tbody"><div class="_bg tw2gui_bg_l"></div><div class="_bg tw2gui_bg_r"></div></div><div class="tfoot statics"><div class="row row_foot"></div></div></div>`);B.find(".row_head > div").each(function(){const W=e(this),I=W.attr("class").match(/cell_(\d+|reset)/),M=I?I[1]:null;var U;M==="reset"?W.click(function(){f("job")}):M!==null&&W.click((U=+M,()=>C(U)))}),B.find(".row_head").find("img").css("cursor","pointer");const p={jobs:0,count:0,duration:0,experience:0,wage:0,bond:0,motivation:0,injury:0,killed:0,products:0,items:0,luck:0},j=a.job;u.tableRows=[];for(const W in j){const I=Jobs.getJobById(W);if(!I)continue;const M={count:0,duration:0,experience:0,wage:0,bond:0,motivation:0,injury:0,killed:0,products:0,items:0,luck:0,all_products:{},all_items:{}},U=j[W];M.count=U.count;let O=0;if(Array.isArray(I.randomyields))for(let E=0;E<I.randomyields.length;E++)O+=I.randomyields[E];if(typeof I.yields=="object"&&I.yields!==null)for(const E in I.yields)O+=I.yields[E].prop;for(const E in U.products)if(E!=="last")for(const G in U.products[E]){const P=+U.products[E][G];M.products+=P;const z=ItemManager.get(E);z&&(M.luck+=+z.price*P),M.all_products[E]=(M.all_products[E]||0)+P}for(const E in U){if(E==="count"||E==="products")continue;const G=U[E];M.motivation+=+E*G.count,M.bond+=G.bond,M.duration+=G.duration||0,M.experience+=G.experience;for(const P in G.injury)M.injury+=+P*G.injury[P];for(const P in G.items){const z=+G.items[P];M.items+=z;const Q=ItemManager.get(P);Q&&(M.luck+=+Q.price*z),M.all_items[P]=(M.all_items[P]||0)+z}M.killed+=G.killed,M.wage+=G.wage}const R=e(`<div class="row row_${W}" />`);[{classes:"cell_0 view-rewards view-items",style:"width:91px; text-align:left;cursor:pointer;font-size:11px;",sum:I.name,sumT:I.name,avg:I.name,avgT:I.name},{classes:"cell_1 view-rewards view-items",style:"width:50px; text-align:center;cursor:pointer;",sum:M.count,sumT:M.count,avg:M.count,avgT:M.count},{classes:"cell_2 view-rewards view-items",style:"width:50px; text-align:center;cursor:pointer;",sum:round(M.duration/3600,2),sumT:`${round(M.duration/3600,2)+""} ${Language._("misc.hours_lowercase")}`,avg:round(M.duration/(3600*M.count),2),avgT:`&Oslash; ${round(M.duration/(3600*M.count),2)+""} ${Language._("misc.hours_lowercase")}`},{classes:"cell_3 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.experience,sumT:M.experience+"",avg:round(M.experience/M.count,2),avgT:"&Oslash; "+round(M.experience/M.count,2)},{classes:"cell_4 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.wage,sumT:"$"+M.wage,avg:round(M.wage/M.count,2),avgT:"&Oslash; $"+round(M.wage/M.count,2)},{classes:"cell_5 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.bond,sumT:M.bond+"",avg:round(M.bond/M.count*100,2),avgT:`&Oslash; ${round(M.bond/M.count*100,2)+""}%`},{classes:"cell_6 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.motivation,sumT:M.motivation+"%",avg:round(M.motivation/M.count,2),avgT:`&Oslash; ${round(M.motivation/M.count,2)+""}%`},{classes:"cell_7 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.injury,sumT:M.injury+"",avg:round(M.injury/M.count,2),avgT:"&Oslash; "+round(M.injury/M.count,2)},{classes:"cell_8 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.killed,sumT:M.killed+"",avg:round(M.killed/M.count*100,2),avgT:`&Oslash; ${round(M.killed/M.count*100,2)+""}%`},{classes:"cell_9 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.products,sumT:M.products+"",avg:round(M.products/M.count*100,2),avgT:`&Oslash; ${round(M.products/M.count*100,2)+""}% [${100*O}%]`},{classes:"cell_9 view-items",style:"width:63px; text-align:center;cursor:pointer;",sum:e.map(M.all_products,(E,G)=>{const P=ItemManager.get(G);return P?new tw2widget.Item(P).setCount(E).getMainDiv():null}).filter(E=>E!==null),avg:e.map(M.all_products,(E,G)=>{const P=ItemManager.get(G);return P?new tw2widget.Item(P).setCount(E).getMainDiv():null}).filter(E=>E!==null)},{classes:"cell_10 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.items,sumT:M.items+"",avg:round(M.items/M.count*100,2),avgT:`&Oslash; ${round(M.items/M.count*100,2)+""}%`},{classes:"cell_10 view-items",style:"width:390px; text-align:center;cursor:pointer;",sum:e.map(M.all_items,(E,G)=>{const P=ItemManager.get(G);return P?new tw2widget.Item(P).setCount(E).getMainDiv():null}).filter(E=>E!==null),avg:e.map(M.all_items,(E,G)=>{const P=ItemManager.get(G);return P?new tw2widget.Item(P).setCount(E).getMainDiv():null}).filter(E=>E!==null)},{classes:"cell_11 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.luck,sumT:"$"+M.luck,avg:round(M.luck/M.count,2),avgT:"&Oslash; $"+round(M.luck/M.count,2)}].forEach((E,G)=>{const P=e(`<div class="${E.classes}" style="${E.style}" ></div>`);P.data("sum",E.sum),P.data("sum-t",E.sumT),P.data("avg",E.avg),P.data("avg-t",E.avgT),typeof E.sum=="object"&&E.sum!==null&&P.append(E.sum),R.append(P)}),p.jobs++,p.count+=M.count,p.duration+=M.duration,p.experience+=M.experience,p.wage+=M.wage,p.bond+=M.bond,p.motivation+=M.motivation,p.injury+=M.injury,p.killed+=M.killed,p.products+=M.products,p.items+=M.items,p.luck+=M.luck,u.tableRows.push(R),R.click(function(){T(e(this).children(".cell_0").html())})}return u.tableBodyScrollpane=new west.gui.Scrollpane,e(u.tableBodyScrollpane.getMainDiv()).css("height","300px"),B.find(".tbody").append(u.tableBodyScrollpane.getMainDiv()),u.tableFooter=B.find(".row_foot"),[{classes:"cell_0",style:"width:71px; text-align:center;",sum:p.jobs,sumT:`${p.jobs} ${Language._("misc.jobs")}`,avg:p.jobs,avgT:`${p.jobs} ${Language._("misc.jobs")}`},{classes:"cell_0 view-rewards view-items",style:"width:87px; text-align:center;cursor:pointer;color:#444;",sum:"&sum;",sumT:Language._("analyzer.table_sum_tooltip"),avg:"&Oslash;",avgT:Language._("analyzer.table_avg_tooltip"),onClick:A,onMouseEnter:function(){e(this).css("color","#888")},onMouseLeave:function(){e(this).css("color","#444")}},{classes:"cell_1 view-rewards view-items",style:"width:50px; text-align:center;",sum:p.count,sumT:p.count,avg:p.count,avgT:p.count},{classes:"cell_2 view-rewards view-items",style:"width:50px; text-align:center;",sum:round(p.duration/3600,2),sumT:`${round(p.duration/3600,2)+""} ${Language._("misc.hours_lowercase")}`,avg:round(p.duration/(3600*p.count),2),avgT:`&Oslash; ${round(p.duration/(3600*p.count),2)+""} ${Language._("misc.hours_lowercase")}`},{classes:"cell_3 view-rewards",style:"width:50px; text-align:center;",sum:p.experience,sumT:p.experience+"",avg:round(p.experience/p.count,2),avgT:"&Oslash; "+round(p.experience/p.count,2)},{classes:"cell_4 view-rewards",style:"width:50px; text-align:center;",sum:p.wage,sumT:"$"+p.wage,avg:round(p.wage/p.count,2),avgT:"&Oslash; $"+round(p.wage/p.count,2)},{classes:"cell_5 view-rewards",style:"width:50px; text-align:center;",sum:p.bond,sumT:p.bond+"",avg:round(p.bond/p.count*100,2),avgT:`&Oslash; ${round(p.bond/p.count*100,2)+""}%`},{classes:"cell_6 view-rewards",style:"width:50px; text-align:center;",sum:p.motivation,sumT:p.motivation+"%",avg:round(p.motivation/p.count,2),avgT:`&Oslash; ${round(p.motivation/p.count,2)+""}%`},{classes:"cell_7 view-rewards",style:"width:50px; text-align:center;",sum:p.injury,sumT:p.injury+"",avg:round(p.injury/p.count,2),avgT:"&Oslash; "+round(p.injury/p.count,2)},{classes:"cell_8 view-rewards",style:"width:50px; text-align:center;",sum:p.killed,sumT:p.killed+"",avg:round(p.killed/p.count*100,2),avgT:`&Oslash; ${round(p.killed/p.count*100,2)+""}%`},{classes:"cell_9 view-rewards",style:"width:50px; text-align:center;",sum:p.products,sumT:p.products+"",avg:round(p.products/p.count*100,2),avgT:`&Oslash; ${round(p.products/p.count*100,2)+""}%`},{classes:"cell_9 view-items",style:"width:63px; text-align:center;",sum:p.products,sumT:p.products+"",avg:round(p.products/p.count*100,2),avgT:`&Oslash; ${round(p.products/p.count*100,2)+""}%`},{classes:"cell_10 view-rewards",style:"width:50px; text-align:center;",sum:p.items,sumT:p.items+"",avg:round(p.items/p.count*100,2),avgT:`&Oslash; ${round(p.items/p.count*100,2)+""}%`},{classes:"cell_10 view-items",style:"width:390px; text-align:center;",sum:p.items,sumT:p.items+"",avg:round(p.items/p.count*100,2),avgT:`&Oslash; ${round(p.items/p.count*100,2)+""}%`},{classes:"cell_11 view-rewards",style:"width:50px; text-align:center;",sum:p.luck,sumT:"$"+p.luck,avg:round(p.luck/p.count,2),avgT:"&Oslash; $"+round(p.luck/p.count,2)}].forEach(W=>{const I=e(`<div class="${W.classes}" style="${W.style}" ></div>`);I.data("sum",W.sum),I.data("sum-t",W.sumT),I.data("avg",W.avg),I.data("avg-t",W.avgT),W.onClick&&I.click(W.onClick),W.onMouseEnter&&I.on("mouseenter",W.onMouseEnter),W.onMouseLeave&&I.on("mouseleave",W.onMouseLeave),u.tableFooter.append(I)}),e('<div style="margin: 0px 6px 0px 6px;width:680px;" />').append(e(`<a href="#">${Language._("analyzer.toggle_rewards_items")}</a>`).css({marginTop:"-8px",display:"block",textAlign:"center"}).click(function(){e(".messages-analyzer-job").toggleClass("view-rewards view-items")})).append(B)},N=function(){return e("<div/>").text(Language._("analyzer.duel_coming_soon"))},T=function(B){},S=(function(B){return{add:function(p,j){let W=!1;for(let I=0;I<j.msg.effects.length;I+=1){const M=j.msg.effects[I];if(M.type==="lottery"||M.type==="content"){isDefined(a.chest[p.item_id])||(a.chest[p.item_id]={count:0,items:{}});const U=a.chest[p.item_id];W||(U.count++,W=!0),M.items.each(function(O){isDefined(U.items[O.item_id])||(U.items[O.item_id]=0),U.items[O.item_id]+=O.count})}else M.type==="learn_recipe"&&(TWDB.ClothCalc.recipes[M.recipe]=1)}Cache.save("statistic",a)},show:function(){if(!MessagesWindow.window)return;const p=B(MessagesWindow.window.getContentPane()).find(".messages-analyzer-chest");MessagesWindow.window.showLoader(),p.children().remove();const j=new west.gui.Scrollpane;B(j.getMainDiv()).css("height","385px"),p.append(j.getMainDiv());for(const W in a.chest){const I=a.chest[W],M=ItemManager.get(W);if(!M)continue;const U=new tw2widget.Item(M,"item_inventory").setCount(I.count);U.getImgEl().addClass("item_inventory_img"),j.appendContent(B('<div style="float:left;position:relative;height:61px;width:61px;" />').append(U.getMainDiv()));let O=0;const R=B('<div style="float:left;position:relative;width:610px;" />');for(const G in I.items){const P=ItemManager.get(G);if(!P)continue;O++;const z=new tw2widget.Item(P,"item_inventory").setCount(I.items[G]);z.getImgEl().addClass("item_inventory_img"),R.append(z.getMainDiv())}const E=61*Math.ceil(O/10)+"";j.appendContent(`<div style="float:left;position:relative;width:10px;height:${E}px;background: url(/images/window/report/devider_report.png) repeat-y;" />`).appendContent(R).appendContent('<div style="clear:both;position:relative;height:10px;display:block;background: url(/images/window/dailyactivity/wood_devider_horiz.png) repeat-x;" />')}MessagesWindow.window.hideLoader()}}})(e);return l=Loader.add("Analyzer","tw-db Job-Analyzer",function(){if(l.ready)return;TWDB.Util.addCss(".messages-analyzer-job .item img.tw_item{width:30px;height:27px}.messages-analyzer-job .item .count{bottom:-4px}.messages-analyzer-job .item span.usable{display:none}div.tw2gui_window .messages-analyzer-job div.fancytable .row>div{display:none;vertical-align:top}.messages-analyzer-job.view-rewards div.fancytable .row>div.view-rewards{display:inline-block}.messages-analyzer-job.view-items div.fancytable .row>div.view-items{display:inline-block}div.tw2gui_window .messages-analyzer-job div.fancytable div.trows div.tbody div.row{height:auto}");const B=Cache.load("statistic");switch(typeof B=="object"&&B!==null?a=B:f("all",!0),a&&a.ver||f("all",!0),a.ver){case 1:f("job",!0,1),f("duel",!0,1),a.ver=2;case 2:f("job",!0,1),f("duel",!0,1),a.ver=3;case 3:f("chest",!0,1),a.ver=4}o=e.extend(!0,{},a),GameInject.addTabOnMessagesWindow(Language._("analyzer.job_title"),"analyzer-job",function(){v("job")}),Settings.get("chest_analyzer",!0)&&(GameInject.ItemUse(S.add),GameInject.addTabOnMessagesWindow(Language._("analyzer.chest_title"),"analyzer-chest",S.show)),l.ready=!0},{Cache:!0,Settings:!0,Jobs:!0}),n.restore=function(){a=e.extend(!0,{},o),Cache.save("statistic",a);const B=MessagesWindow.getActiveTab();if(B?.startsWith("analyzer-")){const p=B.split("-")[1];v(p,!0)}},n.debug=function(){},n.getExtra=function(){return isDefined(a.extra)?a.extra:null},n})(jQuery);Debugger.Analyzer=Analyzer;const Notes=(function(e){let t=null,n={};n=Loader.add("Notes","tw-db Notes",function(){if(!n.ready)try{Settings.get("notes",!0)&&GameInject.addTabOnMessagesWindow(Language._("misc.notes_title"),"notes",function(){a()}),n.ready=!0}catch(i){ErrorModule.report(i,Language._("errors.notes_initialize"))}},{Cache:!0,Settings:!0});const a=function(){try{if(!w.MessagesWindow.window)return;t=e(w.MessagesWindow.window.getContentPane()).find(".messages-notes"),t.css("width","680px").css("margin","0 auto").css("position","relative").css("top","0"),r(Cache.load("notes"))}catch(i){ErrorModule.report(i,Language._("errors.notes_render_tab"))}},o=function(i){try{Cache.save("notes",i),new UserMessage(Language._("common.save_success"),UserMessage.TYPE_SUCCESS).show()}catch(c){ErrorModule.report(c,Language._("errors.notes_save"))}},r=function(i){try{t.children().remove();const c=new west.gui.Scrollpane;e(c.getMainDiv()).css("height","324px"),e(c.getMainDiv()).find(".tw2gui_scrollpane_clipper_contentpane").addClass("selectable"),t.append(e('<div style="margin:8px" />').append(c.getMainDiv())).append(e('<div style="margin-left:8px" />').append(new west.gui.Button(Language._("common.save").escapeHTML(),function(){o(i)}).getMainDiv()).append(new west.gui.Button(Language._("common.edit").escapeHTML(),function(){(function(b){try{t.children().remove(),w.MessagesWindow.window.showLoader();const u=new west.gui.Textarea().setWidth(660).setHeight(300).setContent(b);t.append(e('<div style="margin-left:8px" />').append(new west.gui.Bbcodes(u).getMainDiv())).append(u.getMainDiv()).append(e('<div style="margin-left:8px" />').append(new west.gui.Button(Language._("common.save").escapeHTML(),function(){o(u.getContent()),r(u.getContent())}).getMainDiv()).append(new west.gui.Button(Language._("common.preview").escapeHTML(),function(){r(u.getContent())}).getMainDiv())),w.MessagesWindow.window.hideLoader()}catch(u){ErrorModule.report(u,Language._("errors.notes_edit"))}})(i)}).getMainDiv())),i&&(w.MessagesWindow.window.showLoader(),Ajax.remoteCall("settings","get_parsed_text",{text:i},function(b){c.appendContent(w.Game.TextHandler.parse(b.parsed_text)),w.MessagesWindow.window.hideLoader()}))}catch(c){ErrorModule.report(c,Language._("errors.notes_display"))}};return{}})($);Debugger.Notes=Notes;const MapModule=(function(e){const t={};let n=0,a=0,o={},r=null,i=null,c={};c=Loader.add("Map","tw-db Map",function(){if(!c.ready)try{Settings.get("coordinates_input",!0)&&b(),Ajax.get("map","get_minimap",{},function(u){if(u.error)return c.failed=!0,new UserMessage(u.msg).show();o=u.job_groups,c.ready=!0})}catch(u){ErrorModule.report(u,Language._("errors.map_initialize"))}},{Settings:!0}),t.getNearestJob=function(u){try{const g=JobList.getJobById(u),l=o[g.groupid];if(!l)return[];const f=[],d=t.getLastPosition();for(let m=0;m<l.length;m++){const h=l[m][0]-d.x,k=l[m][1]-d.y,L=Math.sqrt(h*h+k*k),D=window.GameMap.calcWayTime({x:l[m][0],y:l[m][1]},d);let v=round(180*Math.atan(k/h)/Math.PI);0>h&&(v-=180),f.push({dist:L,time:D,x:l[m][0],y:l[m][1],angle:v})}const _=function(m,h){return 1*m.dist>1*h.dist?1:-1};return f.sort(_),f}catch(g){return ErrorModule.report(g,Language._("errors.map_get_nearest_job")),[]}},t.getLastPosition=function(){const u={x:Character.position.x,y:Character.position.y},g=TaskQueue.queue;for(let l=0;l<g.length;l++){const f=g[l].wayData;f.x&&(u.x=f.x,u.y=f.y)}return u},t.setMinimapJob=function(u){try{r&&(window.clearInterval(i),window.clearInterval(r));const g=function(l){if(!MinimapWindow.window)return;const f=e(MinimapWindow.window.divMain).find(".tw2gui_jobsearch_string");f.length!==0&&f.is(":visible")&&(window.clearInterval(r),window.clearInterval(i),r=null,i=null,MinimapWindow.resetSearchContext(),e("input.tw2gui_jobsearch_string",MinimapWindow.DOM).val(l).keyup())};i=setInterval(function(){window.clearInterval(r),window.clearInterval(i),r=null,i=null},3e5),r=setInterval(function(){g(u)},200)}catch(g){ErrorModule.report(g,Language._("errors.map_set_minimap_job"))}},t.loadMap=function(){(function(){try{let u=!1,g=0;const l=[];for(let f=n;181>=f;f++){for(let d=a;79>=d;d++)if(g++,l.push([f,d]),g>299){u=!0;break}if(u)break;a=0}n=x,a=y+1,l.length>0&&window.GameMap.Data.Loader.load(l,function(){setTimeout(function(){t.loadMap()},Timer.getTimeout())})}catch(u){ErrorModule.report(u,Language._("errors.map_scan_coordinates"))}})()};const b=function(){try{TWDB.Util.addCss("div#mmap_twdb_coords{position:absolute;bottom:35px;left:1px;display:block}div#mmap_twdb_coords>img{cursor:pointer;opacity:0.5;position:relative}","minimap");const u=function(){const g=e('<div id="mmap_twdb_coords" />'),l=new west.gui.Textfield,f=new west.gui.Textfield;let d="",_="";l.setWidth(45),f.setWidth(45).setMaxLength(5);const m=function(){const L=+l.getValue(),D=+f.getValue();window.GameMap.center(L,D),l.setValue(""),f.setValue("")};e(l.getMainDiv()).find("input").keyup(function(L){window.setTimeout(function(){let D;if(L.ctrlKey&&L.keyCode===86&&!L.altKey){if(D=/^([0-9]{1,5})([^0-9]+)([0-9]{1,5})$/.exec(e.trim(l.getValue())),D)return l.setValue(D[1]),f.setValue(D[3]),e(f.getMainDiv()).find("input").focus(),d=l.getValue(),_=f.getValue(),void 0;if(D=/^([0-9]{1,5})$/.exec(e.trim(l.getValue())),D)return l.setValue(D[1]),e(f.getMainDiv()).find("input").focus(),d=l.getValue(),void 0;l.setValue(d)}return L.keyCode===13?m():(e.trim(l.getValue())+"").length===0?(d=l.getValue(),void 0):(D=/^([0-9]{1,5})$/.exec(e.trim(l.getValue())),D?(l.setValue(D[1]),(D[1]+"").length===5&&e(f.getMainDiv()).find("input").focus(),d=l.getValue(),void 0):(l.setValue(d),void 0))},100)}),e(f.getMainDiv()).find("input").keyup(function(L){window.setTimeout(function(){if(L.ctrlKey&&L.keyCode===86&&!L.altKey){const v=/^([0-9]{1,5})$/.exec(e.trim(f.getValue()));if(v)return f.setValue(v[1]),e(f.getMainDiv()).find("input").focus(),_=f.getValue(),void 0;f.setValue(_)}if(L.keyCode===13)return m(),void 0;if((e.trim(f.getValue())+"").length===0)return _=f.getValue(),void 0;const D=/^([0-9]{1,5})$/.exec(e.trim(f.getValue()));if(D)return f.setValue(D[1]),(D[1]+"").length===5&&e(f.getMainDiv()).find("input").focus(),_=f.getValue(),void 0;f.setValue(_)},100)});const h=new west.gui.Button(Language._("common.ok"),function(){m()},null,null,Language._("map.coordinates_button")).setWidth("48"),k=e(`<img title="${Language._("map.coordinates_tooltip")}" src="${Images.iconCount}" />`).click(function(){e(this).css("opacity")===1?(e(this).css("opacity","0.5"),window.GameMap.hideCoords()):(e(this).css("opacity","1"),window.GameMap.showCoords())});g.append(k,l.getMainDiv(),"<span>|</span>",f.getMainDiv(),e(h.getMainDiv()).css("top","6px")),e(".minimap-right",MinimapWindow.window.divMain).append(g)};GameInject.injectMinimap(function(){u()})}catch(u){ErrorModule.report(u,Language._("errors.map_initialize_coordinates"))}};return t})($);_base.Map=MapModule,Debugger.Map=MapModule;const BonusJobs=(function(e){let t,n={},a={gold:!1,silver:!1};initializeBonusJobs=function(){if(!n.ready)try{if(!Settings.get("bonus_jobs",!0))return n.ready=!0,void 0;let g,l,f,d;const _=get_server_date(),m=1,h=new Date;h.setUTCHours(m),h.setMinutes(15),h.setSeconds(0),h.setMilliseconds(0);let k=h.getTime();for(g in(_.getUTCHours()<m||_.getUTCHours()===m&&15>_.getMinutes())&&(k-=864e5),t=Cache.load("bonusjobs")||{},a=Cache.load("bonusdisplay")||{gold:!1,silver:!1},t)if(Object.hasOwn(t,g)){for(d in l=t[g],f=0,l)Object.hasOwn(l,d)&&(l[d].gold||l[d].time>k?f++:delete l[d]);f===0&&delete t[g]}r(),o(),n.ready=!0}catch(g){ErrorModule.report(g,Language._("errors.bonusjobs_initialize"))}},n=Loader.add("BonusJobs","tw-db BonusJobs",initializeBonusJobs,{Settings:!0,Cache:!0,Jobs:!0});const o=function(){try{const g=function(l){const f=window.GameMap.Helper.getPosition(l.parent);if(!isDefined(f)||!isDefined(f.x)||!isDefined(f.y))return;if(!isDefined(window.GameMap.JobHandler.Featured[`${f.x}-${f.y}`]))return isDefined(t[`${f.x}-${f.y}`])&&(delete t[`${f.x}-${f.y}`],Cache.save("bonusjobs",t)),void 0;const d=window.GameMap.JobHandler.Featured[`${f.x}-${f.y}`];let _;for(_ in t[`${f.x}-${f.y}`]={},d)Object.hasOwn(d,_)&&(t[`${f.x}-${f.y}`][_]=d[_],t[`${f.x}-${f.y}`][_].time=Date.now());Cache.save("bonusjobs",t)};GameInject.injectRadialmenu(function(l){g(l)})}catch(g){ErrorModule.report(g,Language._("errors.bonusjobs_process_data"))}},r=function(){try{TWDB.Util.addCss('div#mmap_twdb_bonusjobs{position:absolute;top:40px;right:10px}div#mmap_twdb_bonusjobs>input[type="checkbox"]{margin-left:6px;cursor:pointer}div#mmap_twdb_bonusjobs>div{position:relative;display:inline-block;height:9px;width:9px;margin:1px}div#mmap_twdb_bonusjobs>img{margin-left:3px;cursor:pointer;position:relative;display:inline-block;height:16px;width:16px;top:-4px}',"minimap");const g=function(){const l=e('<div id="mmap_twdb_bonusjobs" />').append(e(`<input title="${Language._("jobs.show_gold_jobs")}" type="checkbox" ${a.gold?'checked="checked"':""} />`).change(function(){a.gold=e(this).is(":checked"),i()})).append(`<div title="${Language._("jobs.gold_jobs")}" style="background-color:yellow; border:1px solid red;" />`).append(e(`<input title="${Language._("jobs.show_silver_jobs")}" type="checkbox" ${a.silver?'checked="checked"':""}" />`).change(function(){a.silver=e(this).is(":checked"),i()})).append(`<div title="${Language._("jobs.silver_jobs")}" style="background-color:white; border:1px solid black;" />`).append(e(`<img title="${Language._("misc.export")} - ${Language._("jobs.with_bonus")}" src="${Images.iconExport}" />`).click(function(){c()})).append(e(`<img title="${Language._("misc.import")} - ${Language._("jobs.with_bonus")}" src="${Images.iconImport}" />`).click(function(){b()})).append(e(`<img title="${Language._("misc.reset")} - ${Language._("jobs.with_bonus")}" src="${Images.iconReset2}" />`).click(function(){u()}));e(MinimapWindow.window.divMain).find(".minimap-right").append(l),i()};GameInject.injectMinimap(function(){g()})}catch(g){ErrorModule.report(g,Language._("errors.bonusjobs_render_markers"))}},i=function(){try{Cache.save("bonusdisplay",a),e("#minimap_worldmap > div.TWDBbonusjob",MinimapWindow.window.divMain).remove();const g=function(f,d,_,m,h){let L="";m>1&&(L="-moz-transform:rotate(45deg);-webkit-transform:rotate(45deg);-o-transform:rotate(45deg);-ms-transform:rotate(45deg);transform:rotate(45deg);");const D=e(`<div class="TWDBbonusjob" style="z-index:7;position:absolute;display:block;width:4px;height:4px;background-color:${_?"yellow":"white"};left:${parseInt(f*.00513,10)-3}px;top:${parseInt(d*.00513,10)+2}px;${L}border:1px solid ${_?"red":"black"};" />`).click((function(v,C){return function(){window.GameMap.center(v,C)}})(f,d)).addMousePopup(`<div style="min-width:60px;text-align:center">${h.join('<div class="marker_popup_divider"></div>')}</div>`);e(MinimapWindow.window.divMain).find("#minimap_worldmap").append(D)},l=t;for(const f in l){if(!Object.hasOwn(l,f))continue;const d=l[f];let _=!1,m=0;const h=[];for(const k in d)if(Object.hasOwn(d,k)){if(d[k].gold){if(!a.gold)continue;_=!0,m++}if(d[k].silver){if(!a.silver)continue;m++}h.push(Jobs.getPopup(d[k].job_id,d[k].gold?"gold":"silver"))}if(m>0){const k=d[Object.keys(d)[0]];g(k.x,k.y,_,m,h)}}}catch(g){ErrorModule.report(g,Language._("errors.bonusjobs_save_display_settings"))}},c=function(){try{const g=[];for(const h in t){if(!Object.hasOwn(t,h))continue;const k=t[h];for(const L in k){if(!Object.hasOwn(k,L))continue;const D=Jobs.getJobById(L),v=Math.ceil(k[L].x/6635)+(k[L].y>10176?7:0);g.push({name:D.name,bonus:k[L].gold?"gold":"silver",country:v,x:k[L].x,y:k[L].y,id:L})}}const l=e("<textarea />").css({width:"500px",height:"200px","background-color":"transparent","border-width":"0px"}).click(function(){this.select()});let f="",d=1;const _=function(h){f!==h?(f=h,d=1):d*=-1,g.sort(function(D,v){return D[f]>v[f]?d:-1*d});let k="",L="";for(let D=0;D<g.length;D++){const v=g[D];f==="country"&&L!==v.country&&(L=v.country,k+=`-- ${Language._("misc.country")} ${L} -- <br />`),k+=`${v.name}; ${v.bonus}; ${v.x}-${v.y}; ${v.id}<br />`}l.val(k)};_("name");const m=e("<div />").css({width:"500px",height:"22px",position:"relative",display:"block"}).append(e(`<img src="${Images.iconName}" title="${Language._("misc.sort_by")} ${Language._("misc.name")}" style="margin:0px 2px 0px 2px;cursor:pointer;" /> `).click(function(){_("name")})).append(e(`<img src="${Images.iconCount}" title="${Language._("misc.sort_by")} ${Language._("misc.country")}" style="margin:0px 2px 0px 2px;cursor:pointer;" /> `).click(function(){_("country")}));new west.gui.Dialog(`${Language._("misc.export")} - ${Language._("jobs.with_bonus")}`,e("<div />").append(m).append(l)).addButton(Language._("common.ok")).show()}catch(g){ErrorModule.report(g,Language._("errors.bonusjobs_export"))}},b=function(){try{const g=e("<textarea />").css({width:"400px",height:"100px"}),l=function(){const f=g.val().split(/[\n,\r,\r\n]/);let d,_,m,h,k,L;for(d=0;d<f.length;d++)_=f[d].split(";",4),_.length===4&&e.isNumeric(_[3])&&Jobs.getJobById(+_[3])&&(m=(_[2]+"").split("-",2),m.length===2&&e.isNumeric(m[0])&&e.isNumeric(m[1])&&(h=+_[3],k={gold:e.trim(_[1])==="gold",group_id:Jobs.getJobById(h).groupid,job_id:h,silver:e.trim(_[1])!=="gold",x:+m[0],y:+m[1],time:Date.now()},L=`${+m[0]}-${+m[1]}`,isDefined(t[L])||(t[L]={}),t[L][h]=k));Cache.save("bonusjobs",t),i()};new west.gui.Dialog(`${Language._("misc.import")} - ${Language._("jobs.with_bonus")}`,g).addButton(Language._("common.ok"),l).addButton(Language._("common.cancel")).show()}catch(g){ErrorModule.report(g,Language._("errors.bonusjobs_import"))}},u=function(g){try{if(g){for(const l in t){if(!Object.hasOwn(t,l))continue;const f=t[l];let d=0;for(const _ in f)Object.hasOwn(f,_)&&(g==="gold"&&f[_].gold||g==="silver"&&f[_].silver?d++:delete f[_]);d===0&&delete t[l]}Cache.save("bonusjobs",t),i(),new UserMessage(`${Language._("misc.reset")} - ${Language._("jobs.with_bonus")}`,UserMessage.TYPE_SUCCESS).show()}else{const l=`${Language._("misc.reset")} - ${Language._("jobs.with_bonus")}`,f=`<div class="txcenter">${Language._("jobs.reset_jobs_bonus_confirm")}</div>`;new west.gui.Dialog(l,f,west.gui.Dialog.SYS_QUESTION).addButton(Language._("jobs.reset_all_jobs_bonus"),function(){u("all")}).addButton(Language._("jobs.reset_silver_jobs_bonus"),function(){u("silver")}).addButton(Language._("jobs.reset_gold_jobs_bonus"),function(){u("gold")}).addButton(Language._("common.cancel")).show()}}catch(l){ErrorModule.report(l,Language._("errors.bonusjobs_reset"))}};return{}})($);Debugger.BonusJobs=BonusJobs;const Chat=(function(e){const t={":/":"sore","=:)":"invader",">:(":"angry",":'(":"cry",":)":"smile",":D":"grin",":(":"frown",";)":"smirk",":P":"tongue",":o":"ohmy",":x":"muted",":|":"silent",">.<":"palm","-.-":"nc","o.O":"oo","O.o":"oo","^_^":"happy",o_O:"oo","x.x":"xx","T.T":"cry","el pollo diablo!":"elpollodiablo","!el pollo diablo":"elpollodiablo_mirror","el pollo diablo?!":"elpollodiablo_front","add me":"sheep.gif","add me!":"sheep_rainbow.gif"};let n=[],a={};a=Loader.add("Chat","tw-db Chat Enhancement",function(){if(!a.ready)try{if(Settings.get("chat",!0)){GameInject.ChatLayout(function(_){r(_)}),GameInject.ChatSend(function(_){o(_)});let d=Cache.load("chathistory");typeof d=="object"&&d!==null&&(d.color&&(d=d.color,Cache.save("chathistory",d)),n=d),$("div.tw2gui_window.chat.nominimize div.tw2gui_window_buttons_close").click().length>0&&ChatWindow.open()}a.ready=!0}catch(d){ErrorModule.report(d,Language._("errors.chat_initialize"))}},{Settings:!0,Cache:!0});const o=function(d){try{let _=d.input.val();if(!_)return;const m=function(h){return d.u&&(h=h.toUpperCase()),d.p&&(h=`*${h=h.replace(/\*/g,"~")}*`),h};if(_.substr(0,1)==="/"){const h=/^\/(tell|msg)\s+([^:]+):(.+)$/,k=_.match(h);return k&&(_=d._?`/tell ${k[2]}:/${d._}${m(k[3])}`:`/tell ${k[2]}:${m(k[3])}`),d.input.val(_),void 0}return _=m(_),d._&&(_=`/${d._}${_}`),d.input.val(_),void 0}catch(_){ErrorModule.report(_,Language._("errors.chat_process_send"))}},r=function(d){try{d.mainDiv.find(".TWDBchat").length===0&&(d.mainDiv.find(".chat_input").find(".cbg").css("left","38px").addClass(".TWDBchat"),d._=null,d.p=!1,d.u=!1,i(d),l(d))}catch(_){ErrorModule.report(_,Language._("errors.chat_process_layout"))}},i=function(d){try{let _;const m=e('<span style="padding:3px;display:none;width:160px;position:absolute;bottom:20px;left:-3px;" />');for(const k in t)_=t[k].indexOf(".gif")===-1?t[k]+".png":t[k],m.append(e(`<img src="${Game.cdnURL}/images/chat/emoticons/${_}?1" title="${k}" style="cursor:pointer;margin:1px;" />`).click((function(L){return function(){d.input.val(`${d.input.val()} ${L} `),d.input.focus(),m.hide()}})(k)));let h=!1;d.mainDiv.find(".chat_input").append(e('<div style="position:absolute;width:15px;height:15px;bottom:7px;vertical-align:top;left:23px;cursor:pointer;" />').append(e(`<img style="vertical-align:top;" src="${Images.iconChatSM}" />`)).append(m).on("mouseenter",function(){h=!0,m.show()}).on("mouseleave",function(){h=!1,setTimeout(function(){h||m.hide()},200)}))}catch(_){ErrorModule.report(_,Language._("errors.chat_render_emoticon_picker"))}},c=function(d){try{const _=d.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return _?parseInt(9*_[1]/255+.5,10)+""+parseInt(9*_[2]/255+.5,10)+parseInt(9*_[3]/255+.5,10):"000"}catch(_){return ErrorModule.report(_,Language._("errors.chat_convert_rgb_to_game_color")),"000"}},b=function(d){try{return`rgb(${parseInt(255*d[0]/9,10)},${parseInt(255*d[1]/9,10)},${parseInt(255*d[2]/9,10)})`}catch(_){return ErrorModule.report(_,Language._("errors.chat_convert_game_color_to_rgb")),"rgb(0,0,0)"}},u=function(d,_){try{if(isDefined(_.color)){const m=c(_.color),h=n.length;for(let k=0;h>k;k++){const L=n.shift();L!==m&&n.push(L)}n.push(m),n.length>5&&n.shift(),Cache.save("chathistory",n),d._=m}_.color===null&&(d._=null),isDefined(_.bold)&&(d.p=_.bold),isDefined(_.caps)&&(d.u=_.caps),d.p?d.mainDiv.find(".TWDBtext").css("font-weight","bold"):d.mainDiv.find(".TWDBtext").css("font-weight","normal"),d.u?d.mainDiv.find(".TWDBtext").html("A"):d.mainDiv.find(".TWDBtext").html("a"),d._?(d.mainDiv.find(".TWDBcolor").children("div").children("div").css("background-color",b(d._)),4>d._[1]?d.mainDiv.find(".TWDBtext").css("color","#fff"):d.mainDiv.find(".TWDBtext").css("color","#000")):(d.mainDiv.find(".TWDBcolor").children("div").children("div").css("background-color","#e0e2e0"),d.mainDiv.find(".TWDBtext").css("color","#000")),d.input.focus()}catch(m){ErrorModule.report(m,Language._("errors.chat_apply_formatting"))}},g=function(d){try{const _=e('<div style="position:absolute;display:block;width:15px;height:15px;"></div>'),m=[{w:15,h:1,t:7,l:0,o:.1},{w:1,h:15,t:0,l:7,o:.1},{w:15,h:3,t:6,l:0,o:.33},{w:3,h:15,t:0,l:6,o:.33},{w:15,h:5,t:5,l:0,o:.47},{w:5,h:15,t:0,l:5,o:.47},{w:13,h:9,t:3,l:1,o:.6},{w:9,h:13,t:1,l:3,o:.6},{w:11,h:11,t:2,l:2,o:.8},{w:13,h:7,t:4,l:1},{w:7,h:13,t:1,l:4},{w:9,h:11,t:2,l:3},{w:11,h:9,t:3,l:2}];for(let h=0;h<m.length;h++){const k=m[h],L=`position:absolute; width:${k.w}px; height:${k.h}px; top:${k.t}px; left:${k.l}px; background-color:${d};${k.o!=null?`opacity:${k.o};`:""}`;_.append(e(`<div style="${L}"></div>`))}return _}catch(_){return ErrorModule.report(_,Language._("errors.chat_create_color_picker_layer")),e()}},l=function(d){try{let L=function(T,S){T.css("opacity",S?1:.5)},D=function(T,S){return e('<div style="display:inline-block;width:15px;height:15px;padding:2px;opacity:0.5;"/>').append(g("#e0e2e0")).append(e(`<div style="position:absolute;width:15px;height:15px;"><table border="0" cellspacing="0" cellpadding="0" style="padding:0;margin:0;border:0;"><tr><td style="display:block;width:15px;height:15px;text-align:center;font-size:11px;color:#000;${S==="bold"?"font-weight:bold;":""}">${T}</td></tr></table></div>`)).click(function(){const B=!d.format[S];d.format[S]=B,u(d,{[S]:B}),L(e(this),B),C.hide()})},v=function(T){return e('<div style="display:inline-block;width:15px;height:15px;padding:2px;"/>').append(g(T)).click(function(){u(d,{color:e(this).children("div").children("div").css("background-color")}),C.hide()})};var _=L,m=D,h=v;const k=["black","red","blue","yellow","green","brown","magenta","gray"];d.format=d.format||{};const C=e('<span style="position:absolute;display:none;padding:3px;width:300px;bottom:17px;left:-5px;" />');C.append('<div style="position:absolute;height:50px;width:25px;display:block" />');const A=D("a","bold"),F=D("A","caps");C.append(A),C.append(F);for(let T=0;T<k.length;T++)C.append(v(k[T]));C.append(e(`<div style="margin:2px;display:inline-block;width:15px;height:15px;background:url(${Images.iconChatNoColor}) no-repeat 0 0 transparent;" />`).click(function(){u(d,{color:null}),d.format.bold=!1,d.format.caps=!1,u(d,{bold:!1,caps:!1}),L(A,!1),L(F,!1),C.hide()})),C.append(e(`<div style="margin:3px;display:inline-block;width:13px;height:13px;background:url(${Images.iconChat}) no-repeat 0 0 transparent;" />`).click(function(){f(d),C.hide()}));let N=!1;d.mainDiv.find(".chat_input").append(e('<div class="TWDBcolor" style="position:absolute;width:15px;height:15px;bottom:7px;left:5px;cursor:pointer;" />').append(g("#e0e2e0")).append(e('<div style="position:absolute;width:15px;height:15px;"><table border="0" cellspacing="0" cellpadding="0" style="padding:0;margin:0;border:0;"><tr><td class="TWDBtext" style="display:block;width:15px;height:15px;text-align:center;font-size:11px;color:#000;">a</td></tr></table></div>')).append(C).on("mouseenter",function(){N=!0,L(A,!!d.format.bold),L(F,!!d.format.caps),C.show()}).on("mouseleave",function(){N=!1,setTimeout(function(){N||C.hide()},200)}))}catch(k){ErrorModule.report(k,Language._("errors.chat_render_color_picker"))}},f=function(d){try{const _=d.mainDiv.find(".TWDBcolor").children("div").children("div");let m=c(_.css("background-color"));const h={};h.customColor=e('<div style="width:50px;height:50px;display:inline-block;vertical-align:top;margin: 5px;" />'),h.customColor.css("background-color",b(c(_.css("background-color"))));const k=(T,S)=>{if(S&&m[T]===9||!S&&m[T]===0)return;const B=[+m[0],+m[1],+m[2]];B[T]+=S?1:-1,m=B[0]+""+B[1]+B[2],h.input.val(m),h.plusminus[T].children(".butMinus").css("opacity",m[T]===0?.3:1),h.plusminus[T].children(".butPlus").css("opacity",m[T]===9?.3:1),h.customColor.css("background-color",b(m))},L=e('<div style="width:42px;height:48px;display:inline-block;vertical-align:top;margin: 6px 5px 6px 5px;" />');h.plusminus=[];for(let T=0;3>T;T++){let S;switch(T){case 0:S="#f00";break;case 1:S="#0f0";break;case 2:S="#00f"}h.plusminus[T]=e(`<div class="tw2gui_plusminus" style="display:inline-block;background-color:${S};width:12px;height:46px;padding:1px;"><span class="butPlus" style="cursor:pointer;"></span><span style="width:12px;height:10px;display:inline-block;"></span><span class="butMinus" style="cursor:pointer;"></span></div>`),h.plusminus[T].children(".butMinus").click((B=>()=>k(B,!1))(T)),h.plusminus[T].children(".butPlus").click((B=>()=>k(B,!0))(T)),m[T]===0&&h.plusminus[T].children(".butMinus").css("opacity",.3),m[T]===9&&h.plusminus[T].children(".butPlus").css("opacity",.3),L.append(h.plusminus[T])}h.input=e(`<input maxLength="3" type="text" value="${m}" style="position: relative; top: -35px; left: 2px;color: rgb(255, 255, 255); font-weight: bold; letter-spacing: 6px; text-shadow: 1px 1px 1px rgb(0, 0, 0); width: 43px; background: none repeat scroll 0pt 0pt transparent; border: medium none; height: 18px; line-height: 18px; margin: 0pt; outline: medium none;" />`),h.input.keyup(()=>{const T=h.input.val();if(3>T.length||!T.match(/(\d){3}/))return h.input.val(m),void 0;m=T;for(let S=0;3>S;S++)h.plusminus[S].children(".butMinus").css("opacity",m[S]===0?.3:1),h.plusminus[S].children(".butPlus").css("opacity",m[S]===9?.3:1);h.customColor.css("background-color",b(m)),h.input.attr("value",m)}),L.append(h.input);const D={bold:d.p,caps:d.u},v=e('<div style="height:50px;display:inline-block;vertical-align:top;margin: 5px;" />'),C=new west.gui.Checkbox(`*${Language._("misc.color_dialog_bold")}*`,D.bold?"tw2gui_checkbox_checked":"",()=>{D.bold=!D.bold});e(C.getMainDiv()).css("display","block").css("margin-bottom","5px"),v.append(C.getMainDiv());const A=new west.gui.Checkbox(Language._("misc.color_dialog_caps"),D.caps?"tw2gui_checkbox_checked":"",()=>{D.caps=!D.caps});v.append(A.getMainDiv());const F=e('<div style="width:160px;height:50px;display:inline-block;vertical-align:top;border: 1px solid #000;padding: 0px;margin: 5px;" />');F.append(`<span style="width:140px;height:15px;display:inline-block;text-align:center;padding: 4px 0px 2px 0px;font-size:11px;">${Language._("misc.color_dialog_history")}</span>`);for(let T=0;T<n.length;T++){const S=e(`<div style="width:20px;height:20px;display:inline-block;vertical-align:top;margin: 0px 0px 0px 10px;cursor:pointer;background-color:${b(n[T])};" />`);S.click(function(){u(d,{color:e(this).css("background-color"),bold:D.bold,caps:D.caps}),h.colorBox.hide()}),F.append(S)}const N=e("<div />").append(h.customColor).append(L).append(v).append(F);h.colorBox=new west.gui.Dialog(Language._("misc.color_dialog_title"),N),h.colorBox.addButton(Language._("common.ok"),()=>{u(d,{color:e(h.customColor).css("background-color"),bold:D.bold,caps:D.caps})}),h.colorBox.addButton(Language._("common.cancel")),h.colorBox.show()}catch(_){ErrorModule.report(_,Language._("errors.chat_open_color_picker_dialog"))}};return{}})(jQuery);Debugger.Chat=Chat;const Collector=(function(e){const t={};let n={};n=Loader.add("Collector","tw-db Collector",function(){if(!n.ready)try{GameInject.patchItemWidget(),Settings.get("collector",!0)&&(GameInject.injectItem("Trader","collector",function(r){return a(r)}),GameInject.injectTrader("collector",function(r){return t.isNewItem(r.item_id)?`<img src="${Images.iconNew}" class="TWDBcollector" title="${Language._("collector.item_not_owned")}" style="position:absolute;top:0;left:0;padding:0;border:0;margin:0" />`:""}),GameInject.injectMarket("collector",function(r){return o(r)}),GameInject.injectGetBids()),n.ready=!0}catch(r){ErrorModule.report(r,Language._("errors.collector_initialize"))}},{Settings:!0}),t.isNewItem=function(r){try{const i=w.ItemManager.get(r);if(!i)return!1;const c=w.Bag.getItemsIdsByBaseItemId(i.item_base_id),b=w.Wear.wear[i.type],u=b?.obj?.item_base_id===i.item_base_id,g=TWDB.ClothCalc.bids[i.item_id],l=TWDB.ClothCalc.recipes[i.item_id];return!(c.length||u||g||l)}catch(i){return ErrorModule.report(i,Language._("errors.collector_check_new_item")),!1}};const a=function(r){try{if(r.divMain.find(".TWDBcollector").remove(),t.isNewItem(r.obj.item_id)){if(!Images.iconNew)return waitForImages("iconNew",function(){a(r)}),void 0;r.divMain.append(`<img src="${Images.iconNew}" class="TWDBcollector" title="${Language._("collector.item_not_owned")}" style="position:absolute;top:-8px;left:-15px;padding:0;border:0;margin:0" />`)}}catch(i){ErrorModule.report(i,Language._("errors.collector_update_item_display"))}},o=function(r){try{return t.isNewItem(r)?`<img src="${Images.iconNew}" class="TWDBcollector" title="${Language._("collector.item_not_owned")}" style="width:18px;height:18px;position:relative;top:0;left:0;padding:0;border:0;margin:0" />`:""}catch(i){return ErrorModule.report(i,Language._("errors.collector_get_market_icon")),""}};return t})();Debugger.Collector=Collector;const Snippets=(function($){const _self={},_timeout=null,_interval=null;let loader={};const initializeSnippets=function(){if(!loader.ready)try{trustTWDB(),Settings.get("translation_texts",!0)&&localizeSearchPlaceholders(),Settings.get("button_church",!0)&&GameInject.MenuButton(TWDB.images.buttonChurch,Language._("misc.button_church_title"),addConstructionButton),Settings.get("button_market",!1)&&GameInject.MenuButton(TWDB.images.buttonMarket,Language._("misc.button_market_title"),addMarketButton),Settings.get("wear_close",!0)&&addCloseAllWearButton(),Settings.get("collector_sell",!0)&&GameInject.injectWanderingTraderSellDialog(),Settings.get("custom_event_counter",!0)&&repositionEventCounters(),Settings.get("scrollbars_off",!1)&&disableScrollbars(),Settings.get("building_progress",!0)&&townBuildingProgress(),Settings.get("church_levels",!0)&&addChurchLevels(),Settings.get("improved_cityhall_tab",!0)&&improvedCityhallTab(),Settings.get("fort_recruitment",!0)&&activateFortRecruitment(),Settings.get("work_queue_off",!0)&&removeWorkQueuePA(),Settings.get("fetch_all_off",!1)&&removeVariousPA(),Settings.get("wof_nuggets_off",!1)&&changeWofNuggets(),Settings.get("market_sell_dialog",!0)&&enhanceMarketSellDialog(),Settings.get("weekly_crafting",!0)&&weeklyCrafting(),Settings.get("pin_items",!0)&&(GameInject.injectInventoryAddItemsPinItems(),GameInject.injectInventoryAddItemDivToInvPinItems()),Settings.get("telegram_bb_codes",!0)&&GameInject.injectTelegramWindowAppendTelegramDisplaySource(),Settings.get("no_shop_sale",!1)&&suppressOnGoingEntries(),Settings.get("exp_bar",!0)&&expBarValues(),Settings.get("mini_chat",!1)&&allowChatGuiMinimize(),Settings.get("task_list_points",!0)&&(addTaskJobsHints(),GameInject.injectTaskJobs()),Settings.get("town_forum_blink",!1)&&removeForumBlink(),Settings.get("enhanced_rankings",!0)&&addEnhancedRankings(),Settings.get("profile_duel_exp",!1)&&addDuelXpInProfiles(),Settings.get("regen_timers",!0)&&addRegenTimers(),Settings.get("forum_select",!0)&&selectForumText(),Settings.get("pin_important",!0)&&TWDB.Util.addCss("#ui_bottombar, #ui_menubar, #ui_experience_bar {z-index: 20!important;}"),Settings.get("fortbattle_reminder",!1)&&TWDB.Util.addCss(".fort_battle_notification {display:none!important;}"),Settings.get("night_mode",!1)&&addNightMode(),Settings.get("blink_events",!1)&&removeBlinkingEvents(),Settings.get("market_report",!0)&&(TWDB.Util.addCss(".mpb_pickup, .wih_pickup {padding-left: 0!important; width: 65px!important; margin-left: -10px!important;}"),reworkMarketReport()),Settings.get("improved_market",!1)&&improvedMarket(),Settings.get("job_show_lp",!0)&&jobWindowLP(),Settings.get("whisper_improved",!0)&&improvedWhisper(),Settings.get("instant_quest",!1)&&addInstantQuests(),Settings.get("colored_quest",!1)&&addColoredQuests(),Settings.get("import_westforts",!0)&&importWestForts(),new ServerDate().date,loader.ready=!0}catch(e){ErrorModule.report(e,Language._("errors.snippets_initialize"))}};loader=Loader.add("Snippets","tw-db code Snippets",initializeSnippets,{Settings:!0});const trustTWDB=function(){try{let str=showlink.toString();str=str.replace("the-west","tw-db|the-west"),str=str.replace("|com|","|com|info|"),eval("showlink = "+str)}catch(e){ErrorModule.report(e,Language._("errors.inject_showlink"))}},addCloseAllWearButton=function(){const e=()=>{if(!Inventory?.window?.divMain)return;const t=$(".tw2gui_window_buttons",Inventory.window.divMain);if(!t.length||t.find(".game_ext_close_all_button").length)return;const n=$(`<div class="tw2gui_window_buttons_closeall game_ext_close_all_button" title="<b>${Language._("misc.wear_close_tooltip")}</b>"></div>`);n.on("click",()=>{Inventory.window?.destroy?.(),Inventory.dockedWindow?.destroy?.(),document.querySelectorAll(".tw2gui_window.wear").forEach(a=>{a.querySelector(".tw2gui_window_buttons_close")?.click()||a.querySelector(".tw2gui_window_buttons_closeall")?.click()||a.m?.destroy?.()||a.remove()}),document.querySelector(".button.inventory.active")?.classList.remove("active")}),t.append(n)};if(e(),typeof Inventory<"u"&&Inventory.open){const t=Inventory.open;Inventory.open=function(...n){const a=t.apply(this,n);setTimeout(()=>{e()},100);let o=0;const r=setInterval(()=>{o++,e(),5>o&&!Inventory?.window?.divMain||clearInterval(r)},200);return a}}document.addEventListener("click",function(t){if(t.target?.closest?.(".button.inventory")){setTimeout(()=>{e()},100);let a=0;const o=setInterval(()=>{a++,e(),5>a&&!Inventory?.window?.divMain||clearInterval(o)},200)}},!0)},addConstructionButton=function(){const e=`build-${Character.homeTown.x}-${Character.homeTown.y}-church`;document.querySelectorAll("."+e).forEach(t=>{const n=t.querySelector(".tw2gui_window_buttons_close");return n?(n.click(),void 0):t.m&&typeof t.m.destroy=="function"?(t.m.destroy(),void 0):(t.parentNode?.removeChild(t),void 0)}),setTimeout(()=>{BuildWindow&&typeof BuildWindow.open=="function"&&BuildWindow.open(Character.homeTown.town_id,Character.homeTown.x,Character.homeTown.y,"church",!1)},50)},addMarketButton=function(){Character.homeTown.town_id?Ajax.remoteCallMode("town","get_town",{x:Character.homeTown.x,y:Character.homeTown.y},function(e){if(e.error)return new UserMessage(e.msg).show();MarketWindow.open(Character.homeTown.town_id,e.allBuildings.market.stage,MarketWindow.townName),Wear?.window&&(Wear.window.divMain.style.display="none")}):(MarketWindow.open(),new UserMessage(Language._("errors.not_town_member"),UserMessage.TYPE_ERROR).show())},repositionEventCounters=function(){TWDB.Util.addCss("@media (min-width: 1320px) { .custom_unit_counter {top: -1px!important; margin-left: 310px!important;} #hiro_friends_container {top: -1px!important; margin-right: 304px!important;} }")},localizeSearchPlaceholders=function(){function e(){document.querySelectorAll('input[placeholder="Search"]').forEach(t=>{t.placeholder==="Search"&&(function(n){n.placeholder=Language._("common.search")})(t)})}if(!localizeSearchPlaceholders.v){if(localizeSearchPlaceholders.v=!0,e(),typeof west<"u"&&west.window&&west.window.shop&&west.window.shop.open&&!west.window.shop.open.k){const t=west.window.shop.open,n=function(...a){const o=t.apply(this,a);setTimeout(()=>{e()},100);let r=0;const i=setInterval(()=>{r++,e(),5>r||clearInterval(i)},200);return o};n.k=!0,n.L=t,west.window.shop.open=n}localizeSearchPlaceholders.M||(localizeSearchPlaceholders.M=function(t){const n=t.target;n?.closest&&(n.closest(".button.shop")||n.closest(".search_button")||n.closest('[onclick*="shop"]')||n.closest('[onclick*="trader"]')||n.closest('[href*="shop_trader"]'))&&setTimeout(()=>{e()},100)},document.addEventListener("click",localizeSearchPlaceholders.M,!0))}},disableScrollbars=function(){$("body").css({overflow:"hidden"})},addChurchLevels=function(){BuildWindow.updateLaborPoints_backup=BuildWindow.updateLaborPoints,BuildWindow.updateLaborPoints=function(e){if(BuildWindow.updateLaborPoints_backup.call(this,e),this.building==="church"&&e>0){const t=Math.floor(this.window.$("div.build_progress_nfo > span.text_bold").text()/15);this.window.$("div.build_progress_nfo").append(` (${0>t?"":"+"}${t} ${Language._("misc.levels")})`)}}},townBuildingProgress=function(){BuildWindow.initInfo_backup=BuildWindow.initInfo,BuildWindow.initInfo=function(e){BuildWindow.initInfo_backup.call(this,e);const t=$(`<div class="rp_row_jobdata row_build_hammer" style="margin:-2px 0 ${$(".twir_bestwear").length?"-24px":"0"} 0;" title="${Language._("building.progress_label")}: ${Language._("building.progress_tooltip")}"><span class="rp_jobdata_label_icon"><img src="${Game.cdnURL}/images/icons/hammer.png" alt="" /></span><span class="rp_jobdata_label text_bold">${Language._("building.progress_label")}</span><span class="rp_jobdata_text text_bold"></span></div>`);$("span.rp_jobdata_text",t).append(new west.gui.Progressbar(e.build_point,e.build_point_limit).getMainDiv()),$(`.build-${e.x}-${e.y}-${e.build_key} div.build_info`).append(t)}},improvedCityhallTab=function(){CityhallWindow.Build.fillContent_backup=CityhallWindow.Build.fillContent,CityhallWindow.Build.fillContent=function(e){this.table.clearBody();for(let t=0;t<e.length;t++){const n=e[t];let a;this.main.ownTown?(n.stage!==n.maxStage||n.infinite)&&(this.table.appendRow(),a=`<a href="#" onClick="javascript:void(BuildWindow.open(${Character.homeTown.town_id}, ${Character.homeTown.x}, ${Character.homeTown.y}, '${n.key}', false));">${n.name}</a></span>`,this.table.appendToCell(-1,"building",a).appendToCell(-1,"stage",`${n.stage} / ${n.infinite?`<img src='${Game.cdnURL}/images/xp_inf_000.png' style='padding-bottom: 4px;'/>`:n.maxStage}`).appendToCell(-1,"progress",new west.gui.Progressbar(n.buildPoints,n.nextStagePoints).getMainDiv())):(this.table.appendRow(),a=n.name,this.table.appendToCell(-1,"building_foreign",a).appendToCell(-1,"stage",`${n.stage} / ${n.infinite?`<img src='${Game.cdnURL}/images/xp_inf_000.png' style='padding-bottom: 4px;'/>`:n.maxStage}`))}}},allowChatGuiMinimize=function(){TWDB.Util.addCss(`div#ui_bottomleft{width:auto;overflow:hidden}div#ui_chat{margin-top:12px}div#ui_chat div#toggleMinChat{position:absolute;top:-14px;left:5px;width:27px;display:block;background-size:108px 42px;border:0 solid rgba(0,0,0,0);background-clip:content-box}div#ui_chat.minchat div#toggleMinChat{background-position:0 0;border-width:0 8px 34px 0}div#ui_chat.minchat div#servertime{display:none}div#ui_chat.minchat>div.tabs div{display:none}div#ui_chat.minchat div.container div.friend{display:none!important}div#ui_chat.minchat div.container div.general{display:block!important}div#ui_chat.minchat div.container div.vertical_divider{display:none}div#ui_chat.minchat img.leave_channel{display:none!important}div#ui_chat div.minchat_tabr{display:none}div#ui_chat.minchat div.minchat_tabr{display:block;position:absolute;left:32px;top:0;width:8px;height:34px;background:url("${to_cdn("images/interface/chat/chat-top.png?1")}") top right}div#ui_chat.minchat{position:relative;left:-10px;top:4px;width:39px}div#ui_chat.minchat>div.tabs{width:32px;background:url("${to_cdn("images/interface/chat/chat-top.png?1")}")}div#ui_chat.minchat div.chat_channel{width:24px}div#ui_chat.minchat div.chat_channel .new_message{left:2px;top:0}div#ui_chat.minchat div.chat_channel div.online_count{background:none;position:absolute;right:0;top:-1px;width:auto;height:auto;line-height:normal;padding:0;font-size:8pt;font-weight:bold;text-align:right;text-shadow:-1px 1px 1px #FFF,0 0 2px #FFF;cursor:default}div#ui_chat.minchat div.container{width:40px;background-position-x:right}div#ui_chat.minchat div.row_title{left:5px;width:32px;opacity:0}div#ui_chat.minchat div.tw2gui_scrollpane{width:50px}`,"minchat"),$("div#ui_chat").append('<div class="minchat_tabr" />').toggleClass("minchat",Settings.get("mini_chat_min",!0)).children(".tabs").first().append($('<div id="toggleMinChat" class="tw2gui_arrow_up_top" />').on("click",function(e){return e.stopPropagation(),Settings.set("mini_chat_min",$("div#ui_chat").toggleClass("minchat").hasClass("minchat")),!1}))},addTaskJobsHints=function(){try{TWDB.Util.addCss("div#ui_workcontainer div.twdb_lp_hint{position:absolute;left:2px;width:18px;height:18px;background-color:#432;border:2px ridge #976;border-radius:11px;background-blend-mode:soft-light}div.twdb_lp_hint>img{position:absolute;left:1px;top:1px}");const e=function(){if(TaskQueue.queue.length){let t;const n=$("div#ui_workcontainer");let a,o;for(t=0;t<TaskQueue.queue.length;t++)TaskQueue.queue[t].type==="job"&&(a=null,o=TWDB.ClothCalc.calcdata.loaded&&TaskQueue.queue[t].data.job_points<TWDB.ClothCalc.calcdata.jobs[TaskQueue.queue[t].data.job.id].laborpoints.sum-5,0>TaskQueue.queue[t].data.job_points?a=west.gui.Icon.get("exclamation-priority-3",Language._("task.negative_lp")):TaskQueue.queue[t].data.job_points<TaskQueue.queue[t].data.job.malus/5?a=west.gui.Icon.get("exclamation-priority-2",Language._("task.low_lp")):o&&(a=west.gui.Icon.get("exclamation-priority-1",Language._("task.suboptimal_lp"))),a!==null&&$(`.task-queuePos-${t} > div.icon`,n).children(".twdb_lp_hint").remove().end().append($('<div class="twdb_lp_hint" />').toggleClass("tw2gui-iconset tw2gui-icon-star",!o).append(a)))}};EventHandler.listen(["taskqueue-updated","taskqueue-ready"],e)}catch(e){ErrorModule.report(e,Language._("errors.ui_task_queue_hints"))}},expBarValues=()=>{TWDB.Util.addCss("div#ui_experience_bar .label {text-shadow: 3px 1px 1px #000,3px -1px 1px #000,-2px 1px 1px #000,-2px 0px 0px #000;}");const e=n=>{const a=Math.abs(n);return 1e6>a?1e3>a?n.toString():(n/1e3).toFixed(1)+"k":(n/1e6).toFixed(2)+"m"},t=()=>{const n=$("#ui_experience_bar"),a=Character.getTrackingAchievement()===void 0?WestUi.updateTrackXp(n):WestUi.updateTrackAchievement(n);$(".label",n).off("mouseenter mouseleave"),$(".label span",n).show();const o=250>Character.level?`${a.percent}% - ${e(a.current)} / ${e(a.required)} (${e(a.required-a.current)})`:Character.experience.toLocaleString();$(".label span",n).html(o)};EventHandler.listen("character_exp_changed",t),EventHandler.listen("character_tracking_achievement_changed",t),t()},suppressOnGoingEntries=function(){try{const e=["shop_sale"],t=function(n){if($.isArray(n))for(let a=0;a<n.length;a++)t(n[a]);else if(typeof n=="string"){const a=WestUi.NotiBar.main.list;for(let o=0;o<a.length;o++)$(a[o].element).children().is("div.image."+n)&&WestUi.NotiBar.remove(a[o])}};(function(n){try{WestUi.NotiBar.__twdb__add=WestUi.NotiBar.__twdb__add||WestUi.NotiBar.add,WestUi.NotiBar.add=function(a,...o){const r=$(".image",a.element);for(let i=0;i<n.length;i++)if(r.hasClass(n[i]))return;WestUi.NotiBar.__twdb__add.call(this,a,...o)}}catch(a){ErrorModule.report(a,Language._("errors.ui_manipulate_notification_bar"))}})(e),t(e)}catch(e){ErrorModule.report(e,Language._("errors.ui_suppress_notifications"))}},removeWorkQueuePA=function(){try{TWDB.Util.addCss("#queuedTasks .buyPremiumTask {background: none!important}"),Premium.checkForAutomationPremium=function(e,t){if(t!==void 0)return t()}}catch(e){ErrorModule.report(e,Language._("errors.ui_remove_work_queue_pa"))}},changeWofNuggets=function(){try{west.gui.payHandler.prototype.T=west.gui.payHandler.prototype.addPayOption,west.gui.payHandler.prototype.addPayOption=function(e,...t){return this.T.call(this,e,...t),e===!1||e==="nugget"||e===2||e.id===2||this.setSelectedPayId(e.id||e),this}}catch(e){ErrorModule.report(e,Language._("errors.ui_change_wof_nuggets"))}},removeVariousPA=function(){const e=[];let t;if(Settings.get("fetch_all_off",!1)&&e.push("marketdelivery all"),e.length){t=RegExp(e.join("|"));try{Premium.twdb_confirmUse=Premium.confirmUse,Premium.confirmUse=function(n,a,o,r,i,c,b,u){return t.test(n)?b!==void 0?b():void 0:Premium.twdb_confirmUse(n,a,o,r,i,c,b,u)}}catch(n){ErrorModule.report(n,Language._("errors.ui_remove_various_pa"))}}},activateFortRecruitment=function(){try{TWDB.Util.addCss(".twir_fb_sector_map_btn{display:none}.TWDS_charinfocolor{margin-top:20px}"),FortBattleWindow.__twdb__getInfoArea=FortBattleWindow.__twdb__getInfoArea||FortBattleWindow.getInfoArea,FortBattleWindow.getInfoArea=function(...e){return this.preBattle.battleData.canSetPrivilege=!0,FortBattleWindow.__twdb__getInfoArea.apply(this,e)}}catch(e){ErrorModule.report(e,Language._("errors.ui_activate_fort_recruitment"))}},enhanceMarketSellDialog=function(){let e,t=TWDB.Cache.load("msdsettings");typeof t!="object"||t===null?t={cb:{}}:typeof t.cb=="object"&&t.cb!==null||(t.cb={});try{isDefined(west.gui.Dialog.prototype.W)||(west.gui.Dialog.prototype.W=west.gui.Dialog.prototype.show),TWDB.script.isDev()?west.gui.Dialog.prototype.show=function(){if(this.divMain.attr("id")==="market_createoffer_window"){const a=this.W();return w.setTimeout(function(){MarketWindow.TWDB_touchUpSellDialog(a)},25),a}const n="div#equip_manager_list, span.twdb_banking";return $(this.divMain).find(n).addBack().is(n)?this.setModal(!1).setBlockGame(!1).setDraggable(!0).W():this.W()}:west.gui.Dialog.prototype.show=function(){if(this.divMain.attr("id")==="market_createoffer_window"){const n=this.W();return w.setTimeout(function(){MarketWindow.TWDB_touchUpSellDialog(n)},25),n}return this.W()},isDefined(MarketWindow.TWDB_createMarketOffer)||(MarketWindow.TWDB_createMarketOffer=MarketWindow.createMarketOffer),MarketWindow.createMarketOffer=function(n){let a=typeof n=="number"?n:$(n).data("itemId");return a===void 0&&(a=$(this).data("dnd_droppedObj").data("itemId")),e=w.ItemManager.get(a),MarketWindow.TWDB_createMarketOffer(a)}}catch(n){ErrorModule.report(n,Language._("errors.market_enhance_sell_dialog"))}MarketWindow.TWDB_touchUpSellDialog=function(n){if(n.divMain.attr("id")!=="market_createoffer_window")return;const a=$("div.tw2gui_dialog_content",n.divMain);if(a.find("#auction_item_slot",a).html()==="")return w.setTimeout(function(){MarketWindow.TWDB_touchUpSellDialog(n)},25);$("div.tw2gui_dialog_framefix").css({left:"50%",top:"50%",width:"1px",height:"1px"}),$("textarea#auction_description",a).css("width","270px").closest("tr").append("<td id='twdb_msd_desc_cc'>");const o=$("table:nth-child(2)",a);$("tr:first-child",o).after($("<tr>").append('<td id="twdb_msd_bid_btn_cc">','<td id="twdb_msd_bid_cc" style="min-width: 90px;">','<td id="twdb_msd_buy_btn_cc">','<td id="twdb_msd_buy_cc" style="min-width: 90px;">')),$("tr:nth-last-child(5) td:nth-child(2) span.tw2gui_textfield",o).after(`<span id="twdb_msd_mult_cc" title="${Language._("market.sell_multiply")}" style="background-image: url("/images/ranking/town_ranking_icons.png"); display:inline-block; height:16px; width:16px; background-position:0px -80px; cursor:pointer;"> </span>`),$("tr:last-child td:first-child",o).attr("colspan",3).before('<td id="twdb_msd_opt_cc">');const r=function(){try{n.divMain.css({"margin-top":`-${n.divMain.height()/2}px`,"margin-left":`-${n.divMain.width()/2}px`})}catch(l){ErrorModule.report(l,Language._("errors.market_center_dialog"))}},i=function(){try{let l;const f=this.groupClass;return $("div.tw2gui_checkbox."+f).not(this.divMain).removeClass("tw2gui_checkbox_checked"),this.isSelected()?(l=this.getValue(),this.divMain.next().click()):l=0,t.cb[f]=l,TWDB.Cache.save("msdsettings",t),new UserMessage(Language._("common.save_success"),UserMessage.TYPE_SUCCESS).show(),this}catch(l){ErrorModule.report(l,Language._("errors.market_handle_checkbox"))}},c=function(l,f){try{t[l]=f,TWDB.Cache.save("msdsettings",t),new UserMessage(Language._("common.save_success"),UserMessage.TYPE_SUCCESS).show()}catch(d){ErrorModule.report(d,Language._("errors.market_save_settings"))}};$("#twdb_msd_desc_cc",a).append($(`<div class="tw2gui-iconset tw2gui-icon-save" title="${Language._("market.sell_save_desc")}">`).click(function(){c("description",$("textarea#auction_description",a).val())}),$(`<div class="tw2gui-iconset tw2gui-icon-abort" title="${Language._("market.sell_reset_desc")}">`).click(function(){c("description",""),$("textarea#auction_description",a).val("")})),$("#twdb_msd_bid_btn_cc",a).append($(`<span class="tw2gui-iconset tw2gui-icon-abort" title="${Language._("market.sell_reset_sel")}" style="display: inline-block;">`).click(function(){$("div.tw2gui_checkbox.twdb_msd_bid_fix",a).each(function(){const l=$(this).guiElement();l?.isSelected()&&(l.setSelected(!1,!0),i.call(l))}),$("#market_min_bid",a).val("").keyup()})),$("#twdb_msd_buy_btn_cc",a).append($(`<span class="tw2gui-iconset tw2gui-icon-abort" title="${Language._("market.sell_reset_sel")}" style="display: inline-block;">`).click(function(){$("div.tw2gui_checkbox.twdb_msd_buy_fix",a).each(function(){const l=$(this).guiElement();l?.isSelected()&&(l.setSelected(!1,!0),i.call(l))}),$("#market_max_price",a).val("").keyup()})),$("#twdb_msd_buy_cc",a).append(new west.gui.Checkbox("","twdb_msd_buy_fix",i).setTitle(Language._("market.use_as_default_price")).setValue(2).divMain).append($(`<div class="tw2gui_checkbox" title="${Language._("market.sell_buy_price")}">`).append('<span class="invPopup_buyicon" style="height:20px;">').click(function(){$("#market_max_price",a).val(e.price||1).keyup()})).append("&nbsp;&nbsp;").append(new west.gui.Checkbox("","twdb_msd_buy_fix",i).setTitle(Language._("market.use_as_default_price")).setValue(1).divMain).append($(`<div class="tw2gui_checkbox" title="${Language._("market.sell_sell_price")}">`).append('<span class="invPopup_sellicon" style="height:20px;">').click(function(){$("#market_max_price",a).val(e.sell_price||Math.round(e.price/2)||1).keyup()})),$("#twdb_msd_bid_cc",a).append(new west.gui.Checkbox("","twdb_msd_bid_fix",i).setTitle(Language._("market.use_as_default_price")).setValue(2).divMain).append($(`<div class="tw2gui_checkbox" title="${Language._("market.sell_buy_price")}">`).append('<span class="invPopup_buyicon" style="height:20px;">').click(function(){$("#market_min_bid",a).val(e.price||1).keyup()})).append("&nbsp;&nbsp;").append(new west.gui.Checkbox("","twdb_msd_bid_fix",i).setTitle(Language._("market.use_as_default_price")).setValue(1).divMain).append($(`<div class="tw2gui_checkbox" title="${Language._("market.sell_sell_price")}">`).append('<span class="invPopup_sellicon" style="height:20px;">').click(function(){$("#market_min_bid",a).val(e.sell_price||Math.round(e.price/2)||1).keyup()})),$("#twdb_msd_mult_cc",a).click(function(){let l;const f=parseInt($("#market_sell_itemStack",a).val(),10);f>0&&(l=parseInt($("#market_min_bid",a).val(),10),l>0&&$("#market_min_bid",a).val(f*l).keyup(),l=parseInt($("#market_max_price",a).val(),10),l>0&&$("#market_max_price",a).val(f*l).keyup())}),$("#twdb_msd_opt_cc",a).append($(`<span class="tw2gui-iconset tw2gui-icon-save" title="${Language._("market.sell_save_duration")}" style="display: inline-block;">`).click(function(){c("duration",parseInt($("#market_days",a).data("value"),10)),c("rights",parseInt($("#market_rights",a).data("value"),10))}),$(`<span class="tw2gui-iconset tw2gui-icon-abort" title="${Language._("market.sell_reset_sel")}" style="display: inline-block;">`).click(function(){c("duration",1),$("span#market_days.tw2gui_combobox",a).guiElement().select(1),c("rights",2),$("span#market_rights.tw2gui_combobox",a).guiElement().select(2)}));const b=$("span#market_rights.tw2gui_combobox",a)?.guiElement()?.items;if(b&&b.length===3){const l=["home","flag","world"];for(let f=0;f<b.length;f++)b[f].node[0].innerHTML=`<span class="tw2gui-iconset tw2gui-icon-${l[b[f].value]}" style="display: inline-block;position: relative;top: 4px;"></span> ${b[f].node[0].innerHTML}`}const u=$("h4",a),g=$("table#mps_otheroffers",a);$("tr",g).length>2||$("tr:nth-child(2) > td",g).attr("colspan")!==4?u.html(`${u.html()} (${$("tr",g).length-1})`).click(function(){g.toggle(),r()}).css({cursor:"pointer"}):(u.html(u.html()+" (0)"),g.hide()),r(),(function(){try{let l,f;for(l in t.cb)Object.hasOwn(t.cb,l)&&$("div.tw2gui_checkbox."+l).each(function(){f=$(this).guiElement(),f.getValue()===t.cb[l]&&(f.setSelected(!0,!0),$(this).next().click())});$("textarea#auction_description",a).val(t.description||""),$("span#market_days.tw2gui_combobox",a).guiElement().select(t.duration||1),$("span#market_rights.tw2gui_combobox",a)?.guiElement()?.select(isDefined(t.rights)?t.rights:2)}catch(l){ErrorModule.report(l,Language._("errors.market_restore_settings"))}})()}},weeklyCrafting=function(){if(w.Character.professionId&&w.Character.professionSkill>599){const e=function(n){try{const a=new OnGoingEntry,o=ItemManager.get(n);if(!o||!o.craftitem)return;const r=ItemManager.get(o.craftitem);if(!r)return;const i=`<div style='text-align:center;'>${Language._("crafting.can_craft_again")}<br /><div class="item  item_inventory" style="display:inline-block;float:none;"><img class="tw_item item_inventory_img" src="${r.image}"></div><br />${r.name}</div>`;a.init("",function(){CharacterWindow.open("crafting"),TWDB.Cache.save("craftingCheck",{found:!1,date:null})},11),a.setTooltip(i),a.setImageClass("work"),a.highlightBorder(),WestUi.NotiBar.add(a),TitleTicker.setNotifyMessage(Language._("crafting.notification"))}catch(a){ErrorModule.report(a,Language._("errors.ui_show_crafting_notification"))}},t=function(){try{const n=TWDB.Cache.load("craftingCheck")||{found:!1,date:null};if(!n.found)return;const a=new Date(n.date).getTime()-new ServerDate().getTime();if(0>a)return e(n.found);864e5>a&&(18e4>a?w.setTimeout(function(){e(n.found)},a):w.setTimeout(function(){t()},parseInt(a/2,10)))}catch(n){ErrorModule.report(n,Language._("errors.ui_check_crafting_timer"))}};t()}},removeForumBlink=function(){setTimeout(function(){$("div.city > div.city").removeClass("dock-highlight")},1e3),setTimeout(function(){$("#TWM_bottombar div.city > div.Stadt").removeClass("TWM_highlight")},1e3)},addEnhancedRankings=function(){function e(i){const c=i.innerHTML.match(/open\((\d+)/);if(!c)return;const b=c[1];if(!a[b])return u=function(){e(i)},void Ajax.remoteCallMode("ranking","get_data",{tab:"experience",entries_per_page:9999},function(l){for(const f of l.ranking)a[f.player_id]=o.indexOf(f.class);localStorage.setItem(n,JSON.stringify(a)),u&&u()});var u;const g=o[a[b]];$(i).prepend(`<img src="images/class_choose/class_${g}.png" title="${Game.InfoHandler.getLocalString4Charclass(g)}"> `)}function t(i,c){i.updateTable_backup=i.updateTable,i.updateTable=function(b){i.updateTable_backup.call(this,b),(function(u){u.forEach(g=>{const l=$(`${g.selector}:not(${g.skip})`);for(let f=0;f<l.length;f++)g.hidden?$(l[f]).hide():(l[f].innerText=format_number(l[f].innerText),g.diff&&f!==0&&(l[f].title=format_number(deformat_number(l[f].innerText)-deformat_number(l[f-1].innerText))))})})(c),r.forEach(u=>{const g=$(u);for(let l=0;l<g.length;l++)e(g[l])})}}const n=`twdb_${Character.playerId}_playercategory`,a=JSON.parse(localStorage.getItem(n)||"{}"),o=[null,"greenhorn","duelist","adventurer","worker","soldier"],r=[".exp_playername",".duel_playername",".forts_playername",".craft_playername",".build_playername",".mpi_playername",".achieve_playername",".skill_playername"];TWDB.Util.addCss("#ranking_exptable div.exp_exp,#ranking_duel div.duel_exp{text-align:center}#ranking_exptable div.exp_town,#ranking_duel div.duel_town,#ranking_cities .tbody .town_member_lvl{padding-left:10px}#ranking_duel div.duel_win,#ranking_duel div.duel_loss,#ranking_duel div.duel_diff{margin-right:5px}#ranking_crafting div.craft_profession_id{width:115px}#ranking_cities .row_head .town_member_lvl span{margin:0 20px}#ranking_exptable div.exp_class{display:none}#ranking_exptable div.exp_playername{width:260px}#ranking_adventures div.mpi_knockouts,#ranking_adventures div.mpi_total_actions,#ranking_adventures div.mpi_games_played,#ranking_adventures div.mpi_friendly_dmg{width:80px}#ranking_adventures div.mpi_rage_quits{width:88px}div.ranking span.search_lable_span{top:10px}"),t(RankingWindow.Experience,[{selector:".exp_exp",skip:"div.cell.cell_3",diff:!0},{selector:".exp_class",skip:"div.cell.cell_4",diff:!0,hidden:!0}]),t(RankingWindow.Duels,[{selector:".duel_exp",skip:"div.cell.cell_2",diff:!0},{selector:".duel_win",skip:"div.cell.cell_3",diff:!0},{selector:".duel_loss",skip:"div.cell.cell_4",diff:!0},{selector:".duel_diff",skip:"div.cell.cell_5",diff:!1}]),t(RankingWindow.FortBattles,[{selector:".forts_score",skip:"div.cell.cell_2",diff:!0},{selector:".forts_damage_dealt",skip:"div.cell.cell_3",diff:!0},{selector:".forts_hits_taken",skip:"div.cell.cell_4",diff:!0},{selector:".forts_dodges",skip:"div.cell.cell_5",diff:!0}]),t(RankingWindow.Crafting,[{selector:".craft_score",skip:"div.cell.cell_4",diff:!0},{selector:".craft_items_created",skip:"div.cell.cell_5",diff:!0},{selector:".craft_profession_skill",skip:"div.cell.cell_3",diff:!1}]),t(RankingWindow.Construction,[{selector:".build_total_cp",skip:"div.cell.cell_2",diff:!0},{selector:".build_fair_points",skip:"div.cell.cell_3",diff:!1},{selector:".build_stage_ups",skip:"div.cell.cell_4",diff:!1}]),t(RankingWindow.Adventures,[{selector:".mpi_knockouts",skip:"div.cell.cell_2",diff:!0},{selector:".mpi_total_actions",skip:"div.cell.cell_3",diff:!0},{selector:".mpi_games_played",skip:"div.cell.cell_4",diff:!0},{selector:".mpi_friendly_dmg",skip:"div.cell.cell_5",diff:!0},{selector:".mpi_rage_quits",skip:"div.cell.cell_6",diff:!1}]),t(RankingWindow.Achievements,[{selector:".achieve_total",skip:"div.cell.cell_2",diff:!0},{selector:".achieve_first",skip:"div.cell.cell_3",diff:!1},{selector:".achieve_points",skip:"div.cell.cell_4",diff:!0}]),t(RankingWindow.Cities,[{selector:".town_points_sum",skip:"div.cell.cell_2",diff:!0},{selector:".town_points",skip:"div.cell.cell_3",diff:!0},{selector:".town_fort_points",skip:"div.cell.cell_4",diff:!1},{selector:".town_member_points",skip:"div.cell.cell_5",diff:!1},{selector:".town_duel_points",skip:"div.cell.cell_6",diff:!1}]),t(RankingWindow.Skills,[{selector:".skill_pointss",skip:"div.cell.cell_2",diff:!0}])},addDuelXpInProfiles=function(){try{PlayerProfileMain.setProfileInfo_backup=PlayerProfileMain.setProfileInfo_backup||PlayerProfileMain.setProfileInfo,PlayerProfileMain.setProfileInfo=function(...e){PlayerProfileMain.setProfileInfo_backup.apply(this,e);const t=this.resp.level,n=this.resp.duelLevel,a=$(`.playerprofile-${this.playerid} .profileinfo-duellevel .profileinfo-value`),o={min:Math.ceil((r=n)/1.4+.01),max:Math.min(450,Math.floor(1.4*r-.01))};var r;const i=f=>Math.ceil((10*f)**(1/.6)),c=(f,d)=>t+Math.floor((f*(d||1))**.6/10),b=i(n-t),u=n==="450"?"<b>∞</b>":i(n+1-t),g=c(b,.9),l=n==="450"?"450":c(u,.9);a.append(` <div class="tw2gui-iconset tw2gui-icon-question-priority-4" title="<span>${Language._("duel.levels_duel",{min:o.min,max:o.max})}<br><br>${Language._("duel.levels_exp",{min:b,max:u})}<br>${Language._("duel.potion_label")} -10% ⇒ ${Language._("duel.levels_potion",{min:g,max:l>g?" - "+l:""})}</span>" style="display:inline-block;vertical-align:top;cursor:pointer;"></div>`)}}catch(e){ErrorModule.report(e,Language._("errors.duel_xp_profile"))}},addRegenTimers=function(){try{let r=function(i,c,b,u,g){let l,f,d,_,m=Character[i],h=Character[c],k=Character[b],L=Character[u];const D=()=>{l=m*h;const C=3600/l,A=m-k;f=A*C,d=C-Game.getServerTime()+L,_=Math.round(100/m*A)},v=C=>C.formatDuration();D(),setInterval(()=>{m===Character[i]&&h===Character[c]&&k===Character[b]&&L===Character[u]||(m=Character[i],h=Character[c],k=Character[b],L=Character[u],D()),f>1&&f--,d>1&&d--,g(v(f),l.toFixed(2),v(d),_)},1e3)};var e=r;TWDB.Util.addCss("#rt_container{width:16px;top:144px;left:8px;position:relative;display:flex;flex-direction:column;align-items:center}#rt_container img{cursor:help;margin:2px 0;padding:0 12px 0 6px;filter:hue-rotate(-50deg) saturate(777%)}");const t=$("#ui_character_container"),n=$('<div id="rt_container">'),a=i=>{const c=new MousePopup;return{$img:$(`<img id="${i}" src="${Images.iconRegen}" alt="sleeping">`).addMousePopup(c),popup:c}},o=[{id:"rt_health",maxKey:"maxHealth",regenKey:"healthRegen",currentKey:"health",dateKey:"healthDate",popup:null},{id:"rt_energy",maxKey:"maxEnergy",regenKey:"energyRegen",currentKey:"energy",dateKey:"energyDate",popup:null}];o.forEach(i=>{const c=a(i.id);i.$img=c.$img,i.popup=c.popup,n.append(c.$img)}),o.forEach(i=>{new r(i.maxKey,i.regenKey,i.currentKey,i.dateKey,(c,b,u,g)=>{i.popup.setXHTML(s((i.id.includes("health")?Language._("regen.full_health"):Language._("regen.full_energy"))+": <b>%1</b><br>"+Language._("regen.missing")+": <b>%4%</b>&boxv;"+Language._("regen.per_hour")+": <b>%2</b><br>"+(i.id.includes("health")?Language._("regen.next_health"):Language._("regen.next_energy"))+": <b>%3</b><br>",c,b,u,g))})}),t.append(n)}catch(t){ErrorModule.report(t,Language._("errors.regen_timers"))}},selectForumText=function(){try{if(selectForumText.B)return;selectForumText.B=!0;const e="twdb_forum_select_text",t="#forum,#ui_chat,div#ui_topbar>div,#ui_character_container,.tw2gui_window{-webkit-user-select:text!important;-khtml-user-select:text!important;-moz-user-select:text!important;-ms-user-select:text!important;user-select:text!important}",n=o=>{if(!o?.head||o.getElementById(e))return;const r=o.createElement("style");r.id=e,r.textContent=t,o.head.appendChild(r)},a=o=>{try{const r=o.contentDocument||o.contentWindow?.document;n(r)}catch(r){ErrorModule.report(r,Language._("errors.inject_forum_iframe"))}};n(document),document.querySelectorAll("iframe[src='forum.php']").forEach(a),document.addEventListener("load",o=>{const r=o.target;r?.tagName==="IFRAME"&&r.getAttribute("src")==="forum.php"&&a(r)},!0)}catch(e){ErrorModule.report(e,Language._("errors.enable_night_mode"))}},addNightMode=function(){try{$("#map").css({filter:"brightness(55%)","-webkit-filter":"brightness(55%)"})}catch(e){ErrorModule.report(e,Language._("errors.enable_night_mode"))}},removeBlinkingEvents=function(){try{const e=setInterval(()=>{$(".border.highlight").length&&(clearInterval(e),$(".border.highlight").remove(),TWDB.Util.addCss(".border.highlight {display:none;}"))},3e3)}catch(e){ErrorModule.report(e,Language._("errors.remove_blinking_events"))}},reworkMarketReport=function(){try{if(document.getElementsByClassName("marketplace").length>0&&document.querySelectorAll('[id^="mpb_marketOfferReport"]').forEach(e=>{const t=e.parentNode.parentNode.querySelector(".cell_8").querySelector("img");t!==null?(e.src=Game.cdnURL+"/images/icons/warn_circle.png",e.height=16,t.parentNode.insertBefore(e,t)):e.remove()}),Settings.get("improved_market",!0))return;MarketWindow.Buy.updateTable_backup=MarketWindow.Buy.updateTable_backup||MarketWindow.Buy.updateTable,MarketWindow.Buy.updateTable=function(...e){MarketWindow.Buy.updateTable_backup.apply(this,e),Character.homeTown.town_id&&reworkMarketReport()}}catch(e){ErrorModule.report(e,Language._("errors.rework_market_report"))}},improvedMarket=function(){try{MarketWindow.sellRights=[{i:"town_new",t:Language._("market.rights_town")},{i:"friends",t:Language._("market.rights_alliance")},{i:"welt",t:Language._("market.rights_anyone")}];const e=function(t){Ajax.remoteCall("building_market","search",{page:t,sort:"distance",visibility:0},function(n){var a=n.msg.search_result;for(let r=0;r<a.length;r++){var o=a[r];o.seller_name===Character.name&&$(`.marketSellsData_${o.market_offer_id} .mps_pickup`).prepend(`<img src="images/icons/${MarketWindow.sellRights[o.sell_rights].i}.png" title="${MarketWindow.sellRights[o.sell_rights].t}">`)}t===1&&n.msg.next&&e(2)})};MarketWindow.Sell.updateTable_backup=MarketWindow.Sell.updateTable_backup||MarketWindow.Sell.updateTable,MarketWindow.Sell.updateTable=function(...t){MarketWindow.Sell.updateTable_backup.apply(this,t),Character.homeTown.town_id&&e(1)},MarketWindow.Buy.updateTable_backup=MarketWindow.Buy.updateTable,MarketWindow.Buy.updateTable=function(t){if(MarketWindow.Buy.updateTable_backup.call(this,t),Character.homeTown.town_id){for(let n=0;n<t.length;n++)$("#mpb_vendor_"+t[n].market_offer_id).before(`<img src="images/icons/${MarketWindow.sellRights[t[n].sell_rights].i}.png" title="${MarketWindow.sellRights[t[n].sell_rights].t}">`);reworkMarketReport()}}}catch(e){ErrorModule.report(e,Language._("errors.improved_market"))}},improvedWhisper=function(){try{var e=`${Script.protocol}://${Script.folder_url}whispers/`,t=["tw","bum","chime","coin","coin2","icq","qip","tinkle","trumpet","vk"];const n=9,a={},o="whisper_improved",r="beeperSound";let i=e+t[n]+".mp3";const c=function(d){return typeof d=="string"&&d!==""&&/^-?\d+$/.test(d)?parseInt(d,10):d},b=function(){return c(Settings.get(r,n))};Settings.get(o,!0);const u=function(){const d=b();i=typeof d=="number"&&t[d]?e+t[d]+".mp3":typeof d=="string"&&d?d:e+t[n]+".mp3"},g=function(){try{new Audio(i).play()}catch(d){ErrorModule.report(d,Language._("errors.gameinject_improved_whisper_play_sound"))}},l=function(){EventHandler.listen("chat_tell_received",g,a),AudioController.play_whisper||(AudioController.play_whisper=AudioController.play,AudioController.play=function(d,..._){d!=="newmsg"&&AudioController.play_whisper.call(this,d,..._)})},f=function(){EventHandler.unlistenByContext("chat_tell_received",a),AudioController.play_whisper&&(AudioController.play=AudioController.play_whisper,delete AudioController.play_whisper)};u(),Settings.get(o,!0)&&l(),window.ChatBeeper={updateSound:u,play:g,enable:l,disable:f}}catch(n){ErrorModule.report(n,Language._("errors.improved_whisper"))}},jobWindowLP=function(){try{JobWindow.prototype.__twdb__initView=JobWindow.prototype.__twdb__initView||JobWindow.prototype.initView,JobWindow.prototype.initView=function(...e){var t=JobWindow.prototype.__twdb__initView.apply(this,e);if(this.job&&typeof this.currSkillpoints=="number"){var n=`&nbsp;&nbsp;(${Language._("jobs.lp_remaining",{lp:this.currSkillpoints-this.job.workpoints})})`;$("div.tw2gui_inner_window_title > .textart_title",this.window.divMain).append(n)}return t}}catch(e){ErrorModule.report(e,Language._("errors.job_window_lp"))}},addInstantQuests=function(){try{if(!QuestEmployerView?.showQuest)return;QuestEmployerView.showQuest_backup=QuestEmployerView.showQuest,QuestEmployerView.showQuest=e=>{QuestEmployerView.showQuest_backup(e);const t=e.accepted===!1,n=!e.questRewardsOptions;if(t&&n){const a=e.requirements||[];if(a.filter(o=>o.solved===!0).length===a.length){const o=$("div.quest_button_area_"+e.id);if(!o.length)return;const r=new west.gui.Button(Language._("quests.accept_finish"),()=>{QuestWindow.acceptQuest(e.id);let i=0;const c=setInterval(()=>{QuestLog.quests?.[e.id]?(clearInterval(c),QuestWindow.finishQuest(e.id)):++i===20&&clearInterval(c)},200)}).getMainDiv();o.empty().append(r)}}}}catch(e){ErrorModule.report(e,Language._("errors.add_instant_quests"))}},addColoredQuests=function(){try{const e=(n,a)=>{if(n.jsInfo?.metatype==="FRONTEND"){const i=n.jsInfo.key;(QuestLog.windows_opened[i]||QuestLog.tabs_opened[i])&&(n.solved=!0)}const o=n.info.replace(/ (\(?\d+\/\d+\)?)/g,"&nbsp;$1"),r=n.solved&&!a?"color:gray;":"";return`<li class="quest_requirement ${n.solved&&a?a:""}" style="${r}">- ${o}</li>`},t=QuestEmployerView.buildQuestLog;QuestEmployerView.buildQuestLog=function(n,...a){t.call(this,n,...a),n.open.forEach(o=>{const r=$("#open_quest_employerlink_"+o.id);if(!r||!r.is(":visible"))return;let i=0,c='<div style="max-width: 300px; min-width: 150px;"><ul class="requirement_container">';o.requirements.forEach(u=>{u.solved||u.type==="wear_changed"&&Bag.getItemByItemId(u.id)?i++:u.solved||(c+=e(u))}),c+="</ul></div>",c+=`<div style="text-align: center;">${Quest.getRewards(o.questRewards,o.questRewardsOptions,!1)}</div>`;const b=r.children("img");if(c.trim()!==""&&b.addMousePopup(c),o.limited?.length&&b.after($('<div class="hourglass_quest" style="display: inline-block; vertical-align: middle; margin-bottom: 3px; margin-right: 2px;"></div>').addMousePopup(o.limited)),Settings.get("colored_quest")){r.addClass("twdb_quest_entrie");const u=o.requirements.length;i===u&&o.accepted?r.css({color:"#666","font-style":"italic"}):i===u||i+1===u&&o.duel?.isNPCDuel?r.css({color:"#070"}):66>i/u*100||r.css({color:"#b75c00"})}})},TWDB.Util.addCss(".twdb_quest_entrie:hover { color: #1479A8 !important; }")}catch(e){ErrorModule.report(e,Language._("errors.add_colored_quests"))}},importWestForts=function(){try{if(location.href.includes(".the-west.")&&location.href.includes("game.php")){if(!TWDB.images.westfortsIconActive||!TWDB.images.westfortsIconInactive)return waitForImages("westfortsIconActive",importWestForts),void 0;if(document.getElementById("westforts_js"))return;const e=document.createElement("script");e.type="text/javascript",e.id="westforts_js",e.innerHTML=`(() => {const ICON_ACTIVE = TWDB.images.westfortsIconActive;const ICON_INACTIVE = TWDB.images.westfortsIconInactive;let scriptArmed = false;const originalFortStats = FortBattle.makeStats;const originalCemeteryTable = CemeteryWindow.showStatUpdateTable;const westfortsButton = document.createElement('div');westfortsButton.id = 'westforts_link_div';const TITLE_DEFAULT = \`<b>\${Language._("westforts.open_import")}</b>\`;const TITLE_ARMED = \`<b>\${Language._("westforts.close_import")}</b>\`;westfortsButton.title = TITLE_DEFAULT;westfortsButton.style.cssText = 'position:absolute; z-index:10; cursor:pointer; text-align:center; color:#fff; font-size:12px; padding:0px 3px 1px 9px; right:0; top:0; background:url("/images/interface/minimap/minimapbg.png") no-repeat scroll 0px -7px';westfortsButton.innerHTML = \`<img id="westforts_icon_img" src="\${ICON_INACTIVE}" /><div style="float:right;margin-left:5px;margin-top:1px;">\${Language._("westforts.button_label")}</div>\`;westfortsButton.onclick = () => {const iconImg = document.getElementById('westforts_icon_img');if (scriptArmed) {westfortsButton.style.color = '#fff';iconImg.src = ICON_INACTIVE;westfortsButton.title = TITLE_DEFAULT;scriptArmed = false;const existingScript = document.getElementById('wfScript');if (existingScript) existingScript.remove();FortBattle.makeStats = originalFortStats;CemeteryWindow.showStatUpdateTable = originalCemeteryTable;const form = document.getElementById('wfForm');if (form) form.remove();} else {if (!document.getElementById('wfScript')) {const script = document.createElement('script');script.id = 'wfScript';script.type = 'text/javascript';script.src = \`https://www.westforts.com/js/import.js?\${Date.now()}\`;document.body.appendChild(script);}westfortsButton.style.color = '#01DF00';iconImg.src = ICON_ACTIVE;westfortsButton.title = TITLE_ARMED;scriptArmed = true;}};document.body.appendChild(westfortsButton);})();`,document.body.appendChild(e)}}catch(e){ErrorModule.report(e,Language._("errors.import_westforts"))}};return _self})($);Debugger.Snippets=Snippets;const GameInject=(function($){const _self={},save={},minimap=[],questlog=[],radialmenu=[],quests=[],_ready=!1;let timeout=null,interval=null;const _position=[],_reportreceived=[];_self.CharacterButton=(function(e){const t={};let n=0,a=null;return t.add=function(o){n===0&&(TWDB.Util.addCss(`div#twdb_characbut{width:36px;height:35px;position:absolute;left:141px;top:131px;border-bottom-left-radius:8px;background:url(${Game.cdnURL}/images/interface/character/character.png?3) no-repeat -141px -105px transparent}`),a=e('<div id="twdb_characbut" />'),e("#ui_character_container").prepend(a)),n++,a.css({height:10+26*n+"px","background-position":`-141px ${26*n-131}px`});var r=e(`<div class="char_links" style="top:${6+26*(n-1)}px;left:6px;background:url(${o})no-repeat 0px 0px transparent;"/>`);return r.on("mouseenter",function(){e(this).css("background-position","-25px 0px")}).on("mouseleave",function(){e(this).css("background-position","0px 0px")}),a.append(r),r},t})($),_self.injectTaskJobs=function(){try{var e=TaskJob;TaskJob=function(...n){var a=e.apply(this,n);return a.C=a.getTitle,a.getTitle=function(){return`${a.C()}${Language._("misc.labor_points")} :${0>this.data.job_points?"<b class='text_red'>":"<b>"}${this.data.job_points}</b><br />`},a}}catch(n){ErrorModule.report(n,Language._("errors.gameinject_manipulate_taskjob_template"))}try{if(TaskQueue.queue.length){var t=$("script:contains('TaskQueue.init')").text().match(/TaskQueue\.init\(\s*(\[[^\]]*\])/);t.length===2&&(t=JSON.parse(t[1]),TaskQueue.init(t,TaskQueue.limit))}}catch(n){ErrorModule.report(n,Language._("errors.gameinject_manipulate_job_tasks"))}},_self.ChatLayout=(function(e){const t=[];return function(n){if(t.length===0)try{save["window.Chat.Layout.Tab.prototype.getMainDiv"]=window.Chat.Layout.Tab.prototype.getMainDiv,window.Chat.Layout.Tab.prototype.getMainDiv=function(){for(let a=0;a<t.length;a++)try{t[a](this)}catch(o){ErrorModule.report(o,Language._("errors.gameinject_callbacks_chat_layout"))}return this.mainDiv}}catch(a){ErrorModule.report(a,Language._("errors.gameinject_manipulate_chat_layout")),window.Chat.Layout.Tab.prototype.getMainDiv=save["window.Chat.Layout.Tab.prototype.getMainDiv"]}t.push(n)}})(),_self.ChatSend=(function(e){const t=[];return function(n){if(t.length===0)try{window.Chat.Layout.Tab.prototype.twdb_send=window.Chat.Layout.Tab.prototype.send,window.Chat.Layout.Tab.prototype.send=function(){for(let a=0;a<t.length;a++)try{t[a](this)}catch(o){ErrorModule.report(o,Language._("errors.gameinject_callbacks_chat_send"))}this.twdb_send()}}catch(a){ErrorModule.report(a,Language._("errors.gameinject_manipulate_chat_send")),window.Chat.Layout.Tab.prototype.send=window.Chat.Layout.Tab.prototype.twdb_send}t.push(n)}})(),_self.MarketOfferTable=(function(e){const t=[];return function(n){if(t.length===0)try{save["MarketWindow.Offer.updateTable"]=MarketWindow.Offer.updateTable,MarketWindow.Offer.updateTable=function(a){save["MarketWindow.Offer.updateTable"](a);for(let o=0;o<t.length;o++)try{t[o](a)}catch(r){ErrorModule.report(r,Language._("errors.gameinject_callbacks_market_offer_table"))}}}catch(a){ErrorModule.report(a,Language._("errors.gameinject_manipulate_market_offer_table")),MarketWindow.Offer.updateTable=save["MarketWindow.Offer.updateTable"]}t.push(n)}})(),_self.MarketWatchlistTable=(function(e){const t=[];return function(n){if(t.length===0)try{save["MarketWindow.Watchlist.updateTable"]=MarketWindow.Watchlist.updateTable,MarketWindow.Watchlist.updateTable=function(a){save["MarketWindow.Watchlist.updateTable"](a);for(let o=0;o<t.length;o++)try{t[o](a)}catch(r){ErrorModule.report(r,Language._("errors.gameinject_callbacks_market_watchlist_table"))}}}catch(a){ErrorModule.report(a,Language._("errors.gameinject_manipulate_market_watchlist_table")),MarketWindow.Watchlist.updateTable=save["MarketWindow.Watchlist.updateTable"]}t.push(n)}})(),_self.MarketWhatIsHotTable=(function(e){const t=[];return function(n){if(t.length===0)try{save["MarketWindow.WhatIsHot.updateTable"]=MarketWindow.WhatIsHot.updateTable,MarketWindow.WhatIsHot.updateTable=function(a){save["MarketWindow.WhatIsHot.updateTable"](a);for(let o=0;o<t.length;o++)try{t[o](a)}catch(r){ErrorModule.report(r,Language._("errors.gameinject_callbacks_market_what_is_hot_table"))}}}catch(a){ErrorModule.report(a,Language._("errors.gameinject_manipulate_market_what_is_hot_table")),MarketWindow.WhatIsHot.updateTable=save["MarketWindow.WhatIsHot.updateTable"]}t.push(n)}})(),_self.injectSetDuelMotivation=(function(e){const t=[];return function(n){if(t.length===0)try{Character.twdb_setDuelMotivation=Character.setDuelMotivation,Character.setDuelMotivation=function(a){this.twdb_setDuelMotivation(a);for(let o=0;o<t.length;o++)try{t[o](a)}catch(r){ErrorModule.report(r,Language._("errors.gameinject_callbacks_set_duel_motivation"))}}}catch(a){ErrorModule.report(a,Language._("errors.gameinject_manipulate_set_duel_motivation")),Character.setDuelMotivation=twdb_Character.setDuelMotivation}t.push(n)}})(),_self.ItemUse=(function(_$){const callbacks=[];return function(callback){if(callbacks.length===0){ItemUse.twdb=function(e,t){for(let n=0;n<callbacks.length;n++)try{callbacks[n](e,t)}catch(a){ErrorModule.report(a,Language._("errors.gameinject_callbacks_item_use"))}},save["ItemUse.doIt"]=ItemUse.doIt;try{const toolkit=ItemUse.doItOrigin?"doItOrigin":"doIt",str=ItemUse[toolkit].toString(),pos=str.indexOf("EventHandler.signal('item_used'"),inject=`${str.substr(0,pos)}ItemUse.twdb(itemId,res);${str.substr(pos)}`;eval(`ItemUse.${toolkit} = ${inject}`)}catch(e){ItemUse.doIt=save["ItemUse.doIt"],ErrorModule.report(e,Language._("errors.gameinject_manipulate_item_use"))}}callbacks.push(callback)}})($),_self.injectItem=function(type,name,callback){const item=type+"Item";save[item]===void 0&&(save[item]=tw2widget[item].prototype.getMainDiv);try{tw2widget[item].prototype["TWDB"+name]=function(e){try{return callback(e)}catch(t){return ErrorModule.report(t,Language._("errors.gameinject_injected_function",{functionName:name})),""}}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_inject_function",{item,functionName:name}))}try{var inject=`this.TWDB${name}(this);`;inject.replace(/ /g,"");var newfunction=tw2widget[item].prototype.getMainDiv.toString().replace("return",inject+" return");eval(`tw2widget['${item}'].prototype.getMainDiv = ${newfunction}`)}catch(e){ErrorModule.report(e,Language._("errors.gameinject_manipulate_prototype_get_main_div",{item})),tw2widget[item].prototype.getMainDiv=save[item]}},_self.injectTrader=function(name,callback){save["west.game.shop.item.view.prototype.render"]===void 0&&(save["west.game.shop.item.view.prototype.render"]=west.game.shop.item.view.prototype.render);try{west.game.shop.item.view.prototype["TWDB"+name]=function(e){try{return callback(e)}catch(t){return ErrorModule.report(t,Language._("errors.gameinject_callback_inject_trader",{functionName:name})),""}}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_inject_trader_callback",{functionName:name}))}try{var str=west.game.shop.item.view.prototype.render.toString(),inject=`window.setTimeout(function() {$item.append(that.TWDB${name}(model.getItemData()))}, 100);`;inject.replace(/ /g,"");var newfunction=str.replace("return $item",inject+" return $item");eval("west.game.shop.item.view.prototype.render = "+newfunction)}catch(e){ErrorModule.report(e,Language._("errors.gameinject_manipulate_shop_item_render")),west.game.shop.item.view.prototype.render=save["west.game.shop.item.view.prototype.render"]}},_self.injectMarket=function(name,callback){save.MarketWindow===void 0&&(save.MarketWindow=MarketWindow.getClearName.toString());try{MarketWindow["TWDB"+name]=function(e){try{return callback(e)}catch(t){ErrorModule.report(t,Language._("errors.gameinject_injected_market_window_function",{functionName:name}))}return""}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_inject_market_window_function",{functionName:name}))}try{var str=MarketWindow.getClearName.toString(),inject=`this.TWDB${name}(obj.item_id)`;inject.replace(/ /g,"");for(var newfunction="";str.indexOf("return")!==-1;){var pos=str.indexOf("return");newfunction+=`${str.slice(0,pos+6)} ${inject} + String(`,str=str.substr(pos+7),pos=str.indexOf(";"),newfunction+=str.slice(0,pos)+");",str=str.substr(pos+1)}newfunction+=str,eval("MarketWindow.getClearName = "+newfunction)}catch(error){ErrorModule.report(error,Language._("errors.gameinject_manipulate_market_get_clear_name")),eval("MarketWindow.getClearName = "+save.MarketWindow)}},_self.injectGetBids=function(){try{MarketWindow.twdb_showTab2=MarketWindow.twdb_showTab2||MarketWindow.showTab,MarketWindow.showTab=function(e,...t){e!=="sell"&&e!=="marketmap"&&TWDB.ClothCalc.getBids(),MarketWindow.twdb_showTab2.call(this,e,...t)}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_manipulate_market_show_tab_2"))}},_self.addTabOnMessagesWindow=function(name,shortname,callback){save.MessagesWindowOpen===void 0&&(save.MessagesWindowOpen=MessagesWindow.open.toString(),save.MessagesWindowTab=MessagesWindow.showTab.toString());try{var inject=`MessagesWindow.window.addTab('${name}', '${shortname}', tabclick).appendToContentPane($('<div class="messages-${shortname}"/>'));`,newfunction=MessagesWindow.open.toString().replace(/MessagesWindow.Telegram.DOM/g,inject+"MessagesWindow.Telegram.DOM");eval(`(function ($) {MessagesWindow.open = ${newfunction}})(jQuery);`)}catch(error){ErrorModule.report(error,Language._("errors.gameinject_manipulate_messages_window_open")),eval(`(function ($) {MessagesWindow.open = ${save.MessagesWindowOpen}})(jQuery);`)}try{MessagesWindow["TWDB-"+shortname]=function(){callback()}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_add_show_tab_messages_window"))}try{var inject2=`case '${shortname}':MessagesWindow['TWDB-${shortname}']();break;`,newfunction2=MessagesWindow.showTab.toString().replace(/switch(\s)*\(id\)(\s)*{/g,"switch (id) { "+inject2);eval(`(function ($) {MessagesWindow.showTab = ${newfunction2}})(jQuery);`)}catch(error){ErrorModule.report(error,Language._("errors.gameinject_manipulate_messages_window_show_tab")),eval(`(function ($) {MessagesWindow.showTab = ${save.MessagesWindowTab}})(jQuery);`)}},_self.addTabOnMarketWindow=function(e,t,n){const a=function(o,r){MarketWindow.window&&(MarketWindow.window.activateTab(r).$("div.tw2gui_window_content_pane > *",MarketWindow.DOM).each(function(i,c){$(c).hasClass("marketplace-"+r)?($(c).children().fadeIn(),$(c).show()):($(c).children().fadeOut(),$(c).hide())}),MarketWindow["TWDB-"+r]())};try{MarketWindow.twdb_open=MarketWindow.twdb_open||MarketWindow.open,MarketWindow.open=function(...o){this.twdb_open.apply(this,o),MarketWindow.window.addTab(e,t,a).appendToContentPane($(`<div class="marketplace-${t}"/>`))}}catch(o){ErrorModule.report(o,Language._("errors.gameinject_manipulate_market_window_open"))}try{MarketWindow["TWDB-"+t]=function(){n()}}catch(o){ErrorModule.report(o,Language._("errors.gameinject_add_show_tab_market_window"))}try{MarketWindow.twdb_showTab=MarketWindow.twdb_showTab||MarketWindow.showTab,MarketWindow.showTab=function(...o){MarketWindow.window.setSize(748,471).removeClass("premium-buy"),this.twdb_showTab.apply(this,o)}}catch(o){ErrorModule.report(o,Language._("errors.gameinject_manipulate_market_window_show_tab_1"))}};const waitForMinimap=function(e){interval&&(window.clearInterval(timeout),window.clearInterval(interval)),timeout=setInterval(function(){window.clearInterval(interval),window.clearInterval(timeout),interval=null,timeout=null},3e5),interval=setInterval(function(){(function(){try{if(!MinimapWindow.window||$(MinimapWindow.window.divMain).find(".mmap_jobs").length===0||$(MinimapWindow.window).find(".loader").is(":visible"))return;window.clearInterval(timeout),window.clearInterval(interval),interval=null,timeout=null;for(let t=0;t<minimap.length;t++)try{minimap[t]()}catch(n){ErrorModule.report(n,Language._("errors.gameinject_minimap_window_inject"))}}catch(t){ErrorModule.report(t,Language._("errors.gameinject_check_minimap_ready"))}})()},200)};return _self.injectMinimap=function(e){try{MinimapWindow.D||(MinimapWindow.D=MinimapWindow.open,MinimapWindow.open=function(t){try{MinimapWindow.D(t),waitForMinimap()}catch(n){ErrorModule.report(n,Language._("errors.gameinject_minimap_window_open"))}})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_minimap_window_open"))}try{MinimapWindow._refreshWindow||(MinimapWindow._refreshWindow=MinimapWindow.refreshWindow,MinimapWindow.refreshWindow=function(){try{MinimapWindow._refreshWindow(),window.setTimeout(function(){waitForMinimap()},2500)}catch(t){ErrorModule.report(t,Language._("errors.gameinject_minimap_window_refresh"))}})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_minimap_window_refresh"))}minimap.push(function(){e()})},_self.injectRadialmenu=function(e){try{window.GameMap.Radialmenu.prototype.D||(window.GameMap.Radialmenu.prototype.D=window.GameMap.Radialmenu.prototype.open,window.GameMap.Radialmenu.prototype.open=function(t){try{this.D(t);for(let n=0;n<radialmenu.length;n++)radialmenu[n](this)}catch(n){ErrorModule.report(n,Language._("errors.gameinject_radialmenu_open"))}})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_radialmenu_open"))}radialmenu.push(function(t){e(t)})},_self.injectQuestLog=function(e){try{QuestEmployerView._buildQuestLog||(QuestEmployerView._buildQuestLog=QuestEmployerView.buildQuestLog,QuestEmployerView.buildQuestLog=function(t){try{QuestEmployerView._buildQuestLog(t);for(let n=0;n<questlog.length;n++)questlog[n](t)}catch(n){ErrorModule.report(n,Language._("errors.gameinject_quest_employer_view_build_quest_log"))}}),questlog.push(function(t){e(t)})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_quest_employer_view_build_quest_log"))}},_self.injectQuest=function(e){try{Quest.prototype.j||(Quest.prototype.j=Quest.render,Quest.prototype.render=function(){try{this.j();for(let t=0;t<quests.length;t++)quests[t](this)}catch(t){ErrorModule.report(t,Language._("errors.gameinject_quest_render"))}}),quests.push(function(t){e(t)})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_quest_render"))}},_self.injectInventoryAddItemsPinItems=function(){try{Inventory.__CCPI__addItems=Inventory.__CCPI__addItems||Inventory.addItems,Inventory.addItems=function(...e){const[t,n]=e;Inventory.__CCPI__addItems.apply(this,e),$("#CC_pin_items").length||Inventory.DOM.children(".actions").append($('<div id="CC_pin_items" class="tw2gui_iconbutton" />').attr({title:Language._("misc.pin_toggle_tooltip")}).toggleClass("pinact",TWDB.Settings.itemPinningMode===1)),$("#CC_pin_items").off("click").click(function(){TWDB.Settings.itemPinningMode^=!0,$(this).toggleClass("pinact",TWDB.Settings.itemPinningMode===1),Inventory.addItems(t,n)}),(t||Inventory.defaultCategory)==="new"&&$.each((TWDB.Settings.get("pinnedItems")||[]).slice().reverse(),function(a,o){const r=Bag.getItemByItemId(o);r&&Inventory.addItemDivToInv(r,!0)})},TWDB.Util.addCss(`div#CC_pin_items{background-image:url("${Images.pinItems}");background-position:top;width:34px;height:36px;position:absolute;left:0!important}div#CC_pin_items.pinact{background-position:bottom}div.actions:has(.bag_resize) div#CC_pin_items{left:34px!important;position:absolute!important}`,"pinning")}catch(e){ErrorModule.report(e,Language._("errors.inventory_additems_pin"))}},_self.injectInventoryAddItemDivToInvPinItems=function(){try{Inventory.__CCPI__addItemDivToInv=Inventory.__CCPI__addItemDivToInv||Inventory.addItemDivToInv,Inventory.addItemDivToInv=function(...e){const[t,n]=e;if(TWDB.Settings.itemPinningMode||n){const a=TWDB.Settings.get("pinnedItems")||[],o=t.getId(),r=$("<div>").append(t.getMainDiv().data("itemId",t.getId()));r.find("img").off("click").click(TWDB.Settings.itemPinningMode?function(i){const c=a.indexOf(o);if(0>c){if(a.length>=Inventory.latestSize)return;a.push(o)}else a.splice(c,1);$(this).parent().parent().toggleClass("opacity05"),TWDB.Settings.set("pinnedItems",a)}:function(i){Inventory.clickHandler(t.getId(),i)}),TWDB.Settings.itemPinningMode?r.addClass(0>a.indexOf(o)?"opacity05":""):r.find("img").setDraggable(Inventory.announceDragStart,Inventory.announceDragStop),n?(r.addClass("pinned").prependTo($("#bag",Inventory.DOM)),$("#bag > div:empty",Inventory.DOM).remove(),$("#bag > div").length>Inventory.latestSize&&$("#bag > div:not(.pinned):first",Inventory.DOM).detach()):r.appendTo($("#bag",Inventory.DOM))}else Inventory.__CCPI__addItemDivToInv.apply(this,e)},TWDB.Util.addCss(`#bag>.pinned>.item{background:rgba(134,93,39,0.4) url("${Images.pinMini}") -1px -1px no-repeat;border-radius:4px;-webkit-box-shadow:inset 0 0 2px 1px #852;-moz-box-shadow:inset 0 0 2px 1px #852;box-shadow:inset 0 0 2px 1px #852}#bag>.pinned>.item span.count{bottom:-1px;left:1px}#bag>.pinned>.item span.usable{right:-1px}#bag>.pinned>.item span.item_level{opacity:0.4;top:1px;left:initial;right:1px;background-color:rgba(0,0,0,0)}#bag>.pinned>.item span.cooldown{top:2px;left:15px}`,"pinning")}catch(e){ErrorModule.report(e,Language._("errors.inventory_additemdiv_pin"))}},_self.injectTelegramWindowAppendTelegramDisplaySource=function(){try{if(TelegramWindow.__CCDTS__appendTelegram=TelegramWindow.__CCDTS__appendTelegram||TelegramWindow.appendTelegram,TelegramWindow.appendTelegram=function(...e){TelegramWindow.__CCDTS__appendTelegram.apply(this,e);const[t,n]=e,a=n.contentPane instanceof jQuery?n.contentPane[0]:n.contentPane;if(!a)return;const o=a.querySelectorAll(".telegram-head");if(o.length===0)return;const r=o[o.length-1],i=r.querySelector(".author");if(!i)return;Object.assign(i.style,{left:"81px",width:"140px",background:"url(/images/window/messages/post-head.jpg) -16px 0"});const c=document.createElement("div");c.className="telegram-source",c.title=Language._("misc.telegram_toggle_tooltip");const b=document.createElement("div");b.textContent="BB",c.appendChild(b),c.addEventListener("click",function(){const u=c.classList.toggle("active"),g=r.nextElementSibling;if(g)if(u){const l=t.text.replace(/<(\/?(b|i|u|del))>/g,"[$1]").replace(/<a href="[^"]+PlayerProfileWindow[^"]+">([^<]+)<\/a>/g,"[player]$1[/player]").replace(/<a href="[^"]+TownWindow[^"]+">([^<]+)<\/a>/g,"[town]$1[/town]").replace(/<a href="[^"]+FortWindow[^"]+">([^<]+)<\/a>/g,"[fort]$1[/fort]").replace(/<a href="[^"]+AllianceWindow[^"]+">([^<]+)<\/a>/g,"[alliance]$1[/alliance]").replace(/<a class="external_link" href="[^=]+=redirect[^=]+=([^"]+)" target="_blank">([^<]+)<\/a>/g,(f,d,_)=>`[url=${decodeURIComponent(d)}]${_}[/url]`).replace(/<a class="public_report_link" href="[^"]+ReportWindow\.open\((\d+), '([0-9a-f]+)'\);">([^<]+)<\/a>/g,(f,d,_,m)=>`[report=${d}${_}]${m.replace(/^\[|\]$/g,"")}[/report]`);g.innerHTML=l}else g.innerHTML=Game.TextHandler.parse(t.text)}),i.parentNode.insertBefore(c,i)},!document.getElementById("telegram-source-style")){const e=document.createElement("style");e.id="telegram-source-style",e.textContent=".telegram-source {position: absolute; width: 24px; height: 24px; cursor: pointer; background: url(/images/window/messages/icons.png) 72px -3px; left: 52px;}.telegram-source div {display: inline-block; width: 14px; height: 11px; color: white; background: #523F30; font-size: 10px; margin: 4px; padding: 0 0 5px 2px; line-height: 16px; font-family: Impact, sans-serif; font-weight: 300;}.telegram-source.active div {background: blue;}",document.head.appendChild(e)}}catch(e){ErrorModule.report(e,Language._("errors.telegram_append","Error manipulating TelegramWindow.appendTelegram"))}},_self.injectWanderingTraderSellDialog=function(){try{west.window.shop.view.__proto__.I=west.window.shop.view.__proto__.showSellDialog,west.window.shop.view.__proto__.showSellDialog=function(e,...t){var n,a,o=this.getController(),r=Bag.getItemByItemId(e),i=r.count;this.I.call(this,e,...t),3>i||(n=$("div.tw2gui_dialog").has(`div.textart_title:contains(${r.getName()})`)).length===1&&(a=`Max-1 (${--i}x = $ ${i*r.getSellPrice()})`,n.children("div.tw2gui_dialog_actions").prepend(new west.gui.Button(a,function(){o.requestSell({inv_id:r.inv_id,count:i}),n.find("div.tw2gui_button").last().click()}.bind(this)).getMainDiv()))}}catch(e){ErrorModule.report(e,"manipulate .showSellDialog (wandering trader - sell all but one)")}},_self.MenuButton=function(e,t,n){var a=n||function(){},o=$(`<div class="menulink" title="${t}">`).css({"background-image":`url(${e})`,"background-repeat":"no-repeat","background-position":"0px 0px"}),r={obj:o,setOnClick:function(i){a=i}};return o.on("mouseenter",function(){o.css("background-position","-25px 0px")}).on("mouseleave",function(){o.css("background-position","0px 0px")}).on("click",function(i){a&&a(r,i)}),$("#TWDB_ClothCalc_menubuttons").append(o),r},_self.patchItemWidget=function(){try{if(typeof tw2widget>"u"||tw2widget.Item===void 0)return;save["tw2widget.Item.prototype.createItemElement"]===void 0&&(save["tw2widget.Item.prototype.createItemElement"]=tw2widget.Item.prototype.createItemElement),tw2widget.Item.prototype.createItemElement=function(){return this.obj?save["tw2widget.Item.prototype.createItemElement"].call(this):(this.divMain=$('<div class="item error" style="width:40px;height:40px;background:#f00;border:1px solid #000;" title="Item data missing"></div>'),void 0)},save["tw2widget.Item.prototype.getId"]===void 0&&(save["tw2widget.Item.prototype.getId"]=tw2widget.Item.prototype.getId),tw2widget.Item.prototype.getId=function(){return this.obj?save["tw2widget.Item.prototype.getId"].call(this):null},save["tw2widget.Item.prototype.getItemLevel"]===void 0&&(save["tw2widget.Item.prototype.getItemLevel"]=tw2widget.Item.prototype.getItemLevel),tw2widget.Item.prototype.getItemLevel=function(){return this.obj?save["tw2widget.Item.prototype.getItemLevel"].call(this):0},save["tw2widget.Item.prototype.getName"]===void 0&&(save["tw2widget.Item.prototype.getName"]=tw2widget.Item.prototype.getName),tw2widget.Item.prototype.getName=function(){return this.obj?save["tw2widget.Item.prototype.getName"].call(this):""},save["tw2widget.Item.prototype.isUsable"]===void 0&&(save["tw2widget.Item.prototype.isUsable"]=tw2widget.Item.prototype.isUsable),tw2widget.Item.prototype.isUsable=function(){return!!this.obj&&save["tw2widget.Item.prototype.isUsable"].call(this)},save["tw2widget.Item.prototype.isUpgradeable"]===void 0&&(save["tw2widget.Item.prototype.isUpgradeable"]=tw2widget.Item.prototype.isUpgradeable),tw2widget.Item.prototype.isUpgradeable=function(){return!!this.obj&&save["tw2widget.Item.prototype.isUpgradeable"].call(this)}}catch(e){ErrorModule.report(e,"Error patching tw2widget.Item prototype")}},_self})($);Debugger.GameInject=GameInject;const Quests=(function(e){let t={};t=Loader.add("Quests","tw-db Quests",function(){if(!t.ready)try{Settings.get("quest_cancel",!0)&&n(),t.ready=!0}catch(a){ErrorModule.report(a,Language._("errors.quests_initialize"))}},{Settings:!0});const n=function(){try{var a=QuestWindow.cancelQuest;QuestWindow.cancelQuest=function(o){new west.gui.Dialog(Language._("quests.cancel_title"),Language._("quests.cancel_message")).setIcon(west.gui.Dialog.SYS_QUESTION).setModal(!0,!1,{bg:Game.cdnURL+"/images/curtain_bg.png",opacity:.4}).addButton(Language._("common.yes"),function(){a(o)}).addButton(Language._("common.no"),function(){}).show()}}catch(o){ErrorModule.report(o,Language._("errors.quests_inject_cancel_dialog"))}};return{}})();Debugger.Quests=Quests;const DuelMotivation=(function(e){let t={},n=null,a=null,o=null,r=null,i=0,c="",b=0,u="",g=!1;const l=function(h,k,L,D,v){try{h===void 0&&(h=""),k===void 0&&(k=!1),L===void 0&&(L=!1),D===void 0&&(D=!1),D?a.fadeTo(400,1,function(){l(h,k,L,!1),v&&v(),a.fadeTo(400,0)}):(typeof L=="string"&&n.attr("class",L),n.text(h),typeof k=="string"&&a.addMousePopup(k))}catch(C){ErrorModule.report(C,Language._("errors.duel_update_display"))}},f=function(){try{if(o===Character.duelProtection)return;o=Character.duelProtection,Character.getDuelProtection(!0)>new ServerDate().getTime()?_():i>0?r=666:d()}catch(h){ErrorModule.report(h,Language._("errors.duel_update_protection"))}},d=function(h){try{if(r===Character.duelMotivation||i>0)return;r=Character.duelMotivation;var k=Math.round(100*Character.duelMotivation);l(k+"%",`${Language._("duel.motivation")}: ${k}%`,h?"duelmot_dim":"")}catch(L){ErrorModule.report(L,Language._("errors.duel_update_motivation"))}},_=function(h){try{b&&w.clearInterval(b);var k=new ServerDate().getTime(),L=Character.getMandatoryDuelProtection(!0),D=Character.getDuelProtection(!0);c=`<div style='text-align:center;'>${Language._("duel.ko_time")}<br />`,g||k>=L||h?(i=parseInt((D-k)/1e3,10),u="getDuelProtection"):(c+=Language._("duel.ko_suspension",{time:new Date(L).toLocaleString()})+"<br />",i=parseInt((L-k)/1e3,10),u="getMandatoryDuelProtection"),i=Math.max(0,i),c+=Language._("duel.ko_protection",{time:new Date(D).toLocaleString()})+"<br />",l(i.formatDuration(),c,u==="getDuelProtection"?"duelmot_protect":"duelmot_ko",!0),a.addClass("koblink").click(function(){a.removeClass("koblink").stop(!0,!1).css({opacity:0})}),b=w.setInterval(function(){m()},1e3)}catch(v){ErrorModule.report(v,Language._("errors.duel_update_protection_timer"))}},m=function(){try{if(i>0)return i%180==0?i=parseInt((Character[u](!0)-new ServerDate().getTime())/1e3,10)||0:i--,i>0&&r!==666?(l(i.formatDuration()),1800>=i&&a.hasClass("koblink")&&i%8==0&&a.fadeTo(500,.5).fadeTo(500,0),void 0):(w.clearInterval(b),a.stop(!0,!0),i=0,u==="getDuelProtection"||r===666?(r=null,l("","","",!0,d)):_(!0));r=null,d()}catch(h){ErrorModule.report(h,Language._("errors.duel_update_motivation_bar"))}};return t=Loader.add("DuelMotivation","tw-db DuelMotivation",function(){if(!t.ready)try{if(!Settings.get("duel_motivation",!1))return t.ready=!0,void 0;Character.setDuelProtection.toString().search("duelprotection_changed")===-1?(Character.twdb_setDuelProtection=Character.setDuelProtection,Character.setDuelProtection=function(h,...k){h===0&&(h=1);var L=h!==Character.duelProtection;Character.twdb_setDuelProtection.call(this,h,...k),L&&EventHandler.signal("duelprotection_changed",[])}):TWDB.script.isDev()&&new UserMessage(Language._("duel.protection_changed")).show(),TWDB.Util.addCss(`div#ui_character_container .twdb_charcont_ext{background-image:${e("#ui_character_container").css("background-image")};background-repeat:no-repeat;background-position:bottom left;width:143px;height:15px;position:absolute;left:0;top:173px;padding-top:2px}div#ui_character_container #duelmot_bar{background-image:url(${TWDB.images.duelMotBar});background-repeat:no-repeat;background-position:0 -26px;top:2px;left:3px;height:13px;width:137px;position:absolute;color:#FFF;text-align:center;font-size:8pt;line-height:12px;font-weight:bold;text-shadow:1px 0 1px #000,-1px 0 1px #000}div#ui_character_container .duelmot_ko{background-position:0 -13px!important}div#ui_character_container .duelmot_protect{background-position:0 0!important}div#ui_character_container .duelmot_warn{background-position:0 0;top:2px;left:3px;opacity:0}div#ui_character_container .duelmot_dim{opacity:0.6}`,"duelmot"),g=Game.duelProtectionEarly===Game.duelProtectionHours,(function(){try{e("#ui_character_container").css({"background-repeat":"no-repeat",height:"191px"}),e(".energy_add").css({top:"161px"});var h=e('<div class="twdb_charcont_ext" />').insertBefore(".energy_bar");n=e('<div id="duelmot_bar" class="duelmot_dim" />').appendTo(h),a=e('<div class="status_bar duelmot_warn" />').appendTo(h)}catch(k){ErrorModule.report(k,Language._("errors.duel_create_ui"))}})(),EventHandler.listen("duelprotection_changed",function(){f()}),EventHandler.listen("duelmotivation_changed",function(){d()}),f(),d(!0),Character.homeTown.town_id!==0&&Ajax.remoteCallMode("building_saloon","get_data",{town_id:Character.homeTown.town_id},function(h){if(h.error)return new UserMessage(h.msg).show();Character.setDuelMotivation(h.motivation)}),t.ready=!0}catch(h){ErrorModule.report(h,Language._("errors.duel_initialize"))}},{Settings:!0}),{}})($);Debugger.DuelMotivation=DuelMotivation;const Bank=(function(e){let t=!0,n={};n=Loader.add("Bank","tw-db Bank",function(){if(!n.ready)try{Settings.get("auto_deposit",!1)&&(EventHandler.listen("position_change",function(){r()}),r()),Settings.get("deposit",!0)&&a(),n.ready=!0}catch(c){ErrorModule.report(c,Language._("errors.bank_initialize"))}},{Settings:!0});const a=function(){try{if(!Images.buttonBank)return waitForImages("buttonBank",a),void 0;GameInject.CharacterButton.add(Images.buttonBank).click(function(){o()}).addMousePopup(Language._("banking.deposit_money"))}catch(c){ErrorModule.report(c,Language._("errors.bank_add_button"))}},o=function(){try{new west.gui.Dialog(Language._("banking.deposit_money"),e(`<span class='twdb_banking'>${Language._("banking.money")}: ${w.Character.money}</span>`)).setIcon(west.gui.Dialog.SYS_QUESTION).setModal(!0,!1).addButton(Language._("common.yes"),function(){i(1)}).addButton(Language._("common.no")).show()}catch(c){ErrorModule.report(c,Language._("errors.bank_show_deposit_dialog"))}},r=function(){try{if(w.Character.homeTown.town_id===0||10>=w.Character.money)return t=!0,void 0;w.Character.position.x===w.Character.homeTown.x&&w.Character.position.y===w.Character.homeTown.y?t&&(t=!1,new west.gui.Dialog(Language._("banking.deposit_money"),e(`<span class='twdb_banking'>${Language._("banking.deposit_message")}<br />${Language._("banking.money")}: ${w.Character.money}</span>`)).setIcon(west.gui.Dialog.SYS_QUESTION).setModal(!0,!1).addButton(Language._("common.yes"),function(){t=!0,i(w.Character.homeTown.town_id)}).addButton(Language._("common.no")).show()):t=!0}catch(c){ErrorModule.report(c,Language._("errors.bank_auto_deposit"))}},i=function(c){try{if(0>=w.Character.money)return;w.BankWindow.townid=c,w.BankWindow.DOM=new west.gui.Textfield("tb_balance_input_"+w.BankWindow.townid).setSize(10).setValue(w.Character.money).getMainDiv(),w.BankWindow.Balance.add()}catch(b){ErrorModule.report(b,Language._("errors.bank_perform_deposit"))}};return{}})($);Debugger.Bank=Bank;const Market=(function(e){let t=!1,n={},a={};a=Loader.add("Market","tw-db Market",function(){if(!a.ready)try{Settings.get("market_map",!1)&&(GameInject.addTabOnMarketWindow(Language._("market.map_tab_title"),"marketmap",function(){b()}),TWDB.Util.addCss(".twdb_mmap_point{width:7px;height:7px;background-color:#F00;position:absolute;border:1px solid #000;border-radius:5px}")),Settings.get("market_reminder",!0)&&(GameInject.MarketOfferTable(function(_){o(_)}),GameInject.MarketWatchlistTable(function(_){r(_)}),c.init()),a.ready=!0}catch(_){ErrorModule.report(_,Language._("errors.market_initialize"))}},{Settings:!0});const o=function(_){try{for(var m=0;m<_.length;m++){var h=_[m],k=e('<div class="mpo_alert" />');e(MarketWindow.offerTable.getMainDiv()).children().find(".marketBidsData_"+h.market_offer_id).append(k),h.isFinished||k.append(i(h))}}catch(L){ErrorModule.report(L,Language._("errors.market_process_offer_list"))}},r=function(_){try{for(let k=0;k<_.length;k++){var m=_[k],h=e('<div class="mpo_alert" />');e(MarketWindow.watchlistTable.getMainDiv()).children().find(".marketWatchData_"+m.market_offer_id).append(h),m.isFinished||h.append(i(m))}}catch(k){ErrorModule.report(k,Language._("errors.market_process_watchlist"))}},i=function(_){try{var m=e(`<img src="${Images.iconAlarm}" />`).css({cursor:"pointer"});return m.click((h=_,k=m,function(){c.create(h,k)})),c.exists(_.market_offer_id)===!1&&m.css("opacity",.5),m}catch(L){return ErrorModule.report(L,Language._("errors.market_create_reminder_icon")),e()}var h,k},c=(function(_){const m={};let h={};m.init=function(){try{var v=Cache.load("marketreminder");isDefined(v)&&(h=v);for(const C in h)k(C)}catch(C){ErrorModule.report(C,Language._("errors.market_reminder_init"))}},m.exists=function(v){return isDefined(h[v])};const k=function(v){try{var C=h[v],A=Math.max(1e3*C.ends-Date.now()-6e4*C.reminder,100);C.timer=setTimeout((F=v,function(){D(F)}),A)}catch(N){ErrorModule.report(N,Language._("errors.market_schedule_reminder"))}var F},L=function(v){try{delete h[v],Cache.save("marketreminder",h)}catch(C){ErrorModule.report(C,Language._("errors.market_delete_reminder"))}},D=function(v){try{var C=h[v],A=ItemManager.get(C.item),F=new OnGoingEntry;F.init(),F.setTooltip(`${Language._("market.auction_label")}: ${A.name}${Language._("market.auction_ends")}: ${(+(C.ends-Date.now()/1e3)).getTimeString4Timestamp()}`),F.setImage(_(`<img src="${Images.notiBell}" />`)),WestUi.NotiBar.add(F),TitleTicker.setNotifyMessage(`${Language._("market.auction_label")}: ${A.name}${Language._("market.auction_ends")}: ${(+(C.ends-Date.now()/1e3)).getTimeString4Timestamp()}`),AudioController.play(AudioController.SOUND_NEWMSG),L(v)}catch(N){ErrorModule.report(N,Language._("errors.market_trigger_reminder"))}};return m.create=function(v,C){try{var A=_("<div />").append(`<span style="position:relative; width:100%;display:block;">${Language._("market.auction_ends_label")}: ${v.auction_ends_in.getTimeString4Timestamp()}</span>`),F=new west.gui.Textfield("twdb_analyzer_last").maxlength(4).onlyNumeric().setLabel(Language._("market.reminder_before_expiry")+": ").setPlaceholder(Language._("market.reminder_minutes"));A.append(F.getMainDiv()),m.exists(v.market_offer_id)?(F.setValue(h[v.market_offer_id].reminder),C.css("opacity",1)):C.css("opacity",.5);var N=new west.gui.Dialog(Language._("market.reminder_title"),A).setIcon(west.gui.Dialog.SYS_QUESTION).setModal(!0,!1,{bg:w.Game.cdnURL+"/images/curtain_bg.png",opacity:.4}).addButton(Language._("common.ok"),function(){C.css("opacity",1),(function(T,S,B){try{var p=parseInt(S.getValue(),10);if(Number.isNaN(p)||1>p)return m.create(T,B),void 0;if(Date.now()/1e3+60*p>=T.auction_end_date)return new UserMessage(Language._("market.reminder_late")).show(),m.create(T,B),void 0;m.exists(T.market_offer_id)&&(clearTimeout(h[T.market_offer_id].timer),delete h[T.market_offer_id].timer),h[T.market_offer_id]={ends:T.auction_end_date,reminder:p,id:T.market_offer_id,item:T.item_id},Cache.save("marketreminder",h),k(T.market_offer_id)}catch(j){ErrorModule.report(j,Language._("errors.market_save_reminder"))}})(v,F,C)});m.exists(v.market_offer_id)&&N.addButton(Language._("common.delete"),function(){L(v.market_offer_id),C.css("opacity",.5)}),N.addButton(Language._("common.cancel"),function(){}).show()}catch(T){ErrorModule.report(T,Language._("errors.market_create_reminder"))}},m})(e),b=function(){try{window.MarketWindow.window.showLoader(),window.MarketWindow.window.setTitle(Language._("market.map_tab_title")).setSize(840,655).addClass("premium-buy");var _=-111,m=-1,h=e('<div style="position:relative;display:block;margin:10px 9px 10px 9px;width:770px;height:338px;" />');for(let L=1;16>L;L++){L===8&&(m+=169,_=-111);var k=e(`<img style="position:absolute;border:1px solid #000;width:110px;height:169px;left:${_+=110}px;top:${m}px;" src="${Game.cdnURL}/images/map/minimap/county_${L}.jpg" />`);L===4?k.css({height:"114px"}):L===11?k.css({height:"114px",top:m+55+"px"}):L===15&&k.css({height:"108px",width:"109px",left:"329px",top:"114px"}),h.append(k)}t=e("<div />").append(h),e(MarketWindow.window.getContentPane()).find(".marketplace-marketmap").children().remove(),e(MarketWindow.window.getContentPane()).find(".marketplace-marketmap").append(t),n={},g(),window.MarketWindow.window.hideLoader()}catch(L){ErrorModule.report(L,Language._("errors.market_render_map"))}},u=function(_,m,h,k,L,D,v){try{isDefined(n[_])||(n[_]={name:m,town_id:_,x:h,y:k,count:0,offers_end:{},offers_unend:{},money:0,distance:window.GameMap.calcWayTime(window.Character.position,{x:h,y:k}).formatDuration()});var C=n[_];L!==""&&(isDefined(C.offers_end[L.item_id])?C.offers_end[L.item_id].count+=L.count:(C.count++,C.offers_end[L.item_id]=L)),D!==""&&(isDefined(C.offers_unend[D.item_id])?C.offers_unend[D.item_id].count+=D.count:(C.count++,C.offers_unend[D.item_id]=D)),v!==0&&(C.money+=v)}catch(A){ErrorModule.report(A,Language._("errors.market_process_offer_data"))}},g=function(){try{Ajax.remoteCall("building_market","fetch_bids",{},function(_){if(_.error)return new UserMessage(_.msg,UserMessage.TYPE_ERROR).show();const m=_.msg.search_result;for(let h=0;h<m.length;h++){let k,L;0>m[h].auction_ends_in||m[h].current_bid===m[h].max_price?(k={item_id:m[h].item_id,count:parseFloat(m[h].item_count)},L=""):(L={item_id:m[h].item_id,count:parseFloat(m[h].item_count)},k=""),u(m[h].market_town_id,m[h].market_town_name,m[h].market_town_x,m[h].market_town_y,k,L,0)}l()})}catch(_){ErrorModule.report(_,Language._("errors.market_fetch_bids"))}},l=function(){try{Ajax.remoteCall("building_market","fetch_offers",{page:0},function(_){if(_.error)return new UserMessage(_.msg,UserMessage.TYPE_ERROR).show();const m=_.msg.search_result;for(let h=0;h<m.length;h++){let k="";0>m[h].auction_ends_in&&!m[h].current_bid&&(k={item_id:m[h].item_id,count:parseFloat(m[h].item_count)}),u(m[h].market_town_id,m[h].market_town_name,m[h].market_town_x,m[h].market_town_y,k,"",m[h].current_bid)}f()})}catch(_){ErrorModule.report(_,Language._("errors.market_fetch_offers"))}},f=function(){try{for(const h in n){var _=n[h],m=`<div style="max-width: 305px;"><b>${_.name}</b>${_.money===0?"":` ${_.money}$`}<br/>`;let k,L=0;for(const v in _.offers_end){if(L++,L>19){m+=" ... ";break}k=_.offers_end[v],_.offers_end[v]!==0&&(m+=`<div class="item item_inventory"><img width="53" height="53" src="${ItemManager.get(v).image}" class="tw_item item_inventory_img dnd_draggable dnd_dragElem" style="margin-left:3px;margin-top:4px;"><span class="count" style="display: block;"><p>${k.count}</p></span></div>`)}for(const v in _.offers_unend){if(L++,L>19){m+=" ... ";break}k=_.offers_unend[v],_.offers_unend[v]!==0&&(m+=`<div style="opacity:0.35" class="item item_inventory"><img width="53" height="53" src="${ItemManager.get(v).image}" class="tw_item item_inventory_img dnd_draggable dnd_dragElem" style="margin-left:3px;margin-top:4px;"><span class="count" style="display: block;"><p>${k.count}</p></span></div>`)}m+="</div>";const D=e("<div />").css({left:_.x/(181*window.GameMap.tileSize)*770-5+"px",top:_.y/(79*window.GameMap.tileSize)*338-5+"px"}).attr({class:"twdb_mmap_point",id:h,title:m}).click((function(v){return function(){TownWindow.open(v.x,v.y)}})(_));t.append(D)}e(`<img src='${to_cdn("images/map/minimap/icons/miniicon_pos.png")}' />`).css({left:Character.position.x/(181*window.GameMap.tileSize)*770-8+"px",top:Character.position.y/(79*window.GameMap.tileSize)*338-8+"px",width:"16px",height:"16px"}).attr({class:"mmap_mappoint",id:"mmap_icon_pos",title:Language._("misc.your_position")}).appendTo(t),d()}catch(h){ErrorModule.report(h,Language._("errors.market_render_markers"))}},d=function(){try{const _=[];let m,h;for(m in n)_.push({id:m,distance:n[m].distance});_.sort(function(L,D){return L.distance===D.distance?0:L.distance>D.distance?1:-1}),h="";for(let L=0;L<_.length;L++){const D=n[_[L].id];h+=`<div><a onclick="TownWindow.open(${D.x}, ${D.y});">${D.name}</a> <a title="${Language._("map.show_town_tooltip")}" onclick="GameMap.center(${D.x}, ${D.y})"><img src="${Game.cdnURL}/images/icons/center.png" /></a> ${Language._("misc.distance")}: ${D.distance} <a title="${Language._("town.move_tooltip")}" onclick="TaskQueue.add(new TaskWalk(${D.town_id},'town'))"><img src="${Game.cdnURL}/images/map/icons/instantwork.png"></a>${D.money===0?"":` ${D.money}$`}<br />`;for(const v in D.offers_end){const C=D.offers_end[v];D.offers_end[v]!==0&&(h+=`<div class="item item_inventory" title="${new ItemPopup(ItemManager.get(v)).getXHTML().escapeHTML()}"><img width="53" height="53" src="${ItemManager.get(v).image}" class="tw_item item_inventory_img dnd_draggable dnd_dragElem" style="margin-left:3px;margin-top:4px;"><span class="count" style="display: block;"><p>${C.count}</p></span></div>`)}for(const v in D.offers_unend){const C=D.offers_unend[v];D.offers_unend[v]!==0&&(h+=`<div style="opacity:0.35" class="item item_inventory" title="${new ItemPopup(ItemManager.get(v)).getXHTML().escapeHTML()}"><img width="53" height="53" src="${ItemManager.get(v).image}" class="tw_item item_inventory_img dnd_draggable dnd_dragElem" style="margin-left:3px;margin-top:4px;"><span class="count" style="display: block;"><p>${C.count}</p></span></div>`)}h+="</div>";for(let v=0;v<=(D.count-D.count%12)/12;v++)h+=D.count===0?"<br/>":"<br/><br/><br/><br/>"}const k=new west.gui.Scrollpane;e(k.getMainDiv()).css({height:"200px","margin-left":"8px"}),k.appendContent(h),t.append(k.getMainDiv())}catch(_){ErrorModule.report(_,Language._("errors.market_create_town_list"))}window.MarketWindow.window.hideLoader()};return{}})($);Debugger.Market=Market;const Fort=(function($){const _self={};let loader={};const battleStats={},initializeFortModule=function(){if(!loader.ready)try{Settings.get("enhanced_fort_recruitment",!0)&&enhanceFortRecruitment(),Settings.get("declare_report",!0)&&declareShowFort(),Settings.get("owned_forts_tab",!1)&&ownedForts(),Settings.get("cemetery_critical",!1)&&setupCemeteryCritHits(),Settings.get("total_dmg_battle",!1)&&calculateTotalDamage(),Settings.get("battle_info_round",!1)&&battleInfoPerRound(),(Settings.get("total_dmg_battle",!0)||Settings.get("battle_info_round",!0))&&initBattleInfo(),loader.ready=!0}catch(e){ErrorModule.report(e,Language._("errors.fort_initialize"))}};loader=Loader.add("Fort","tw-db Fort",initializeFortModule,{Settings:!0});const enhanceFortRecruitment=function(){TWDB.Util.addCss(".fortbattle .trows .status{text-align:center}.fortbattle .trows .health_points{width:90px;text-align:center;margin-left:-8px}.fortbattle .tfoot .name,.fortbattle .tfoot .town,.fortbattle .tfoot .class{width:100px;position:relative;top:10px;margin-right:10px}.fortbattle .tfoot .name{text-align:left;width:75px;margin:0 -5px 0 5px}.fort_battle_recruitlist span.tw2gui_textfield{position:relative;top:10px}.fortbattle .trows .health_points p{font-size:13px!important}.cell_3.class{margin-left:-15px;margin-right:8px}.cell_4 .sort-class{margin-left:-8px}.cell_5 .sort-status{margin-left:-20px}.cell_6 .sort-health_points{text-align:center;width:90px;display:inline-block;margin-left:-12px}.fortbattle .trows .cell_3.class{text-align:right}");try{if(window.gradeValues={TRAITOR:"-2",RESERVIST:"-1",RECRUIT:"0",PRIVATE:"1",SERGEANT:"2",CAPTAIN:"3",MAJOR_GENERAL:"4",GENERAL:"5"},window.gradeNames={"-2":"traitor","-1":"reservist",0:"recruit",1:"private",2:"sergeant",3:"captain",4:"major_general",5:"general"},window.getGradeImg=function(e,t,n,a){try{return`<img class="${n||""}" src="${window.Game.cdnURL}/images/chat/servicegrade_${gradeNames[e]}.png" title="${t?window.Chat.rankTitles[gradeNames[e]].escapeHTML():""}${isDefined(a)&&a!==""?` (${a})`:""}" />`}catch(o){ErrorModule.report(o,Language._("errors.fort_get_grade_img"))}},!window.FortBattleWindow)return;[["updateRecruitlist",!0,[[/totalCnt\s{0,1}=\s{0,1}0;/,"totalCnt=0, totalCntTotal=0, gradeCountTotal={ '-2':0, '-1':0, '0':0, '1':0, '2':0, '3':0, '4':0, '5':0 };"],[/gradeCount\[g\]/,`'<span style="font-size:15px;"><span style="font-weight:700;text-align:center;width:45px;display:inline-block;margin-left:-10px;top:2px;position:relative;color:'+(gradeCount[g]===gradeCountTotal[g]?(gradeCount[g]>0?'forestgreen':'lightslategray'):'crimson')+';">'+gradeCount[g]+'</span></span>'`],[/\+\s{0,1}totalCnt\s{0,1}\+/,"+totalCnt+' ['+totalCntTotal+']'+"],[/if\(this\.preBattle\.isHidden\(list\[i\]\['class'\], ?'rank_' ?\+ ?priv\)\)/,"totalCntTotal++;gradeCountTotal[priv]++;if(this.preBattle.isHidden(list[i]['class'],'rank_'+priv,list[i].coords.x,list[i].coords.y))"],[/getGradeImg\(priv, ?true, ?'recruitplayer recruitplayer-'\+ ?i\)/,"getGradeImg(priv,true,'recruitplayer recruitplayer-'+i,list[i].officername||'')"],[/\.addColumns\(\s*\[\s*'count'\s*,\s*'name'\s*,\s*'town'\s*,\s*'rank'\s*,\s*'class'\s*,\s*'status'\s*,\s*'evaluated'\s*\]\s*\)/,".addColumns(['count','name','town','rank','class','status','health_points'])"],[/\.appendToThCell\(\s*'head'\s*,\s*'evaluated'\s*,[\s\S]*?\);/,`.appendToThCell('head','health_points','${Language._("fort.sort_by_health")}','<span class="sort sort-health_points">${Language._("misc.health_points")}</span>');`],[/evaluated\s*:\s*list\[i\]\.officername\s*\|\|\s*''/,`health_points:'<p style="font-weight:700;color:'+((this.preBattle.battleData.fortCoords.x-list[i].coords.x==0&&this.preBattle.battleData.fortCoords.y-list[i].coords.y==0)?'rgb(0,153,0)':((Math.abs(this.preBattle.battleData.fortCoords.x-list[i].coords.x)<=500&&Math.abs(this.preBattle.battleData.fortCoords.y-list[i].coords.y)<=500)?'rgb(255,119,0)':'rgb(255,0,0)'))+'">'+(list[i].currhealth===list[i].maxhealth?format_number(list[i].maxhealth):format_number(list[i].currhealth)+'&boxv;'+format_number(list[i].maxhealth))+'</p>'`]]],["recruitListClick",!1,[[/pp ?< ?ownPriv/,"pp<ownPriv&&ownPriv>gv.SERGEANT"],[/var hidden ?= ?function\(classKey, ?privKey\) ?{ ?return that\.preBattle\.isHidden\(classKey, ?'rank_'\+ ?privKey\); ?};/,"{var hidden=function(classKey,privKey,location){return that.preBattle.isHidden(classKey,'rank_'+privKey,null,null,location);};}"],[/return ?{message: ?sorting, ?title: ?title};/,`else if(key=='health_points'){title='${Language._("fort.sort_by_health")}';sorting.append(getSortLink('${Language._("fort.sort_asc_current_health")}','>currhealth'));sorting.append(getSortLink('${Language._("fort.sort_desc_current_health")}','<currhealth'));sorting.append(getSortLink('${Language._("fort.sort_asc_max_health")}','>maxhealth'));sorting.append(getSortLink('${Language._("fort.sort_desc_max_health")}','<maxhealth'));sorting.append('<br />');sorting.append(getSortLink('${Language._("fort.sort_asc_distance")}','>distance'));sorting.append(getSortLink('${Language._("fort.sort_desc_distance")}','<distance'));sorting.append(getVisLink(hidden(null,'-3','atfort')?'${Language._("fort.show_players_at_fort")}':'${Language._("fort.hide_players_at_fort")}','atfort'));sorting.append(getVisLink(hidden(null,'-3','nearbyfort')?'${Language._("fort.show_players_near_fort")}':'${Language._("fort.hide_players_near_fort")}','nearbyfort'));sorting.append(getVisLink(hidden(null,'-3','notatfort')?'${Language._("fort.show_players_away_fort")}':'${Language._("fort.hide_players_away_fort")}','notatfort'));}return{message:sorting,title:title};`]]]].forEach(([e,t,n])=>{const a=window.FortBattleWindow[e];if(!a||a.S)return;let o=a+"";n.forEach(([i,c])=>{o=o.replace(i,c)});const r=Function("return "+(t?`(function(){var lastStamp;return ${o}})();`:`(function(){return ${o}})();`))();window.FortBattleWindow[e]=function(...i){const c=r.apply(this,i);if(e==="updateRecruitlist")try{const b=this.infoareaEl?.[0],u=TWDB.Util.query(".cell_4 .sort-class",b),g=TWDB.Util.query(".cell_5 .sort-status",b);u&&(u.textContent=Language._("misc.category")),g&&(g.innerHTML=`<img src="${window.Game.cdnURL}/images/chat/servicegrade_general.png" alt="${Language._("misc.rank")}" style="pointer-events:none;">`)}catch{}return c},window.FortBattleWindow[e].S=!0,window.FortBattleWindow[e].__hp_original=a}),PreBattle.recruitSorting.currhealth=function(e,t,n){return n?e.currhealth===t.currhealth:e.currhealth<t.currhealth},PreBattle.recruitSorting.maxhealth=function(e,t,n){return n?e.maxhealth===t.maxhealth:e.maxhealth<t.maxhealth},PreBattle.recruitSorting.distance=function(e,t,n,a,o,r){},PreBattle.isHidden=function(e,t,n,a,o){let r="notatfort";if(o===null){const i=this.battleData.fortCoords.x-n,c=this.battleData.fortCoords.y-a;i===0&&c===0?r="atfort":Math.abs(i)>500||Math.abs(c)>500||(r="nearbyfort")}else o!==null&&(r=o);return e!==void 0&&this.recruitlistVisibility[e]||t!==void 0&&this.recruitlistVisibility[t]||r!==void 0&&this.recruitlistVisibility[r]}}catch(e){ErrorModule.report(e,Language._("errors.fort_enhance_recruitment"))}},declareShowFort=function(){try{ReportWindow.init_content_backup=ReportWindow.init_content,ReportWindow.init_content=function(e){var t,n;ReportWindow.init_content_backup.call(this,e),e.reportType==="fortbattle"&&e.reportInfo.subtype==="declare"&&(t=e.reportInfo.fortname,n=e.report_id,Ajax.remoteCall("fort_overview","search_fort",{fortNames:t},function(a){if(a&&!a.error)for(const r in a){var o=a[r];if(o&&o.name===t){$(`#rp_report-${n} .fort_muster a:first-child`).replaceWith(`<a href="javascript:void(FortWindow.open(${o.fort_id}, ${o.fort_x}, ${o.fort_y}));">${o.name}</a>`);break}}}))}}catch(e){ErrorModule.report(e,Language._("errors.fort_declare_show"))}},ownedForts=function(){try{const e={},t={forts:Language._("fort.forts"),forts_owned:Language._("fort.forts_owned"),forts_members:Language._("fort.forts_members"),fort_size:Language._("fort.size"),fort_sizes:Language._("fort.sizes")};$(document).on("click",".tow_profileheader img",function(){var o=$(this).closest(".tw2gui_window"),r=o.find(".imagemap_cityhall").attr("onclick");if(r){var i=/CityhallWindow\.open\((.*)?\); return false;/.exec(r);if(i){var c=parseInt(i[1],10),b=this===o.find('.tow_profileheader img[src*="fort_mini_icon"]').get(0)?"owned":"members";e[c]?a(c,b):Ajax.get("map","get_minimap",{},function(u){n(u),e[c]&&a(c,b)})}}}),document.styleSheets[0].insertRule(".twdb-forts-container .fortname {width:75%;}"),document.styleSheets[0].insertRule(".twdb-forts-container .fortsize {width:25%;text-align:center;}"),document.styleSheets[0].insertRule('.tow_profileheader img[src*="fort_mini_icon"] {cursor:pointer;}');const n=function(o){for(const u in o.forts)for(const g in o.forts[u]){var r=o.forts[u][g];if(r.fort){var i=r.fort.town_id,c=r.townIds||[],b={type:r.fort.type,id:r.fort.fort_id,x:r.fort.x,y:r.fort.y,name:r.fort.name};e[i]||(e[i]={owned:[],members:[]}),e[i].owned.push(b);for(let l=0;l<c.length;l++)e[c[l]]||(e[c[l]]={owned:[],members:[]}),e[c[l]].members.push(b)}}};Ajax.get("map","get_minimap",{},function(o){n(o)});const a=function(o,r){var i=$('<div class="twdb-forts-container" style="height:100%"></div>'),c=new west.gui.Table;c.addColumn("fortname").addColumn("fortsize").appendToCell("head","fortname",t.forts).appendToCell("head","fortsize",t.fort_size);var b=e[o][r];for(let g=0;g<b.length;g++)c.appendRow(),c.appendToCell(g,"fortname",`<div class="anti_wrap"><a onclick="GameMap.center(${b[g].x}, ${b[g].y})" href="#"><img class="fortOverviewIconScroll hasMousePopup" src="images/icons/center.png"></a> <a href="javascript:void(FortWindow.open(${b[g].id},${b[g].x},${b[g].y}));" class="hasMousePopup">${b[g].name}</a></div>`).appendToCell(g,"fortsize",t.fort_sizes[b[g].type]);i.html(c.getMainDiv());const u=r==="owned"?t.forts_owned:t.forts_members;wman.open("twdb-forts-container",null,"twdb-forts-container noreload nocloseall nominimize dontminimize").setTitle(u).setMiniTitle(u).appendToContentPane(i).setSize(340,360)}}catch(e){ErrorModule.report(e,Language._("errors.fort_owned_forts"))}},setupCemeteryCritHits=function(){try{document.styleSheets[0].insertRule(`.cemetery .fancytable .row_head .battle_cri span {background: url("${Images.iconCritical}");height:17px;width:16px;}`),document.styleSheets[0].insertRule(".cemetery .fancytable .battle_cri, .cemetery .fancytable .battle_gho {width:18px;}"),document.styleSheets[0].insertRule(`.cemetery .fancytable .row_head .battle_gho span {background: url("${Images.iconPhantom}");height:17px;width:16px;}`),document.styleSheets[0].insertRule(".cemetery #battle_stat.fancytable div.battle_tow {width:60px!important;}");var patchedInit=CemeteryWindow.showStatInit.toString().replace("$('div.cemetery-content',",`CemeteryWindow.table.addColumn('battle_cri',{sortBy:'crithits'}).addColumn('battle_gho',{sortBy:'playdeadcount'}).appendToThCell('head','battle_cri','${Language._("battle.critical_hits")}','&nbsp;').appendToThCell('head','battle_gho','${Language._("battle.ghost_rounds")}','&nbsp;');sortByObj.sortBy=null;$('div.cemetery-content',`),patchedUpdate=CemeteryWindow.showStatUpdateTable.toString().replace("CemeteryWindow.table.buildRow('battlestat tw_red'","tmpCells['battle_cri']=rd.charclass==1?rd.crithits:'-';tmpCells['battle_gho']=rd.charclass==0?rd.playdeadcount:'-';CemeteryWindow.table.buildRow('battlestat tw_red'").replace("CemeteryWindow.table.buildRow('battlestat tw_blue'","tmpCells['battle_cri']=rd.charclass==1?rd.crithits:'-';tmpCells['battle_gho']=rd.charclass==0?rd.playdeadcount:'-';CemeteryWindow.table.buildRow('battlestat tw_blue'"),sortHelpers="var sortByObj={sortBy:null,orderBy:'ASC'};var startSortDispatcher=function(ev){var sortBy='';sortBy=$(ev.target).closest('div.cell').data('sortBy');if(sortByObj.sortBy==sortBy){sortByObj.orderBy=sortByObj.orderBy=='asc'?'desc':'asc';CemeteryWindow.currentStats.reverse();}else{sortByObj.sortBy=sortBy;sortByObj.orderBy='asc';switch(sortBy){case'name':case'townname':CemeteryWindow.currentStats.sort(sortStrings(sortBy));break;case'ko_shots':CemeteryWindow.currentStats.sort(sortLength(sortBy));break;default:if($.isNumeric(CemeteryWindow.currentStats[0][sortBy])) CemeteryWindow.currentStats.sort(sortNumbers(sortBy));break;}}updatePlayerStatTable(CemeteryWindow.currentStats);};var sortLength=function(col) {return function(a,b) {return b[col].length-a[col].length;};};var sortNumbers=function(col) {return function(a,b) {return b[col]-a[col];};};var sortStrings=function(col) {return function(a,b) {return a[col].toUpperCase().replace(/[À-Ä]/g,'A').replace(/[Ò-Ö]/,'O').replace(/[Ù-Ü]/,'U').replace(/[È-Ë]/,'E')>b[col].toUpperCase().replace(/[À-Ä]/g,'A').replace(/[Ò-Ö]/,'O').replace(/[Ù-Ü]/,'U').replace(/[È-Ë]/,'E')?1:-1;};};var updatePlayerStatTable=function() {CemeteryWindow.table.clearBody();var tmpCells={};for(var i=0;i<CemeteryWindow.currentStats.length;i++) {var rd=CemeteryWindow.currentStats[i];tmpCells['battle_nam']=rd.name;tmpCells['battle_tow']=rd.townname;tmpCells['battle_shp']=rd.starthp;tmpCells['battle_ehp']=rd.finishedhp;tmpCells['battle_fla']=rd.flagholdcount;tmpCells['battle_hco']=rd.hitcount;tmpCells['battle_fco']=rd.misscount;tmpCells['battle_dco']=rd.totalcauseddamage;tmpCells['battle_ohi']=rd.takenhits;tmpCells['battle_ofa']=rd.dodgecount;tmpCells['battle_odm']=rd.takendamage;tmpCells['battle_avd']=rd.avg_damage;tmpCells['battle_okh']=rd.ko_shots.length;tmpCells['battle_onl']=rd.onlinecount;tmpCells['battle_cri']=rd.charclass==1?rd.crithits:'-';tmpCells['battle_gho']=rd.charclass==0?rd.playdeadcount:'-';CemeteryWindow.table.buildRow('battlestat '+(rd.battle_type=='defender'?'tw_blue':'tw_red'),tmpCells,addKoShotTitle(rd.ko_shots));}};var addKoShotTitle=function(koShots){return function(row){if(koShots.length){$('.battle_okh',row).attr('title',koShots.join(', '));} return row;}};";eval(`(function($){CemeteryWindow.showStatInit=${patchedInit};CemeteryWindow.showStatUpdateTable=${patchedUpdate};${sortHelpers}})(jQuery);`)}catch(e){ErrorModule.report(e,Language._("errors.fort_setup_cemetery_crit_hits"))}},calculateTotalDamage=function(){if(typeof FortBattle<"u")try{FortBattle.flashShowCharacterInfo_backup||typeof FortBattle.flashShowCharacterInfo!="function"||(FortBattle.flashShowCharacterInfo_backup=FortBattle.flashShowCharacterInfo,FortBattle.flashShowCharacterInfo=function(...e){FortBattle.flashShowCharacterInfo_backup.apply(FortBattle,e),$("div.recruitlist_name",`#fort_battle_${e[0]}_infoarea`).html(`<span onclick="PlayerProfileWindow.open(${e[1]});" style="cursor:pointer;">${$("div.recruitlist_name").text()}</span>`)}),FortBattle.getCharDataSheet_backup||typeof FortBattle.getCharDataSheet!="function"||(FortBattle.getCharDataSheet_backup=FortBattle.getCharDataSheet,FortBattle.getCharDataSheet=function(e){return`${FortBattle.getCharDataSheet_backup(e)}<div><img src="${Images.iconTotalDMG}" title="${Language._("battle.total_damage_tooltip")}" /> %totalDmg%</div>`})}catch(e){ErrorModule.report(e,Language._("errors.fort_calculate_total_damage"))}},battleInfoPerRound=function(){try{FortBattle.addRoundStatusMessage_backup=FortBattle.addRoundStatusMessage,FortBattle.addRoundStatusMessage=function(e,t){FortBattle.addRoundStatusMessage_backup(e,t),battleStats[e]||(battleStats[e]={hit:0,missed:0,gotshot:0,dodge:0});const n=battleStats[e];for(let a=0;a<t.length;a++){const o=t[a];switch(o.action){case"gotshot":o.damage===0?n.dodge++:n.gotshot++;break;case"shot":o.damage===0?n.missed++:n.hit++}}t.length!==0&&FortBattle.showMessage(e,`<strong>${Language._("battle.stats_total")} | ${Language._("battle.stats_hits")}: </strong>"${n.hit}"<strong> | ${Language._("battle.stats_missed")}: </strong>"${n.missed}"<strong> | ${Language._("battle.stats_got_shot")}: </strong>"${n.gotshot}"<strong> | ${Language._("battle.stats_dodge")}: </strong>"${n.dodge}`)}}catch(e){ErrorModule.report(e,Language._("errors.fort_battle_info_per_round"))}},initBattleInfo=function(){try{FortBattle.addFinishMessage_backup=FortBattle.addFinishMessage,FortBattle.addFinishMessage=function(e,t){FortBattle.addFinishMessage_backup(e,t),battleStats[e]={hit:0,missed:0,gotshot:0,dodge:0}}}catch(e){ErrorModule.report(e,Language._("errors.fort_init_battle_info"))}};return _self})($);Debugger.Fort=Fort;const CCstarter=(function(e){let t={};return t=Loader.add("ClothCalc","tw-db ClothCalc",function(){if(!t.ready)try{ClothCalc.ready=t.ready,ClothCalc.init(),t.ready=!0}catch(n){ErrorModule.report(n,Language._("errors.ccstarter_initialize"))}},{}),{}})();Debugger.CCstarter=CCstarter,w.location.href.indexOf(".the-west.")===-1&&w.location.href.indexOf(".tw.innogames.")===-1||w.location.href.indexOf("game.php")===-1||Loader.init()})(jQuery)}});
